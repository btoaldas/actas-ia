<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ PRUEBA BOT√ìN PROCESAR ACTA - FUNCIONANDO</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #28a745; text-align: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn-success { background: #28a745; color: white; }
        .btn:disabled { background: #6c757d; cursor: not-allowed; }
        #resultado { margin-top: 20px; padding: 15px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #cce7ff; color: #004085; border: 1px solid #87ceeb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ PRUEBA BOT√ìN PROCESAR ACTA</h1>
        <p><strong>Estado:</strong> Bot√≥n JavaScript corregido y funcional</p>
        
        <!-- Formulario CSRF oculto -->
        <form style="display: none;">
            <input type="hidden" name="csrfmiddlewaretoken" value="">
        </form>
        
        <!-- Bot√≥n de procesar -->
        <div style="text-align: center; margin: 30px 0;">
            <button class="btn btn-success procesar-btn" data-acta-id="14">
                <i class="fas fa-play"></i> üöÄ PROCESAR ACTA 14
            </button>
        </div>
        
        <div id="resultado"></div>
    </div>

    <script>
    $(document).ready(function() {
        console.log('‚úÖ Iniciando test del bot√≥n...');
        
        // Obtener CSRF token real del servidor
        $.get('http://localhost:8000/generador-actas/actas/14/')
        .done(function(data) {
            const csrfMatch = data.match(/name="csrfmiddlewaretoken" value="([^"]+)"/);
            if (csrfMatch) {
                const csrfToken = csrfMatch[1];
                $('[name=csrfmiddlewaretoken]').val(csrfToken);
                $('#resultado').html('<div class="success">‚úÖ CSRF Token obtenido correctamente: ' + csrfToken.substring(0, 20) + '...</div>');
                console.log('‚úÖ CSRF Token:', csrfToken);
            } else {
                $('#resultado').html('<div class="error">‚ùå No se pudo obtener CSRF Token</div>');
            }
        })
        .fail(function() {
            $('#resultado').html('<div class="error">‚ùå Error conectando al servidor</div>');
        });
        
        // Evento del bot√≥n procesar (MISMO C√ìDIGO QUE EN EL TEMPLATE)
        $('.procesar-btn').off('click').on('click', function(e) {
            e.preventDefault();
            console.log('üöÄ BOT√ìN PROCESAR CLICKEADO');
            
            const actaId = $(this).data('acta-id');
            const btn = $(this);
            const csrfToken = $('[name=csrfmiddlewaretoken]').val();
            
            console.log('üìã Acta ID:', actaId);
            console.log('üîë CSRF Token disponible:', !!csrfToken);
            
            if (!actaId || !csrfToken) {
                $('#resultado').html('<div class="error">‚ùå Error: Datos necesarios no encontrados (ID: ' + actaId + ', CSRF: ' + !!csrfToken + ')</div>');
                return;
            }
            
            // Confirmaci√≥n con SweetAlert
            Swal.fire({
                title: '¬øProcesar Acta?',
                text: 'Se iniciar√° el procesamiento autom√°tico con IA',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'S√≠, procesar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    procesarActa(actaId, csrfToken, btn);
                }
            });
        });
        
        // Funci√≥n para procesar acta (MISMA QUE EN EL TEMPLATE)
        function procesarActa(actaId, csrfToken, btn) {
            console.log('üîÑ Iniciando procesamiento...');
            $('#resultado').html('<div class="info">üîÑ Enviando petici√≥n de procesamiento...</div>');
            
            // Cambiar estado del bot√≥n
            btn.prop('disabled', true);
            btn.html('‚è≥ Procesando...');
            
            // Hacer petici√≥n AJAX
            $.ajax({
                url: 'http://localhost:8000/generador-actas/actas/' + actaId + '/procesar/',
                type: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({}),
                xhrFields: {
                    withCredentials: true
                },
                success: function(response) {
                    console.log('‚úÖ Respuesta del servidor:', response);
                    
                    if (response.success) {
                        $('#resultado').html('<div class="success">‚úÖ ¬°√âXITO! ' + response.message + '<br><strong>Task ID:</strong> ' + (response.task_id || 'N/A') + '</div>');
                        btn.html('‚úÖ ¬°Procesado!');
                        
                        setTimeout(() => {
                            window.open('http://localhost:8000/generador-actas/actas/' + actaId + '/', '_blank');
                        }, 2000);
                    } else {
                        console.log('‚ùå Error:', response.message);
                        $('#resultado').html('<div class="error">‚ùå Error: ' + response.message + '</div>');
                        restaurarBoton(btn);
                    }
                },
                error: function(xhr, status, error) {
                    console.log('‚ùå Error AJAX:', xhr.status, xhr.responseText);
                    
                    let mensaje = 'Error de comunicaci√≥n con el servidor';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        mensaje = xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        mensaje = xhr.responseText;
                    }
                    
                    $('#resultado').html('<div class="error">‚ùå Error: ' + mensaje + '</div>');
                    restaurarBoton(btn);
                }
            });
        }
        
        // Funci√≥n para restaurar bot√≥n
        function restaurarBoton(btn) {
            btn.prop('disabled', false);
            btn.html('üöÄ PROCESAR ACTA 14');
        }
    });
    </script>
</body>
</html>