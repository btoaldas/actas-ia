{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ page_title }} | Generador de Actas{% endblock %}

{% block stylesheets %}
{{ block.super }}
<style>
.transcripcion-info {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.form-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.plantilla-card {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.plantilla-card:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.plantilla-card.selected {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.proveedor-card {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.proveedor-card:hover {
    border-color: #28a745;
    background-color: #f8f9fa;
}

.proveedor-card.selected {
    border-color: #28a745;
    background-color: #e8f5e8;
}

.metadata-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.metadata-item {
    background: rgba(255,255,255,0.1);
    padding: 10px;
    border-radius: 5px;
}

.validation-info {
    background: #d1ecf1;
    border: 1px solid #bee5eb;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 20px;
}

.preview-content {
    max-height: 200px;
    overflow-y: auto;
    background: rgba(255,255,255,0.1);
    padding: 10px;
    border-radius: 5px;
    font-family: monospace;
    font-size: 0.85rem;
    line-height: 1.4;
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">{{ page_title }}</h1>
                </div>
                <div class="col-sm-6">
                    {% if breadcrumb %}
                    <ol class="breadcrumb float-sm-right">
                        {% for item in breadcrumb %}
                            {% if item.active %}
                                <li class="breadcrumb-item active">{{ item.name }}</li>
                            {% else %}
                                <li class="breadcrumb-item"><a href="{{ item.url }}">{{ item.name }}</a></li>
                            {% endif %}
                        {% endfor %}
                    </ol>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            
            <!-- Información de la Transcripción -->
            <div class="transcripcion-info">
                <div class="row">
                    <div class="col-md-8">
                        <h3 class="mb-3">
                            <i class="fas fa-microphone"></i>
                            {{ transcripcion.procesamiento_audio.nombre_archivo|default:"Audio sin nombre" }}
                        </h3>
                        
                        <div class="metadata-grid">
                            <div class="metadata-item">
                                <strong>Tipo de Reunión:</strong><br>
                                {% if transcripcion.procesamiento_audio.tipo_reunion %}
                                    {{ transcripcion.procesamiento_audio.tipo_reunion.nombre }}
                                {% else %}
                                    No especificado
                                {% endif %}
                            </div>
                            <div class="metadata-item">
                                <strong>Duración:</strong><br>
                                {% if transcripcion.procesamiento_audio.duracion_segundos %}
                                    {{ transcripcion.procesamiento_audio.duracion_segundos }} segundos
                                {% else %}
                                    No especificada
                                {% endif %}
                            </div>
                            <div class="metadata-item">
                                <strong>Ubicación:</strong><br>
                                {{ transcripcion.procesamiento_audio.ubicacion|default:"No especificada" }}
                            </div>
                            <div class="metadata-item">
                                <strong>Procesado:</strong><br>
                                {{ transcripcion.fecha_creacion|date:"d/m/Y H:i" }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6>Vista Previa de Transcripción:</h6>
                        <div class="preview-content">
                            {% if transcripcion.conversacion_json.conversacion %}
                                {% for segmento in transcripcion.conversacion_json.conversacion|slice:":3" %}
                                    <strong>{{ segmento.hablante }}:</strong> {{ segmento.texto|truncatechars:100 }}<br><br>
                                {% endfor %}
                                {% if transcripcion.conversacion_json.conversacion|length > 3 %}
                                    <small>... y {{ transcripcion.conversacion_json.conversacion|length|add:"-3" }} segmentos más</small>
                                {% endif %}
                            {% else %}
                                Sin datos de conversación
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Validación -->
            <div class="validation-info">
                <h6><i class="fas fa-check-circle text-success"></i> Transcripción Validada</h6>
                <p class="mb-0">
                    Esta transcripción cumple con los requisitos para generar un acta: 
                    contiene datos de conversación válidos y duración suficiente.
                </p>
            </div>

            <!-- Formulario -->
            <form method="post" id="crear-acta-form">
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-lg-6">
                        
                        <!-- Selección de Plantilla -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-template"></i>
                                    Seleccionar Plantilla
                                </h3>
                            </div>
                            <div class="card-body">
                                {% if plantillas %}
                                    {% for plantilla in plantillas %}
                                    <div class="plantilla-card" data-plantilla-id="{{ plantilla.id }}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">{{ plantilla.nombre }}</h6>
                                                <p class="mb-1 text-muted">{{ plantilla.descripcion|truncatechars:100 }}</p>
                                                <small class="text-muted">
                                                    <i class="fas fa-tag"></i> {{ plantilla.get_tipo_acta_display }}
                                                    | <i class="fas fa-puzzle-piece"></i> 
                                                    {{ plantilla.configuracionsegmento_set.count }} segmentos
                                                </small>
                                            </div>
                                            <div class="text-right">
                                                <input type="radio" name="plantilla" value="{{ plantilla.id }}" 
                                                       class="form-check-input plantilla-radio" 
                                                       style="display: none;">
                                                <i class="fas fa-check-circle text-success" style="display: none;"></i>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="alert alert-warning">
                                        <strong>No hay plantillas disponibles</strong><br>
                                        Contacte al administrador para configurar plantillas de actas.
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                    </div>
                    
                    <div class="col-lg-6">
                        
                        <!-- Selección de Proveedor IA -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-brain"></i>
                                    Seleccionar Proveedor IA
                                </h3>
                            </div>
                            <div class="card-body">
                                {% if proveedores %}
                                    {% for proveedor in proveedores %}
                                    <div class="proveedor-card" data-proveedor-id="{{ proveedor.id }}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">{{ proveedor.nombre }}</h6>
                                                <p class="mb-1 text-muted">
                                                    {{ proveedor.get_tipo_proveedor_display }}
                                                </p>
                                                <small class="text-muted">
                                                    <i class="fas fa-circle text-success"></i> Activo
                                                </small>
                                            </div>
                                            <div class="text-right">
                                                <input type="radio" name="proveedor_ia" value="{{ proveedor.id }}" 
                                                       class="form-check-input proveedor-radio" 
                                                       style="display: none;">
                                                <i class="fas fa-check-circle text-success" style="display: none;"></i>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="alert alert-warning">
                                        <strong>No hay proveedores IA disponibles</strong><br>
                                        Contacte al administrador para configurar proveedores IA.
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Configuración Adicional -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-cog"></i>
                            Configuración del Acta
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="titulo">Título del Acta</label>
                                    <input type="text" class="form-control" id="titulo" name="titulo" 
                                           placeholder="Se generará automáticamente si se deja vacío">
                                    <small class="form-text text-muted">
                                        Opcional. Si no se especifica, se generará automáticamente.
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="fecha_sesion">Fecha de la Sesión</label>
                                    <input type="date" class="form-control" id="fecha_sesion" name="fecha_sesion">
                                    <small class="form-text text-muted">
                                        Opcional. Se usará la fecha de procesamiento si no se especifica.
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="proveedor_ia">Proveedor IA <span class="text-danger">*</span></label>
                            <select class="form-control" id="proveedor_ia" name="proveedor_ia" required>
                                <option value="">-- Seleccionar Proveedor IA --</option>
                                {% for proveedor in proveedores_activos %}
                                    <option value="{{ proveedor.id }}">{{ proveedor.nombre }} ({{ proveedor.get_tipo_display }})</option>
                                {% empty %}
                                    <option value="" disabled>No hay proveedores IA activos</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">
                                Proveedor de IA que generará el contenido del acta.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="card">
                    <div class="card-body text-center">
                        <button type="submit" class="btn btn-primary btn-lg" id="crear-btn" disabled>
                            <i class="fas fa-magic"></i>
                            Crear Acta
                        </button>
                        <a href="{% url 'generador_actas:dashboard' %}" class="btn btn-secondary btn-lg ml-3">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </a>
                    </div>
                </div>

            </form>

        </div>
    </section>
</div>
{% endblock %}

{% block javascripts %}
{{ block.super }}
<script>
$(document).ready(function() {
    // Validar formulario
    function validarFormulario() {
        const plantillaSeleccionada = $('input[name="plantilla"]:checked').length > 0;
        const proveedorSeleccionado = $('input[name="proveedor_ia"]:checked').length > 0;
        
        const esValido = plantillaSeleccionada && proveedorSeleccionado;
        $('#crear-btn').prop('disabled', !esValido);
        
        return esValido;
    }
    
    // Selección de plantilla
    $('.plantilla-card').click(function() {
        const plantillaId = $(this).data('plantilla-id');
        
        // Deseleccionar todas
        $('.plantilla-card').removeClass('selected');
        $('.plantilla-card .fa-check-circle').hide();
        $('.plantilla-radio').prop('checked', false);
        
        // Seleccionar actual
        $(this).addClass('selected');
        $(this).find('.fa-check-circle').show();
        $(this).find('.plantilla-radio').prop('checked', true);
        
        validarFormulario();
    });
    
    // Selección de proveedor
    $('.proveedor-card').click(function() {
        const proveedorId = $(this).data('proveedor-id');
        
        // Deseleccionar todas
        $('.proveedor-card').removeClass('selected');
        $('.proveedor-card .fa-check-circle').hide();
        $('.proveedor-radio').prop('checked', false);
        
        // Seleccionar actual
        $(this).addClass('selected');
        $(this).find('.fa-check-circle').show();
        $(this).find('.proveedor-radio').prop('checked', true);
        
        validarFormulario();
    });
    
    // Envío del formulario
    $('#crear-acta-form').on('submit', function(e) {
        if (!validarFormulario()) {
            e.preventDefault();
            alert('Por favor seleccione una plantilla y un proveedor IA');
            return false;
        }
        
        // Deshabilitar botón para evitar múltiples envíos
        $('#crear-btn').prop('disabled', true);
        $('#crear-btn').html('<i class="fas fa-spinner fa-spin"></i> Creando Acta...');
    });
    
    // Validación inicial
    validarFormulario();
});
</script>
{% endblock %}