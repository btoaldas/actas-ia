{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ page_title }} | Generador de Actas{% endblock %}

{% block stylesheets %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'plugins/sweetalert2/sweetalert2.min.css' %}">
<style>
.acta-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.status-card {
    border-left: 4px solid;
    background: #f8f9fa;
}

.status-borrador { border-left-color: #6c757d; }
.status-en_cola { border-left-color: #17a2b8; }
.status-procesando { border-left-color: #ffc107; }
.status-procesando_segmentos { border-left-color: #fd7e14; }
.status-unificando { border-left-color: #6f42c1; }
.status-revision { border-left-color: #20c997; }
.status-aprobado { border-left-color: #28a745; }
.status-publicado { border-left-color: #007bff; }
.status-error { border-left-color: #dc3545; }

.segmento-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 15px;
    transition: box-shadow 0.3s ease;
}

.segmento-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.contenido-preview {
    max-height: 300px;
    overflow-y: auto;
    background: #f8f9fa;
    border-radius: 4px;
    padding: 15px;
    font-family: monospace;
    white-space: pre-wrap;
    line-height: 1.6;
}

.metadata-item {
    border-bottom: 1px solid #dee2e6;
    padding: 8px 0;
}

.metadata-item:last-child {
    border-bottom: none;
}

.progress-realtime {
    height: 25px;
    font-size: 0.9rem;
}

.timeline {
    position: relative;
}

.timeline-item {
    margin-bottom: 20px;
    position: relative;
    padding-left: 40px;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    width: 2px;
    height: 100%;
    background: #dee2e6;
}

.timeline-icon {
    position: absolute;
    left: 0;
    top: 0;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    background: white;
    border: 2px solid #dee2e6;
}

.action-buttons {
    position: sticky;
    top: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">{{ page_title }}</h1>
                </div>
                <div class="col-sm-6">
                    {% if breadcrumb %}
                    <ol class="breadcrumb float-sm-right">
                        {% for item in breadcrumb %}
                            {% if item.active %}
                                <li class="breadcrumb-item active">{{ item.name }}</li>
                            {% else %}
                                <li class="breadcrumb-item"><a href="{{ item.url }}">{{ item.name }}</a></li>
                            {% endif %}
                        {% endfor %}
                    </ol>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            
            <!-- CSRF Token Form (Hidden) -->
            <form style="display: none;">
                {% csrf_token %}
            </form>
            
            <!-- Header del Acta -->
            <div class="acta-header">
                <div class="row">
                    <div class="col-md-8">
                        <h2 class="mb-2">{{ acta.numero_acta }}</h2>
                        <p class="mb-1">{{ acta.titulo }}</p>
                        <small>
                            <i class="fas fa-user"></i>
                            Creado por {{ acta.usuario_creacion.get_full_name|default:acta.usuario_creacion.username }}
                            el {{ acta.fecha_creacion|date:"d/m/Y H:i" }}
                        </small>
                    </div>
                    <div class="col-md-4 text-right">
                        <span class="badge badge-light badge-lg">
                            {{ acta.get_estado_display }}
                        </span>
                        {% if acta.fecha_sesion %}
                        <div class="mt-2">
                            <small>
                                <i class="fas fa-calendar"></i>
                                Sesi√≥n: {{ acta.fecha_sesion|date:"d/m/Y" }}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Informaci√≥n Principal -->
                <div class="col-lg-8">
                    
                    <!-- Estado del Procesamiento -->
                    <div class="card status-card status-{{ acta.estado }}">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-info-circle"></i>
                                Estado del Procesamiento
                            </h3>
                            {% if acta.estado in 'en_cola,procesando,procesando_segmentos,unificando' %}
                            <div class="card-tools">
                                <button class="btn btn-tool refresh-status" data-acta-id="{{ acta.pk }}">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="metadata-item">
                                        <strong>Estado:</strong> {{ acta.get_estado_display }}
                                    </div>
                                    <div class="metadata-item">
                                        <strong>Progreso:</strong> {{ acta.progreso|default:0 }}%
                                    </div>
                                    {% if acta.fecha_procesamiento %}
                                    <div class="metadata-item">
                                        <strong>Iniciado:</strong> {{ acta.fecha_procesamiento|date:"d/m/Y H:i" }}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <div class="metadata-item">
                                        <strong>Plantilla:</strong> {{ acta.plantilla.nombre }}
                                    </div>
                                    <div class="metadata-item">
                                        <strong>Proveedor IA:</strong> {{ acta.proveedor_ia.nombre }}
                                    </div>
                                    {% if acta.task_id_celery %}
                                    <div class="metadata-item">
                                        <strong>Tarea:</strong> 
                                        <code>{{ acta.task_id_celery|truncatechars:16 }}</code>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if acta.progreso > 0 %}
                            <div class="progress progress-realtime mt-3">
                                <div class="progress-bar progress-bar-striped
                                    {% if acta.estado == 'error' %}bg-danger
                                    {% elif acta.progreso == 100 %}bg-success
                                    {% else %}bg-primary progress-bar-animated{% endif %}"
                                     role="progressbar"
                                     aria-valuenow="{{ acta.progreso }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    {{ acta.progreso }}%
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if acta.mensajes_error %}
                            <div class="alert alert-danger mt-3">
                                <strong>Error:</strong> {{ acta.mensajes_error }}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Segmentos Procesados -->
                    {% if segmentos_info %}
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-puzzle-piece"></i>
                                Segmentos Procesados ({{ segmentos_info|length }})
                            </h3>
                        </div>
                        <div class="card-body">
                            {% for segmento in segmentos_info %}
                            <div class="segmento-card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            {{ segmento.orden }}. {{ segmento.nombre }}
                                        </h6>
                                        <div>
                                            <span class="badge 
                                                {% if segmento.tipo == 'dinamico' %}badge-primary
                                                {% else %}badge-secondary{% endif %}">
                                                {{ segmento.tipo|capfirst }}
                                            </span>
                                            {% if segmento.categoria %}
                                            <span class="badge badge-light">{{ segmento.categoria|capfirst }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    {% if segmento.error %}
                                    <div class="alert alert-danger">
                                        <strong>Error:</strong> {{ segmento.error }}
                                    </div>
                                    {% endif %}
                                    
                                    <div class="contenido-preview">{{ segmento.contenido|default:"Sin contenido" }}</div>
                                    
                                    {% if segmento.prompt_usado %}
                                    <div class="mt-3">
                                        <button class="btn btn-sm btn-outline-info" type="button" 
                                                data-toggle="collapse" 
                                                data-target="#prompt-{{ segmento.segmento_id }}">
                                            <i class="fas fa-code"></i>
                                            Ver Prompt Usado
                                        </button>
                                        <div class="collapse mt-2" id="prompt-{{ segmento.segmento_id }}">
                                            <div class="card bg-light">
                                                <div class="card-body">
                                                    <small class="text-muted">{{ segmento.prompt_usado }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i>
                                            {{ segmento.timestamp|date:"d/m/Y H:i:s" }}
                                            {% if segmento.proveedor %}
                                            | <i class="fas fa-brain"></i> {{ segmento.proveedor }}
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Contenido Final/Borrador -->
                    {% if acta.contenido_final or acta.contenido_borrador %}
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-file-alt"></i>
                                {% if acta.contenido_final %}
                                    Contenido Final
                                {% else %}
                                    Contenido Borrador
                                {% endif %}
                            </h3>
                            <div class="card-tools">
                                <button class="btn btn-tool" data-card-widget="maximize">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="contenido-preview">{{ acta.contenido_final|default:acta.contenido_borrador }}</div>

                            {% if prompt_final_info %}
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-info" type="button"
                                        data-toggle="collapse"
                                        data-target="#prompt-final-global"
                                        aria-expanded="false"
                                        aria-controls="prompt-final-global">
                                    <i class="fas fa-code"></i>
                                    Ver Prompt Global Usado
                                </button>
                                <div class="collapse mt-2" id="prompt-final-global">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <div class="d-flex flex-column flex-lg-row justify-content-between mb-3">
                                                <div>
                                                    <p class="mb-1"><strong>Modelo:</strong> {{ prompt_final_info.modelo_usado|default:"No disponible" }}</p>
                                                    <p class="mb-1"><strong>Tokens usados:</strong> {{ prompt_final_info.tokens_usados|default:"-" }}</p>
                                                    <p class="mb-1"><strong>Tiempo de respuesta:</strong> {{ prompt_final_info.tiempo_respuesta|default:"-" }}</p>
                                                    <small class="text-muted"><i class="far fa-clock"></i> {{ prompt_final_info.timestamp|default:"-" }}</small>
                                                </div>
                                                <div class="mt-3 mt-lg-0">
                                                    <button class="btn btn-outline-secondary btn-sm" type="button"
                                                            data-toggle="collapse"
                                                            data-target="#prompt-final-original"
                                                            aria-expanded="false"
                                                            aria-controls="prompt-final-original">
                                                        Prompt Original
                                                    </button>
                                                    <button class="btn btn-outline-primary btn-sm ml-lg-2 mt-2 mt-lg-0" type="button"
                                                            data-toggle="collapse"
                                                            data-target="#prompt-final-renderizado"
                                                            aria-expanded="false"
                                                            aria-controls="prompt-final-renderizado">
                                                        Prompt Ejecutado
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="collapse" id="prompt-final-original">
                                                <div class="bg-white border rounded p-3 mb-3">
                                                    <h6 class="text-muted">Prompt Original</h6>
                                                    <pre class="mb-0 text-sm">{{ prompt_final_info.prompt_original }}</pre>
                                                </div>
                                            </div>
                                            <div class="collapse" id="prompt-final-renderizado">
                                                <div class="bg-white border rounded p-3">
                                                    <h6 class="text-muted">Prompt Ejecutado</h6>
                                                    <pre class="mb-0 text-sm">{{ prompt_final_info.prompt_renderizado }}</pre>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Informaci√≥n de la Transcripci√≥n -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-microphone"></i>
                                Informaci√≥n de la Transcripci√≥n
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="metadata-item">
                                        <strong>Archivo:</strong> 
                                        {{ acta.transcripcion.procesamiento_audio.nombre_archivo|default:"Sin nombre" }}
                                    </div>
                                    <div class="metadata-item">
                                        <strong>Duraci√≥n:</strong> 
                                        {% if acta.transcripcion.procesamiento_audio.duracion_segundos %}
                                            {{ acta.transcripcion.procesamiento_audio.duracion_segundos }} segundos
                                        {% else %}
                                            No especificada
                                        {% endif %}
                                    </div>
                                    <div class="metadata-item">
                                        <strong>Tipo:</strong> 
                                        {% if acta.transcripcion.procesamiento_audio.tipo_reunion %}
                                            {{ acta.transcripcion.procesamiento_audio.tipo_reunion.nombre }}
                                        {% else %}
                                            No especificado
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="metadata-item">
                                        <strong>Ubicaci√≥n:</strong> 
                                        {{ acta.transcripcion.procesamiento_audio.ubicacion|default:"No especificada" }}
                                    </div>
                                    <div class="metadata-item">
                                        <strong>Procesado:</strong> 
                                        {{ acta.transcripcion.fecha_creacion|date:"d/m/Y H:i" }}
                                    </div>
                                    <div class="metadata-item">
                                        <strong>Segmentos:</strong> 
                                        {% if acta.transcripcion.conversacion_json.conversacion %}
                                            {{ acta.transcripcion.conversacion_json.conversacion|length }}
                                        {% else %}
                                            0
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Panel Lateral -->
                <div class="col-lg-4">
                    
                    <!-- Acciones -->
                    <div class="card action-buttons">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-cogs"></i>
                                Acciones
                            </h3>
                        </div>
                        <div class="card-body">
                            {% if puede_procesar %}
                            <button id="btnProcesarActaPrincipal" class="btn btn-success btn-block procesar-btn" data-acta-id="{{ acta.pk }}">
                                <i class="fas fa-play"></i>
                                Procesar Acta
                            </button>
                            <div id="debug-procesar-acta" style="margin-top:10px; font-size:12px; color:#555;">
                                <strong>Debug JS:</strong>
                                <ul id="debug-list" style="padding-left:18px; margin:4px 0;"></ul>
                            </div>
                            <script>
                                (function(){
                                    function logDbg(msg){
                                        try {
                                            console.log('[ACTA_DEBUG]', msg);
                                            var ul = document.getElementById('debug-list');
                                            if(ul){ var li = document.createElement('li'); li.textContent = msg; ul.appendChild(li);}    
                                        } catch(e) { console.warn('Debug log error', e); }
                                    }
                                    logDbg('Inline debugger cargado');
                                    var btn = document.getElementById('btnProcesarActaPrincipal');
                                    if(!btn){ logDbg('Bot√≥n no encontrado en DOM inmediato'); return; }
                                    logDbg('Bot√≥n encontrado. data-acta-id=' + btn.getAttribute('data-acta-id'));
                                    // Remover listeners previos simples
                                    btn.onclick = null;
                                    btn.addEventListener('click', function(ev){
                                        ev.preventDefault(); ev.stopPropagation();
                                        logDbg('CLICK capturado inline');
                                        var actaId = btn.getAttribute('data-acta-id');
                                        var csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
                                        var csrfToken = csrfInput ? csrfInput.value : null;
                                        logDbg('CSRF token: ' + (csrfToken ? csrfToken.substring(0,12)+'...' : 'NO'));
                                        if(!csrfToken){ alert('No se encontr√≥ CSRF token. Recarga la p√°gina.'); return; }
                                        if(!actaId){ alert('No se encontr√≥ ID de acta.'); return; }
                                        if(window._procesandoActa){ logDbg('Ya en proceso, ignorando segundo click'); return; }
                                        window._procesandoActa = true;
                                        btn.disabled = true;
                                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                                        logDbg('Enviando POST fetch...');
                                        fetch('/generador-actas/actas/' + actaId + '/procesar/', {
                                            method: 'POST',
                                            headers: {
                                                'X-CSRFToken': csrfToken,
                                                'Content-Type': 'application/json'
                                            },
                                            credentials: 'same-origin',
                                            body: JSON.stringify({})
                                        }).then(r => {
                                            logDbg('Respuesta HTTP status=' + r.status);
                                            return r.json().catch(()=>({success:false, message:'Respuesta no JSON'}));
                                        }).then(data => {
                                            logDbg('JSON recibido: ' + JSON.stringify(data));
                                            if(data.success){
                                                logDbg('√âxito: ' + (data.message || 'Procesamiento iniciado'));
                                                btn.innerHTML = '<i class="fas fa-check"></i> Iniciado';
                                                setTimeout(()=>window.location.reload(), 2500);
                                            } else {
                                                logDbg('Fallo l√≥gico: ' + (data.message || 'Sin mensaje'));
                                                alert('Error: ' + (data.message || 'No se pudo iniciar procesamiento'));
                                                btn.disabled = false;
                                                btn.innerHTML = '<i class="fas fa-play"></i> Procesar Acta';
                                                window._procesandoActa = false;
                                            }
                                        }).catch(err => {
                                            logDbg('Error fetch: ' + err.message);
                                            alert('Error de red o servidor: ' + err.message);
                                            btn.disabled = false;
                                            btn.innerHTML = '<i class="fas fa-play"></i> Procesar Acta';
                                            window._procesandoActa = false;
                                        });
                                    });
                                    logDbg('Listener inline registrado');
                                })();
                            </script>
                            {% endif %}
                            
                            {% if puede_exportar %}
                            <div class="btn-group btn-block mb-2">
                                <button type="button" class="btn btn-info dropdown-toggle" 
                                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="fas fa-download"></i>
                                    Exportar
                                </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="{% url 'generador_actas:exportar_acta' acta.pk %}?formato=txt">
                                        <i class="fas fa-file-alt"></i> Texto (.txt)
                                    </a>
                                    <a class="dropdown-item" href="{% url 'generador_actas:exportar_acta' acta.pk %}?formato=pdf">
                                        <i class="fas fa-file-pdf"></i> PDF (.pdf)
                                    </a>
                                    <a class="dropdown-item" href="{% url 'generador_actas:exportar_acta' acta.pk %}?formato=docx">
                                        <i class="fas fa-file-word"></i> Word (.docx)
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                            
                            <a href="{% url 'generador_actas:actas_lista' %}" class="btn btn-secondary btn-block">
                                <i class="fas fa-arrow-left"></i>
                                Volver al Listado
                            </a>
                        </div>
                    </div>

                    <!-- M√©tricas -->
                    {% if acta.metricas_procesamiento %}
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-line"></i>
                                M√©tricas de Procesamiento
                            </h3>
                        </div>
                        <div class="card-body">
                            {% for key, value in acta.metricas_procesamiento.items %}
                            <div class="metadata-item">
                                <strong>{{ key|capfirst }}:</strong> 
                                {% if 'tiempo' in key %}
                                    {{ value|floatformat:2 }}s
                                {% else %}
                                    {{ value }}
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Historial -->
                    {% if acta.historial_cambios %}
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-history"></i>
                                Historial
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="timeline">
                                {% for evento in acta.historial_cambios %}
                                <div class="timeline-item">
                                    <div class="timeline-icon bg-primary">
                                        <i class="fas fa-circle"></i>
                                    </div>
                                    <div>
                                        <strong>{{ evento.descripcion|default:evento.evento|capfirst }}</strong>
                                        {% if evento.progreso %}
                                        <div class="progress mt-2" style="height: 5px;">
                                            <div class="progress-bar" style="width: {{ evento.progreso }}%"></div>
                                        </div>
                                        <small class="text-muted">Progreso: {{ evento.progreso }}%</small>
                                        {% endif %}
                                        <br>
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i>
                                            {{ evento.timestamp|date:"d/m/Y H:i:s" }}
                                        </small>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="text-muted">
                                    <i class="fas fa-info-circle"></i> Sin eventos registrados
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                </div>
            </div>

        </div>
    </section>
</div>
{% endblock %}

{% block javascripts %}
{{ block.super }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'plugins/sweetalert2/sweetalert2.min.js' %}"></script>

<script>
// ========== SISTEMA ROBUSTO DE PROCESAMIENTO DE ACTAS - DIRECTO EN TEMPLATE ==========
$(document).ready(function() {
    console.log('üöÄ INICIANDO SISTEMA DE PROCESAMIENTO DE ACTAS');
    console.log('üìÖ Fecha:', new Date().toLocaleString());
    console.log('üåê URL actual:', window.location.href);
    
    // Verificar dependencias
    if (typeof jQuery === 'undefined') {
        console.error('‚ùå jQuery no est√° cargado');
        alert('ERROR: jQuery no est√° cargado');
        return;
    } else {
        console.log('‚úÖ jQuery versi√≥n:', $.fn.jquery);
    }
    
    if (typeof Swal === 'undefined') {
        console.error('‚ùå SweetAlert2 no est√° cargado');
        alert('ERROR: SweetAlert2 no est√° cargado');
        return;
    } else {
        console.log('‚úÖ SweetAlert2 disponible');
    }
    
    // ========== BUSCAR Y CONFIGURAR BOTONES ==========
    setTimeout(function() {
        console.log('üîç Buscando botones .procesar-btn...');
        const botones = $('.procesar-btn');
        console.log('üìä Botones encontrados:', botones.length);
        
        if (botones.length === 0) {
            console.warn('‚ö†Ô∏è NO SE ENCONTRARON BOTONES CON CLASE .procesar-btn');
            console.log('üîç Buscando todos los botones en la p√°gina...');
            $('button').each(function(index) {
                console.log(`Bot√≥n ${index + 1}:`, {
                    texto: $(this).text().trim(),
                    clases: this.className,
                    id: this.id
                });
            });
            return;
        }
        
        // Configurar cada bot√≥n encontrado
        botones.each(function(index) {
            const btn = $(this);
            const actaId = btn.data('acta-id');
            
            console.log(`üéØ Configurando bot√≥n ${index + 1}:`, {
                texto: btn.text().trim(),
                actaId: actaId,
                clases: this.className,
                deshabilitado: this.disabled,
                elemento: this
            });
            
            // REMOVER TODOS los eventos anteriores
            btn.off('click');
            
            // AGREGAR evento click con debugging
            btn.on('click', function(e) {
                console.log('üöÄ ¬°¬°¬°CLICK DETECTADO EN BOT√ìN!!!');
                console.log('üéØ Evento:', e);
                console.log('üéØ Elemento clickeado:', this);
                console.log('üéØ Acta ID:', actaId);
                
                e.preventDefault();
                e.stopPropagation();
                
                if (!actaId) {
                    console.error('‚ùå ERROR: No hay Acta ID');
                    alert('ERROR: No se encontr√≥ el ID del acta');
                    return false;
                }
                
                console.log('‚úÖ Iniciando confirmaci√≥n para Acta ID:', actaId);
                mostrarConfirmacion(actaId, btn);
                return false;
            });
            
            console.log('‚úÖ Bot√≥n configurado correctamente');
        });
        
        console.log('üéØ TODOS LOS BOTONES CONFIGURADOS');
    }, 500); // Esperar 500ms para que cargue todo
    
    // ========== FUNCI√ìN DE CONFIRMACI√ìN ==========
    function mostrarConfirmacion(actaId, btn) {
        console.log('‚ùì Mostrando confirmaci√≥n para Acta:', actaId);
        
        // Buscar token CSRF
        const csrfToken = $('[name=csrfmiddlewaretoken]').val();
        console.log('üîë CSRF Token:', csrfToken ? 'ENCONTRADO (' + csrfToken.substring(0, 10) + '...)' : 'NO ENCONTRADO');
        
        if (!csrfToken) {
            console.error('‚ùå NO HAY CSRF TOKEN');
            alert('ERROR: No se encontr√≥ el token de seguridad. Recarga la p√°gina.');
            return;
        }
        
        console.log('üé® Mostrando di√°logo SweetAlert...');
        
        Swal.fire({
            title: 'ü§ñ ¬øProcesar con IA?',
            html: `
                <div style="text-align: center;">
                    <p><strong>Acta ID:</strong> ${actaId}</p>
                    <p>Se iniciar√° el procesamiento autom√°tico usando Inteligencia Artificial.</p>
                    <p>Este proceso puede tomar varios minutos.</p>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '‚úÖ S√≠, procesar',
            cancelButtonText: '‚ùå Cancelar',
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#dc3545',
            allowOutsideClick: false,
            width: 500
        }).then((result) => {
            console.log('üë§ Respuesta del usuario:', result);
            
            if (result.isConfirmed) {
                console.log('‚úÖ Usuario confirm√≥ - INICIANDO PROCESAMIENTO');
                ejecutarProcesamiento(actaId, csrfToken, btn);
            } else {
                console.log('‚ùå Usuario cancel√≥ el procesamiento');
            }
        }).catch((error) => {
            console.error('‚ùå Error en SweetAlert:', error);
            alert('Error mostrando di√°logo: ' + error.message);
        });
    }
    
    // ========== FUNCI√ìN DE PROCESAMIENTO ==========
    function ejecutarProcesamiento(actaId, csrfToken, btn) {
        console.log('üîÑ EJECUTANDO PROCESAMIENTO REAL');
        console.log('üìã Par√°metros:', {
            actaId: actaId,
            csrfToken: csrfToken.substring(0, 10) + '...',
            botonTexto: btn.text().trim()
        });
        
        // Cambiar estado del bot√≥n INMEDIATAMENTE
        const textoOriginal = btn.html();
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin"></i> Procesando con IA...');
        console.log('üîÑ Bot√≥n modificado - disabled=true, texto cambiado');
        
        // Preparar URL y datos
        const url = `/generador-actas/actas/${actaId}/procesar/`;
        console.log('üì° URL de procesamiento:', url);
        
        // Ejecutar petici√≥n AJAX con configuraci√≥n completa
        console.log('üì§ Enviando petici√≥n AJAX...');
        
        $.ajax({
            url: url,
            type: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            data: JSON.stringify({}),
            dataType: 'json',
            timeout: 120000, // 2 minutos
            cache: false,
            
            beforeSend: function(xhr) {
                console.log('üì§ Petici√≥n enviada, esperando respuesta...');
            },
            
            success: function(response, textStatus, xhr) {
                console.log('‚úÖ RESPUESTA EXITOSA RECIBIDA');
                console.log('‚úÖ Status:', textStatus);
                console.log('‚úÖ XHR Status:', xhr.status);
                console.log('‚úÖ Response completa:', response);
                
                if (response && response.success) {
                    console.log('üéâ SUCCESS = TRUE - Procesamiento iniciado');
                    
                    const mensaje = response.message || 'Procesamiento iniciado exitosamente';
                    const taskId = response.task_id || 'N/A';
                    
                    Swal.fire({
                        title: 'üéâ ¬°Procesamiento Iniciado!',
                        html: `
                            <div style="text-align: center;">
                                <p><strong>${mensaje}</strong></p>
                                <hr>
                                <p><small><strong>Task ID:</strong> ${taskId}</small></p>
                                <p><small>La p√°gina se recargar√° en 5 segundos...</small></p>
                            </div>
                        `,
                        icon: 'success',
                        timer: 5000,
                        timerProgressBar: true,
                        allowOutsideClick: false,
                        showConfirmButton: false
                    }).then(() => {
                        console.log('üîÑ Recargando p√°gina...');
                        window.location.reload();
                    });
                    
                } else {
                    console.error('‚ùå SUCCESS = FALSE');
                    console.error('‚ùå Response:', response);
                    const mensaje = response.message || 'Error desconocido del servidor';
                    mostrarError('Error en el procesamiento', mensaje);
                    restaurarBoton(btn, textoOriginal);
                }
            },
            
            error: function(xhr, textStatus, errorThrown) {
                console.error('‚ùå ERROR EN PETICI√ìN AJAX');
                console.error('‚ùå XHR Status:', xhr.status);
                console.error('‚ùå XHR StatusText:', xhr.statusText);
                console.error('‚ùå TextStatus:', textStatus);
                console.error('‚ùå Error:', errorThrown);
                console.error('‚ùå Response Text:', xhr.responseText);
                
                let titulo = 'Error de Comunicaci√≥n';
                let mensaje = `Error al comunicarse con el servidor (Status: ${xhr.status})`;
                
                if (xhr.status === 403) {
                    titulo = 'Acceso Denegado';
                    mensaje = 'No tienes permisos para realizar esta acci√≥n.';
                } else if (xhr.status === 404) {
                    titulo = 'Recurso No Encontrado';
                    mensaje = 'El acta o endpoint no fue encontrado.';
                } else if (xhr.status === 500) {
                    titulo = 'Error del Servidor';
                    mensaje = 'Error interno del servidor.';
                } else if (xhr.responseText) {
                    mensaje += '\n\nDetalle: ' + xhr.responseText.substring(0, 200);
                }
                
                mostrarError(titulo, mensaje);
                restaurarBoton(btn, textoOriginal);
            },
            
            complete: function() {
                console.log('üèÅ Petici√≥n AJAX completada');
            }
        });
    }
    
    // ========== FUNCI√ìN PARA MOSTRAR ERRORES ==========
    function mostrarError(titulo, mensaje) {
        console.error('üö® MOSTRANDO ERROR:', {titulo, mensaje});
        
        Swal.fire({
            title: titulo,
            html: `<div style="text-align: left; max-height: 200px; overflow-y: auto;">
                     <strong>Detalle:</strong><br>${mensaje}
                   </div>`,
            icon: 'error',
            width: 600,
            confirmButtonText: 'Entendido',
            confirmButtonColor: '#dc3545'
        });
    }
    
    // ========== FUNCI√ìN PARA RESTAURAR BOT√ìN ==========
    function restaurarBoton(btn, textoOriginal) {
        console.log('üîÑ Restaurando bot√≥n...');
        btn.prop('disabled', false);
        btn.html(textoOriginal);
        console.log('‚úÖ Bot√≥n restaurado');
    }
    
    // ========== FUNCIONES AUXILIARES ADICIONALES ==========
    
    // REFRESCAR ESTADO
    $('.refresh-status').off('click').on('click', function() {
        const actaId = $(this).data('acta-id');
        const btn = $(this);
        
        btn.find('i').addClass('fa-spin');
        
        $.ajax({
            url: '/generador-actas/actas/' + actaId + '/estado/',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    Swal.fire('Error', 'No se pudo actualizar el estado', 'error');
                }
            },
            error: function() {
                Swal.fire('Error', 'Error comunic√°ndose con el servidor', 'error');
            },
            complete: function() {
                btn.find('i').removeClass('fa-spin');
            }
        });
    });
    
    // AUTO-REFRESH SI EST√Å PROCESANDO
    {% if acta.estado in 'en_cola,procesando,procesando_segmentos,unificando' %}
    console.log('üîÑ Auto-refresh activado para acta en procesamiento');
    setInterval(function() {
        $.ajax({
            url: '/generador-actas/actas/{{ acta.pk }}/estado/',
            method: 'GET',
            success: function(response) {
                if (response.success && response.data.estado !== '{{ acta.estado }}') {
                    console.log('üîÑ Estado cambi√≥, recargando p√°gina...');
                    location.reload();
                }
            }
        });
    }, 10000);
    {% endif %}
    
    console.log('‚úÖ Funciones auxiliares del template cargadas');
    console.log('üéØ SISTEMA COMPLETAMENTE LISTO');
});
</script>
{% endblock %}
