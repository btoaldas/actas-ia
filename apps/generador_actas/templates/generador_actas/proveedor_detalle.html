{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Detalle del Proveedor{{ proveedor.nombre }}{% endblock title %}

{% block content %}
<div class="content-wrapper">
<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>🔍 Detalle del Proveedor</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="{% url 'generador_actas:dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'generador_actas:proveedores_lista' %}">Proveedores</a></li>
                    <li class="breadcrumb-item active">{{ proveedor.nombre }}</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8">
                <!-- Información Básica -->
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">📋 Información Básica</h3>
                        <div class="card-tools">
                            {% if proveedor.activo %}
                                <span class="badge badge-success">Activo</span>
                            {% else %}
                                <span class="badge badge-danger">Inactivo</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-4">Nombre:</dt>
                            <dd class="col-sm-8">{{ proveedor.nombre }}</dd>
                            
                            <dt class="col-sm-4">Tipo:</dt>
                            <dd class="col-sm-8">
                                <span class="badge badge-info">{{ proveedor.get_tipo_display }}</span>
                            </dd>
                            
                            <dt class="col-sm-4">Modelo:</dt>
                            <dd class="col-sm-8"><code>{{ proveedor.modelo }}</code></dd>
                            
                            <dt class="col-sm-4">Estado:</dt>
                            <dd class="col-sm-8">
                                {% if proveedor.activo %}
                                    <span class="badge badge-success"><i class="fas fa-check"></i> Activo</span>
                                {% else %}
                                    <span class="badge badge-danger"><i class="fas fa-times"></i> Inactivo</span>
                                {% endif %}
                            </dd>
                            
                            <dt class="col-sm-4">Clave API:</dt>
                            <dd class="col-sm-8">
                                <div class="input-group">
                                    <input type="password" class="form-control" value="{{ proveedor.api_key_masked }}" readonly>
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKey()">
                                            <i class="fas fa-eye" id="eyeIcon"></i>
                                        </button>
                                    </div>
                                </div>
                            </dd>
                            
                            <dt class="col-sm-4">Fecha de Creación:</dt>
                            <dd class="col-sm-8">{{ proveedor.fecha_creacion|date:"d/m/Y H:i" }}</dd>
                            
                            <dt class="col-sm-4">Última Actualización:</dt>
                            <dd class="col-sm-8">{{ proveedor.fecha_actualizacion|date:"d/m/Y H:i" }}</dd>
                        </dl>
                    </div>
                </div>

                <!-- Parámetros de Configuración -->
                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title">⚙️ Parámetros de Configuración</h3>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-4">Temperatura:</dt>
                            <dd class="col-sm-8">
                                <div class="progress">
                                    <div class="progress-bar bg-info" role="progressbar" 
                                         style="width: {{ proveedor.temperatura|floatformat:1|add:'0'|mul:'100' }}%" 
                                         aria-valuenow="{{ proveedor.temperatura }}" aria-valuemin="0" aria-valuemax="1">
                                        {{ proveedor.temperatura }}
                                    </div>
                                </div>
                            </dd>
                            
                            <dt class="col-sm-4">Máximo de Tokens:</dt>
                            <dd class="col-sm-8">
                                <span class="badge badge-secondary">{{ proveedor.max_tokens|default:"No especificado" }}</span>
                            </dd>
                        </dl>
                        
                        {% if proveedor.configuracion_adicional %}
                        <div class="mt-3">
                            <strong>Configuración Adicional:</strong>
                            <pre class="bg-light p-2 rounded"><code>{{ proveedor.configuracion_adicional|default:"{}" }}</code></pre>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Historial de Uso -->
                <div class="card card-secondary">
                    <div class="card-header">
                        <h3 class="card-title">📊 Estadísticas de Uso</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 text-center">
                                <div class="bg-primary p-3 rounded">
                                    <h4 class="text-white">{{ stats.total_actas|default:0 }}</h4>
                                    <p class="text-white mb-0">Actas Generadas</p>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="bg-success p-3 rounded">
                                    <h4 class="text-white">{{ stats.actas_exitosas|default:0 }}</h4>
                                    <p class="text-white mb-0">Exitosas</p>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="bg-warning p-3 rounded">
                                    <h4 class="text-white">{{ stats.actas_fallidas|default:0 }}</h4>
                                    <p class="text-white mb-0">Fallidas</p>
                                </div>
                            </div>
                        </div>
                        
                        {% if stats.ultima_utilizacion %}
                        <div class="mt-3">
                            <small class="text-muted">
                                Última utilización: {{ stats.ultima_utilizacion|date:"d/m/Y H:i" }}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <!-- Acciones -->
                <div class="card card-warning">
                    <div class="card-header">
                        <h3 class="card-title">🔧 Acciones</h3>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{% url 'generador_actas:proveedor_editar' proveedor.pk %}" 
                               class="btn btn-primary btn-block">
                                <i class="fas fa-edit"></i> Editar Proveedor
                            </a>
                            
                            <button type="button" class="btn btn-info btn-block" onclick="probarConexion()">
                                <i class="fas fa-flask"></i> Probar Conexión
                            </button>
                            
                            {% if proveedor.activo %}
                                <button type="button" class="btn btn-warning btn-block" onclick="toggleEstado('desactivar')">
                                    <i class="fas fa-pause"></i> Desactivar
                                </button>
                            {% else %}
                                <button type="button" class="btn btn-success btn-block" onclick="toggleEstado('activar')">
                                    <i class="fas fa-play"></i> Activar
                                </button>
                            {% endif %}
                            
                            <div class="dropdown-divider"></div>
                            
                            <button type="button" class="btn btn-danger btn-block" onclick="confirmarEliminacion()">
                                <i class="fas fa-trash"></i> Eliminar Proveedor
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Información de Contacto/Documentación -->
                <div class="card card-light">
                    <div class="card-header">
                        <h3 class="card-title">📚 Documentación</h3>
                    </div>
                    <div class="card-body">
                        {% if proveedor.tipo == 'openai' %}
                            <p><strong>OpenAI:</strong></p>
                            <ul class="list-unstyled">
                                <li><a href="https://platform.openai.com/docs" target="_blank">📖 Documentación API</a></li>
                                <li><a href="https://platform.openai.com/account/api-keys" target="_blank">🔑 Gestión de Claves</a></li>
                            </ul>
                        {% elif proveedor.tipo == 'deepseek' %}
                            <p><strong>DeepSeek:</strong></p>
                            <ul class="list-unstyled">
                                <li><a href="https://platform.deepseek.com/api-docs" target="_blank">📖 Documentación API</a></li>
                                <li><a href="https://platform.deepseek.com/api_keys" target="_blank">🔑 Gestión de Claves</a></li>
                            </ul>
                        {% elif proveedor.tipo == 'anthropic' %}
                            <p><strong>Anthropic (Claude):</strong></p>
                            <ul class="list-unstyled">
                                <li><a href="https://docs.anthropic.com/" target="_blank">📖 Documentación API</a></li>
                                <li><a href="https://console.anthropic.com/" target="_blank">🔑 Console</a></li>
                            </ul>
                        {% elif proveedor.tipo == 'google' %}
                            <p><strong>Google Gemini:</strong></p>
                            <ul class="list-unstyled">
                                <li><a href="https://ai.google.dev/" target="_blank">📖 Documentación API</a></li>
                                <li><a href="https://makersuite.google.com/app/apikey" target="_blank">🔑 API Keys</a></li>
                            </ul>
                        {% elif proveedor.tipo == 'ollama' %}
                            <p><strong>Ollama:</strong></p>
                            <ul class="list-unstyled">
                                <li><a href="https://ollama.ai/docs" target="_blank">📖 Documentación</a></li>
                                <li><a href="https://ollama.ai/library" target="_blank">📦 Modelos Disponibles</a></li>
                            </ul>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal para confirmación de eliminación -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h5 class="modal-title text-white">⚠️ Confirmar Eliminación</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de que desea eliminar el proveedor <strong>{{ proveedor.nombre }}</strong>?</p>
                <p class="text-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Esta acción no se puede deshacer y afectará a todas las actas que dependan de este proveedor.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <form method="post" action="{% url 'generador_actas:proveedor_eliminar' proveedor.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>
</div>
<script>
function toggleApiKey() {
    const input = document.querySelector('input[type="password"], input[type="text"]');
    const icon = document.getElementById('eyeIcon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function probarConexion() {
    // Mostrar indicador de carga
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Probando...';
    btn.disabled = true;
    
    // Hacer petición AJAX para probar la conexión
    fetch(`{% url 'generador_actas:proveedor_test' proveedor.pk %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            toastr.success('Conexión exitosa con el proveedor');
        } else {
            toastr.error('Error en la conexión: ' + data.error);
        }
    })
    .catch(error => {
        toastr.error('Error al probar la conexión');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function toggleEstado(accion) {
    const url = accion === 'activar' ? 
        `{% url 'generador_actas:proveedor_activar' proveedor.pk %}` : 
        `{% url 'generador_actas:proveedor_desactivar' proveedor.pk %}`;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            toastr.error('Error al cambiar el estado del proveedor');
        }
    });
}

function confirmarEliminacion() {
    $('#deleteModal').modal('show');
}
</script>

{% endblock content %}