{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ titulo_pagina }}{% endblock %}

{% block extrastyle %}
<!-- CSS específico para el detalle de transcripción -->
<style>
.chat-message {
    cursor: pointer;
    transition: background-color 0.2s;
}
.chat-message:hover {
    background-color: #f8f9fa;
}
.chat-message.playing {
    background-color: #e3f2fd;
    border-left: 4px solid #1976d2;
}
.speaker-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
}
.timestamp-indicator {
    font-size: 0.8em;
    color: #6c757d;
}
.json-editor {
    max-height: 400px;
    overflow-y: auto;
}
.json-viewer {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.5;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 400px;
    overflow-y: auto;
}
.json-viewer .json-key {
    color: #0d6efd;
    font-weight: bold;
}
.json-viewer .json-string {
    color: #198754;
}
.json-viewer .json-number {
    color: #fd7e14;
}
.json-viewer .json-boolean {
    color: #6610f2;
}
.json-viewer .json-null {
    color: #6c757d;
    font-style: italic;
}
.editable-segment {
    border: 1px dashed transparent;
    padding: 2px 4px;
    border-radius: 3px;
}
.editable-segment:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">{{ titulo_pagina }}</h1>
                    <p class="text-muted">{{ subtitulo }}</p>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'transcripcion:transcripciones_dashboard' %}">Transcripciones</a></li>
                        <li class="breadcrumb-item active">Detalle</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <!-- CSRF Token para AJAX -->
            {% csrf_token %}
            
            <!-- Primera fila: Información del Audio y Estadísticas -->
            <div class="row">
                <div class="col-md-8">
                    <!-- Información del Audio -->
                    <div class="card card-outline card-primary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-file-audio"></i> Información del Audio
                            </h3>
                            <div class="card-tools">
                                {% if transcripcion.estado == 'completado' %}
                                    <span class="badge badge-success">{{ transcripcion.estado|title }}</span>
                                {% elif transcripcion.estado == 'error' %}
                                    <span class="badge badge-danger">{{ transcripcion.estado|title }}</span>
                                {% else %}
                                    <span class="badge badge-warning">{{ transcripcion.estado|title }}</span>
                                {% endif %}
                                {% if transcripcion.estado == 'en_proceso' or transcripcion.estado == 'transcribiendo' or transcripcion.estado == 'diarizando' or transcripcion.estado == 'procesando' %}
                                    <button type="button" class="btn btn-sm btn-outline-secondary ml-2" title="No disponible mientras está en proceso" disabled>
                                        <i class="fas fa-undo"></i> Revertir
                                    </button>
                                {% else %}
                                <form method="post" action="{% url 'transcripcion:revertir_audios_por_transcribir' transcripcion.id %}" class="d-inline" onsubmit="return confirm('¿Seguro que deseas revertir esta transcripción? El audio volverá a estar disponible para transcribir y se eliminará esta transcripción.');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger ml-2" title="Revertir a 'Audios por Transcribir'">
                                        <i class="fas fa-undo"></i> Revertir
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h4>{{ transcripcion.procesamiento_audio.titulo }}</h4>
                                    {% if transcripcion.procesamiento_audio.descripcion %}
                                        <p class="text-muted">{{ transcripcion.procesamiento_audio.descripcion }}</p>
                                    {% endif %}
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Tipo:</strong> {{ transcripcion.procesamiento_audio.tipo_reunion.nombre }}</p>
                                            <p><strong>Usuario:</strong> {{ transcripcion.procesamiento_audio.usuario.get_full_name|default:transcripcion.procesamiento_audio.usuario.username }}</p>
                                            <p><strong>Fecha Audio:</strong> {{ transcripcion.procesamiento_audio.created_at|date:"d/m/Y H:i" }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Fecha Transcripción:</strong> {{ transcripcion.fecha_creacion|date:"d/m/Y H:i" }}</p>
                                            {% if transcripcion.duracion_total %}
                                                <p><strong>Duración:</strong> {{ transcripcion.duracion_total|floatformat:1 }}s</p>
                                            {% elif transcripcion.procesamiento_audio.duracion_segundos %}
                                                <p><strong>Duración:</strong> {{ transcripcion.procesamiento_audio.duracion_segundos|floatformat:1 }}s</p>
                                            {% endif %}
                                            {% if transcripcion.configuracion_utilizada %}
                                                <p><strong>Configuración:</strong> {{ transcripcion.configuracion_utilizada.nombre }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    {% if transcripcion.procesamiento_audio.archivo_mejorado %}
                                        <div class="text-center">
                                            <audio id="main-audio" controls class="w-100" preload="metadata">
                                                <source src="{{ transcripcion.procesamiento_audio.archivo_mejorado.url }}" type="audio/wav">
                                                Tu navegador no soporta el elemento audio.
                                            </audio>
                                            <p class="text-muted mt-2"><small>Click en el chat para sincronizar</small></p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <!-- Estadísticas Detalladas -->
                    <div class="card card-outline card-success">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-bar"></i> Estadísticas de Transcripción
                            </h3>
                        </div>
                        <div class="card-body">
                            <!-- Estadísticas básicas -->
                            <div class="row">
                                <div class="col-6">
                                    <div class="info-box">
                                        <span class="info-box-icon bg-info">
                                            <i class="fas fa-users"></i>
                                        </span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Hablantes</span>
                                            <span class="info-box-number">{{ transcripcion.numero_hablantes|default:0 }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="info-box">
                                        <span class="info-box-icon bg-success">
                                            <i class="fas fa-comments"></i>
                                        </span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Segmentos</span>
                                            <span class="info-box-number">{{ transcripcion.numero_segmentos|default:0 }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {% if transcripcion.palabras_totales %}
                            <div class="info-box mb-3">
                                <span class="info-box-icon bg-warning">
                                    <i class="fas fa-font"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Palabras Totales</span>
                                    <span class="info-box-number">{{ transcripcion.palabras_totales }}</span>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if transcripcion.confianza_promedio %}
                            <div class="info-box mb-3">
                                <span class="info-box-icon bg-primary">
                                    <i class="fas fa-percentage"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Confianza</span>
                                    <span class="info-box-number">{{ transcripcion.confianza_promedio|floatformat:1 }}%</span>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Estadísticas por hablante -->
                            {% if transcripcion.estadisticas_json.tiempo_por_hablante %}
                            <h6 class="mt-4 mb-2">Tiempo por Hablante</h6>
                            {% for hablante, tiempo in transcripcion.estadisticas_json.tiempo_por_hablante.items %}
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ tiempo.porcentaje|default:0 }}%"
                                     aria-valuenow="{{ tiempo.porcentaje|default:0 }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    {{ hablante }}: {{ tiempo.segundos|floatformat:1 }}s
                                </div>
                            </div>
                            {% endfor %}
                            {% endif %}
                            
                            <div class="mt-4">
                                <a href="{% url 'transcripcion:transcripciones_dashboard' %}" class="btn btn-secondary btn-block">
                                    <i class="fas fa-arrow-left"></i> Volver a Lista
                                </a>
                            </div>
                            <div class="mt-2">
                                {% if transcripcion.estado == 'en_proceso' or transcripcion.estado == 'transcribiendo' or transcripcion.estado == 'diarizando' or transcripcion.estado == 'procesando' %}
                                    <button type="button" class="btn btn-outline-secondary btn-block" title="No disponible mientras está en proceso" disabled>
                                        <i class="fas fa-undo"></i> Revertir a "Audios por Transcribir"
                                    </button>
                                {% else %}
                                <form method="post" action="{% url 'transcripcion:revertir_audios_por_transcribir' transcripcion.id %}" onsubmit="return confirm('¿Seguro que deseas revertir esta transcripción? El audio volverá a estar disponible para transcribir y se eliminará esta transcripción.');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-danger btn-block">
                                        <i class="fas fa-undo"></i> Revertir a "Audios por Transcribir"
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Segunda fila: JSON Estructurado -->
            <div class="row">
                <div class="col-12">
                    <div class="card card-outline card-info">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-code"></i> Datos de Transcripción (JSON)
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-sm btn-primary" id="btn-editar-json">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button type="button" class="btn btn-sm btn-success d-none" id="btn-guardar-json">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary d-none" id="btn-cancelar-json">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Transcripción Whisper</h6>
                                    <div class="json-editor">
                                        <div id="transcripcion-json" class="json-viewer">
                                            <pre>{{ transcripcion_json_formatted }}</pre>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Diarización Pyannote</h6>
                                    <div class="json-editor">
                                        <div id="diarizacion-json" class="json-viewer">
                                            <pre>{{ diarizacion_json_formatted }}</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>Conversación Estructurada</h6>
                                    <div class="json-editor">
                                        <div id="conversacion-json" class="json-viewer">
                                            <pre>{{ conversacion_json_formatted }}</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tercera fila: Chat Interactivo -->
            <div class="row">
                <div class="col-12">
                    <div class="card card-outline card-success direct-chat direct-chat-success">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-comments"></i> Conversación Transcrita
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-sm btn-info" id="btn-agregar-mensaje">
                                    <i class="fas fa-plus"></i> Agregar Mensaje
                                </button>
                                <button type="button" class="btn btn-sm btn-warning" id="btn-editar-hablantes">
                                    <i class="fas fa-users-cog"></i> Gestionar Hablantes
                                </button>
                                <span class="badge badge-primary" data-toggle="tooltip" title="Total de mensajes">
                                    {{ transcripcion.conversacion_json|length }} mensajes
                                </span>
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="direct-chat-messages" id="chat-messages" style="height: 500px;">
                                {% for mensaje in transcripcion.conversacion_json %}
                                <div class="direct-chat-msg chat-message" 
                                     data-tiempo-inicio="{{ mensaje.inicio|default:0 }}"
                                     data-mensaje-id="{{ forloop.counter0 }}">
                                    <div class="direct-chat-infos clearfix">
                                        <span class="direct-chat-name float-left">
                                            {{ mensaje.hablante|default:"Hablante Desconocido" }}
                                        </span>
                                        <span class="direct-chat-timestamp float-right timestamp-indicator">
                                            {{ mensaje.inicio|default:0|floatformat:1 }}s - {{ mensaje.fin|default:0|floatformat:1 }}s
                                        </span>
                                    </div>
                                    <img class="direct-chat-img speaker-avatar" 
                                         src="{% static 'dist/img/user1-128x128.jpg' %}" 
                                         alt="Speaker"
                                         style="background-color: {{ mensaje.color|default:'#007bff' }};">
                                    <div class="direct-chat-text editable-segment" 
                                         data-tipo="texto" 
                                         data-mensaje-id="{{ forloop.counter0 }}">
                                        {{ mensaje.texto|default:"[Sin texto]" }}
                                        <div class="text-right mt-1">
                                            <button class="btn btn-xs btn-outline-primary btn-edit-segment" 
                                                    title="Editar segmento">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-xs btn-outline-danger btn-delete-segment" 
                                                    title="Eliminar segmento">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="alert alert-info text-center">
                                    <i class="fas fa-info-circle"></i>
                                    No hay conversación transcrita disponible. 
                                    <br><small>Los datos aparecerán aquí una vez completado el procesamiento.</small>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="input-group">
                                <input type="text" id="nuevo-mensaje-texto" placeholder="Agregar nuevo mensaje..." class="form-control">
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-primary" id="btn-enviar-mensaje">
                                        <i class="fas fa-paper-plane"></i> Agregar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Texto completo (solo si existe) -->
            {% if transcripcion.texto_completo %}
            <div class="row">
                <div class="col-12">
                    <div class="card card-outline card-secondary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-file-alt"></i> Transcripción Completa (Texto Plano)
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="transcripcion-texto bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                                {{ transcripcion.texto_completo }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
        </div>
    </section>
</div>

<!-- Modal para editar hablantes -->
<div class="modal fade" id="modal-hablantes" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Gestionar Hablantes</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="lista-hablantes">
                    <!-- Se cargará dinámicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="btn-guardar-hablantes">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar segmento -->
<div class="modal fade" id="modal-editar-segmento" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Editar Segmento</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-editar-segmento">
                    <div class="form-group">
                        <label>Hablante:</label>
                        <select class="form-control" id="edit-hablante">
                            <!-- Se cargará dinámicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Texto:</label>
                        <textarea class="form-control" id="edit-texto" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="form-group">
                                <label>Tiempo Inicio (s):</label>
                                <input type="number" class="form-control" id="edit-inicio" step="0.1">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <label>Tiempo Fin (s):</label>
                                <input type="number" class="form-control" id="edit-fin" step="0.1">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-guardar-segmento">Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<!-- CSRF Token -->
<meta name="csrf-token" content="{{ csrf_token }}">

<!-- Script específico para detalle de transcripción -->
<script src="{% static 'js/detalle_transcripcion.js' %}"></script>

<script>
// Función para colorear JSON ya formateado
function colorizeJSON(jsonString) {
    return jsonString.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        var cls = 'json-number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) {
                cls = 'json-key';
            } else {
                cls = 'json-string';
            }
        } else if (/true|false/.test(match)) {
            cls = 'json-boolean';
        } else if (/null/.test(match)) {
            cls = 'json-null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
    });
}

// Pasar el ID de la transcripción al JavaScript
$(document).ready(function() {
    // Crear elemento oculto con el ID
    $('body').append('<div id="transcripcion-id" data-id="{{ transcripcion.id }}" style="display: none;"></div>');
    
    // Aplicar coloreado a los JSON ya formateados
    var transcripcionContainer = document.getElementById('transcripcion-json');
    if (transcripcionContainer) {
        // Usar escapejs para evitar que caracteres especiales rompan el script
        transcripcionContainer.innerHTML = colorizeJSON('{{ transcripcion_json_formatted|escapejs }}');
    }
    
    var diarizacionContainer = document.getElementById('diarizacion-json');
    if (diarizacionContainer) {
        diarizacionContainer.innerHTML = colorizeJSON('{{ diarizacion_json_formatted|escapejs }}');
    }
    
    var conversacionContainer = document.getElementById('conversacion-json');
    if (conversacionContainer) {
        conversacionContainer.innerHTML = colorizeJSON('{{ conversacion_json_formatted|escapejs }}');
    }
    
    // Agregar CSRF token a las peticiones AJAX
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", $('[name=csrfmiddlewaretoken]').val());
            }
        }
    });
});
</script>
{% endblock %}
