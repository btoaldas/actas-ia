{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Editor de Transcripci√≥n{% endblock %}

{% block extrahead %}
<!-- AdminLTE CSS -->
<link rel="stylesheet" href="{% static 'dist/css/adminlte.min.css' %}">
<!-- Font Awesome -->
<link rel="stylesheet" href="{% static 'plugins/fontawesome-free/css/all.min.css' %}">
<style>
.chat-message {
    margin-bottom: 15px;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: #f8f9fa;
}
.hablante-name {
    font-weight: bold;
    color: #007bff;
    margin-bottom: 5px;
}
.mensaje-texto {
    margin: 8px 0;
}
.tiempo-info {
    font-size: 0.85em;
    color: #6c757d;
    margin-bottom: 8px;
}
.segment-controls {
    margin-top: 10px;
}
.stats-card {
    background: #e9ecef;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
}
.json-display {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    font-family: monospace;
    font-size: 12px;
    max-height: 400px;
    overflow-y: auto;
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper" data-transcripcion-id="{{ transcripcion.id }}">
    <!-- Content Header -->
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>üìù Editor de Transcripci√≥n</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'transcripcion:transcripciones_dashboard' %}">Transcripciones</a></li>
                        <li class="breadcrumb-item active">Editor</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            
            <!-- Controles principales -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üéõÔ∏è Controles de Edici√≥n</h3>
                        </div>
                        <div class="card-body">
                            <button id="toggle-modo-edicion" class="btn btn-warning">
                                <i class="fas fa-edit"></i> <span id="modo-texto">Activar Edici√≥n</span>
                            </button>
                            <button id="btn-agregar-segmento" class="btn btn-success ml-2">
                                <i class="fas fa-plus"></i> Agregar Segmento
                            </button>
                            <button id="btn-gestionar-hablantes" class="btn btn-info ml-2">
                                <i class="fas fa-users"></i> Gestionar Hablantes
                            </button>
                            <button id="btn-vista-json" class="btn btn-secondary ml-2">
                                <i class="fas fa-code"></i> Ver JSON
                            </button>
                            
                            <div id="indicador-modo-edicion" class="alert alert-warning mt-3" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i> <strong>Modo Edici√≥n Activo</strong> - Puedes modificar los segmentos
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estad√≠sticas -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h4 id="total-segmentos" class="text-primary">0</h4>
                        <p>Total Segmentos</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h4 id="total-hablantes" class="text-success">0</h4>
                        <p>Hablantes</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h4 id="duracion-total" class="text-info">00:00</h4>
                        <p>Duraci√≥n Total</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h4 class="text-warning">{{ transcripcion.id }}</h4>
                        <p>ID Transcripci√≥n</p>
                    </div>
                </div>
            </div>

            <!-- Reproductor de audio -->
            {% if archivo_audio_url %}
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üéµ Reproductor de Audio</h3>
                        </div>
                        <div class="card-body">
                            <audio id="audio-player" controls class="w-100">
                                <source src="{{ archivo_audio_url }}" type="audio/mpeg">
                                <source src="{{ archivo_audio_url }}" type="audio/wav">
                                Tu navegador no soporta el elemento de audio.
                            </audio>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Conversaci√≥n -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üí¨ Conversaci√≥n Transcrita</h3>
                        </div>
                        <div class="card-body">
                            <!-- Contenedor de conversaci√≥n -->
                            <div id="conversacion-container">
                                <!-- Los segmentos se cargar√°n aqu√≠ via JavaScript -->
                            </div>
                            
                            <!-- Mensaje cuando no hay conversaci√≥n -->
                            <div id="no-conversacion" style="display: none;">
                                <div class="alert alert-info text-center">
                                    <i class="fas fa-info-circle"></i>
                                    <p class="mb-0">No hay segmentos de conversaci√≥n disponibles.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs para JSON -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìã Datos JSON</h3>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-tabs" id="json-tabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link active" id="conversacion-tab" data-toggle="tab" href="#tab-conversacion" role="tab">
                                        Conversaci√≥n
                                    </a>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link" id="hablantes-tab" data-toggle="tab" href="#tab-hablantes" role="tab">
                                        Hablantes
                                    </a>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link" id="metadata-tab" data-toggle="tab" href="#tab-metadata" role="tab">
                                        Metadata
                                    </a>
                                </li>
                            </ul>
                            <div class="tab-content mt-3" id="json-tab-content">
                                <div class="tab-pane fade show active" id="tab-conversacion" role="tabpanel">
                                    <pre id="json-conversacion" class="json-display">Cargando...</pre>
                                </div>
                                <div class="tab-pane fade" id="tab-hablantes" role="tabpanel">
                                    <pre id="json-hablantes" class="json-display">Cargando...</pre>
                                </div>
                                <div class="tab-pane fade" id="tab-metadata" role="tabpanel">
                                    <pre id="json-metadata" class="json-display">Cargando...</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>
</div>

<!-- Bot√≥n flotante de guardar -->
<button id="btn-guardar-cambios" class="btn btn-success btn-lg" style="position: fixed; bottom: 20px; right: 20px; display: none; z-index: 1000;">
    <i class="fas fa-save"></i> Guardar Cambios
</button>

{% endblock %}

{% block extrajs %}
<!-- AdminLTE JS -->
<script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
<script src="{% static 'plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'dist/js/adminlte.min.js' %}"></script>

<script>
// Debug: Mostrar datos recibidos
console.log('üîç Debug - Estructura recibida:', '{{ estructura_json|escapejs }}');

// Datos de la transcripci√≥n directamente en el template
const TRANSCRIPCION_DATA = {
    id: {{ transcripcion.id }},
    estructura: JSON.parse('{{ estructura_json|escapejs }}'),
    audioUrl: '{{ archivo_audio_url|escapejs }}'
};

console.log('üöÄ Datos de transcripci√≥n:', TRANSCRIPCION_DATA);

// Variables globales
let modoEdicion = false;
let estructuraActual = null;

// Inicializar cuando el documento est√© listo
$(document).ready(function() {
    console.log('üìù Inicializando editor de transcripci√≥n...');
    
    // Configurar datos
    estructuraActual = TRANSCRIPCION_DATA.estructura || {};
    
    // Configurar event listeners
    setupEventListeners();
    
    // Cargar contenido
    loadConversacion();
    updateEstadisticas();
    updateJSONViews();
    
    console.log('‚úÖ Editor inicializado correctamente');
});

function setupEventListeners() {
    // Toggle modo edici√≥n
    $('#toggle-modo-edicion').click(function() {
        modoEdicion = !modoEdicion;
        
        if (modoEdicion) {
            $(this).removeClass('btn-warning').addClass('btn-danger');
            $('#modo-texto').text('Desactivar Edici√≥n');
            $('#indicador-modo-edicion').show();
            alert('‚úÖ Modo edici√≥n activado');
        } else {
            $(this).removeClass('btn-danger').addClass('btn-warning');
            $('#modo-texto').text('Activar Edici√≥n');
            $('#indicador-modo-edicion').hide();
            alert('‚ÑπÔ∏è Modo edici√≥n desactivado');
        }
    });
    
    // Botones principales
    $('#btn-agregar-segmento').click(function() {
        alert('‚ûï Agregar Segmento - Funcionalidad en desarrollo');
    });
    
    $('#btn-gestionar-hablantes').click(function() {
        alert('üë• Gestionar Hablantes - Funcionalidad en desarrollo');
    });
    
    $('#btn-vista-json').click(function() {
        // Hacer scroll al √°rea de JSON
        $('html, body').animate({
            scrollTop: $('#json-tabs').offset().top - 100
        }, 1000);
        alert('üìÑ Vista JSON - Haciendo scroll a la secci√≥n JSON');
    });
    
    $('#btn-guardar-cambios').click(function() {
        alert('üíæ Guardar Cambios - Funcionalidad en desarrollo');
    });
}

function loadConversacion() {
    console.log('üìÇ Cargando conversaci√≥n...');
    
    const conversacion = estructuraActual.conversacion || [];
    const hablantes = estructuraActual.cabecera?.mapeo_hablantes || {};
    
    if (conversacion.length === 0) {
        $('#no-conversacion').show();
        $('#conversacion-container').hide();
        console.log('‚ö†Ô∏è No hay segmentos de conversaci√≥n');
        return;
    }
    
    $('#no-conversacion').hide();
    $('#conversacion-container').show();
    
    let html = '';
    
    conversacion.forEach((segmento, index) => {
        const hablante = segmento.hablante || 'Desconocido';
        const texto = segmento.texto || '[Sin texto]';
        const inicio = parseFloat(segmento.inicio || 0);
        const fin = parseFloat(segmento.fin || 0);
        const duracion = fin - inicio;
        
        const tiempoTexto = formatTime(inicio) + ' - ' + formatTime(fin);
        
        html += `
            <div class="chat-message" data-index="${index}">
                <div class="hablante-name">üó£Ô∏è ${hablante}</div>
                <div class="tiempo-info">‚è±Ô∏è ${tiempoTexto} (${duracion.toFixed(1)}s)</div>
                <div class="mensaje-texto">${texto}</div>
                <div class="segment-controls">
                    <button class="btn btn-sm btn-primary btn-edit" data-index="${index}">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-sm btn-info btn-play ml-1" data-inicio="${inicio}" data-fin="${fin}">
                        <i class="fas fa-play"></i> Reproducir
                    </button>
                    <button class="btn btn-sm btn-danger btn-delete ml-1" data-index="${index}">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </div>
        `;
    });
    
    $('#conversacion-container').html(html);
    
    // Configurar eventos de botones
    $('.btn-edit').click(function() {
        const index = $(this).data('index');
        alert(`‚úèÔ∏è Editar segmento ${index + 1}`);
    });
    
    $('.btn-play').click(function() {
        const inicio = $(this).data('inicio');
        const fin = $(this).data('fin');
        playSegment(inicio, fin);
    });
    
    $('.btn-delete').click(function() {
        const index = $(this).data('index');
        if (confirm('¬øEliminar este segmento?')) {
            estructuraActual.conversacion.splice(index, 1);
            loadConversacion();
            updateEstadisticas();
            alert('üóëÔ∏è Segmento eliminado');
        }
    });
    
    console.log(`‚úÖ Cargados ${conversacion.length} segmentos`);
}

function updateEstadisticas() {
    const conversacion = estructuraActual.conversacion || [];
    const hablantes = estructuraActual.cabecera?.mapeo_hablantes || {};
    
    $('#total-segmentos').text(conversacion.length);
    $('#total-hablantes').text(Object.keys(hablantes).length);
    
    // Calcular duraci√≥n total
    let duracionTotal = 0;
    conversacion.forEach(seg => {
        const inicio = parseFloat(seg.inicio || 0);
        const fin = parseFloat(seg.fin || 0);
        duracionTotal += (fin - inicio);
    });
    
    $('#duracion-total').text(formatTime(duracionTotal));
    
    console.log('üìä Estad√≠sticas actualizadas');
}

function updateJSONViews() {
    // Conversaci√≥n
    $('#json-conversacion').text(JSON.stringify(estructuraActual.conversacion || [], null, 2));
    
    // Hablantes
    $('#json-hablantes').text(JSON.stringify(estructuraActual.cabecera?.mapeo_hablantes || {}, null, 2));
    
    // Metadata
    $('#json-metadata').text(JSON.stringify(estructuraActual.metadata || {}, null, 2));
    
    console.log('üìÑ Vistas JSON actualizadas');
}

function playSegment(inicio, fin) {
    const audioPlayer = document.getElementById('audio-player');
    if (audioPlayer && audioPlayer.src) {
        audioPlayer.currentTime = inicio;
        audioPlayer.play();
        alert(`üéµ Reproduciendo desde ${formatTime(inicio)} hasta ${formatTime(fin)}`);
        
        // Pausar al final del segmento
        setTimeout(() => {
            if (audioPlayer.currentTime >= fin) {
                audioPlayer.pause();
            }
        }, (fin - inicio) * 1000);
    } else {
        alert('‚ö†Ô∏è Reproductor de audio no disponible');
    }
}

function formatTime(segundos) {
    const minutos = Math.floor(segundos / 60);
    const segs = Math.floor(segundos % 60);
    return minutos.toString().padStart(2, '0') + ':' + segs.toString().padStart(2, '0');
}
</script>
{% endblock %}