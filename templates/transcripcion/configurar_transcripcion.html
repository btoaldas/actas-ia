{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Configurar Transcripción - {{ audio.titulo|default:"Audio" }}{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">Configurar Transcripción</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'transcripcion:lista' %}">Transcripción</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'transcripcion:audios_listos' %}">Audios Listos</a></li>
                        <li class="breadcrumb-item active">Configurar</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            
            <!-- Información del Audio -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-light">
                        <div class="card-header bg-primary text-white">
                            <h3 class="card-title">
                                <i class="fas fa-file-audio"></i> Información del Audio
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td><strong>Archivo:</strong></td>
                                            <td>
                                                {% if audio.archivo_audio %}
                                                    {{ audio.archivo_audio.name }}
                                                {% else %}
                                                    Audio de prueba (sin archivo físico)
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Título:</strong></td>
                                            <td>{{ audio.titulo|default:"Sin título" }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Tipo de Reunión:</strong></td>
                                            <td><span class="badge bg-info">{{ audio.tipo_reunion.nombre }}</span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Duración:</strong></td>
                                            <td>{{ audio.duracion_seg|default:audio.duracion|floatformat:1 }}s</td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <td><strong>Calidad:</strong></td>
                                            <td>{{ audio.sample_rate|floatformat:0 }} Hz, {{ audio.bit_rate }} kbps</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Procesado:</strong></td>
                                            <td>{{ audio.fecha_procesamiento|date:"d/m/Y H:i" }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Ubicación:</strong></td>
                                            <td>{{ audio.ubicacion|default:"No especificada" }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Participantes:</strong></td>
                                            <td>{{ audio.participantes_detallados|length|default:"0" }} registrados</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Reproductor de audio -->
                            <div class="mt-3">
                                {% if audio.archivo_audio %}
                                <audio controls class="w-100">
                                    <source src="{{ audio.archivo_audio.url }}" type="audio/mpeg">
                                    Su navegador no soporta el elemento de audio.
                                </audio>
                                {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    Este es un audio de prueba sin archivo físico asociado.
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulario de Configuración -->
            <form method="post" id="configuracionForm">
                {% csrf_token %}
                
                <div class="row">
                    <!-- Configuración General -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h3 class="card-title">
                                    <i class="fas fa-cogs"></i> Configuración General
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label for="configuracion_base">Configuración Base</label>
                                    <select class="form-select" id="configuracion_base" name="configuracion_base">
                                        {% for config in configuraciones %}
                                        <option value="{{ config.id }}" 
                                                {% if config.id == configuracion_seleccionada.id %}selected{% endif %}
                                                data-config="{{ config.to_json }}">
                                            {{ config.nombre }} - {{ config.descripcion }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">
                                        Selecciona una configuración base y personalízala según tus necesidades.
                                    </small>
                                </div>

                                <div class="form-group mb-3">
                                    <label for="titulo_transcripcion">Título de la Transcripción</label>
                                    <input type="text" class="form-control" id="titulo_transcripcion" 
                                           name="titulo_transcripcion" 
                                           value="{{ audio.titulo|default:'Transcripción' }}"
                                           placeholder="Título para identificar esta transcripción">
                                </div>

                                <div class="form-group mb-3">
                                    <label for="descripcion_transcripcion">Descripción</label>
                                    <textarea class="form-control" id="descripcion_transcripcion" 
                                              name="descripcion_transcripcion" rows="3"
                                              placeholder="Descripción opcional de la transcripción">{{ audio.descripcion }}</textarea>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="usar_gpu" 
                                           name="usar_gpu" {% if configuracion_seleccionada.usar_gpu %}checked{% endif %}>
                                    <label class="form-check-label" for="usar_gpu">
                                        Usar GPU (si está disponible)
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Acelera el procesamiento significativamente.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuración de Whisper -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h3 class="card-title">
                                    <i class="fas fa-microphone"></i> Configuración Whisper
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label for="modelo_whisper">Modelo Whisper</label>
                                    <select class="form-select" id="modelo_whisper" name="modelo_whisper">
                                        <option value="tiny" {% if configuracion_seleccionada.modelo_whisper == 'tiny' %}selected{% endif %}>
                                            Tiny (39 MB) - Muy rápido, menor precisión
                                        </option>
                                        <option value="base" {% if configuracion_seleccionada.modelo_whisper == 'base' %}selected{% endif %}>
                                            Base (74 MB) - Equilibrado
                                        </option>
                                        <option value="small" {% if configuracion_seleccionada.modelo_whisper == 'small' %}selected{% endif %}>
                                            Small (244 MB) - Buena precisión
                                        </option>
                                        <option value="medium" {% if configuracion_seleccionada.modelo_whisper == 'medium' %}selected{% endif %}>
                                            Medium (769 MB) - Muy buena precisión
                                        </option>
                                        <option value="large" {% if configuracion_seleccionada.modelo_whisper == 'large' %}selected{% endif %}>
                                            Large (1550 MB) - Excelente precisión
                                        </option>
                                        <option value="large-v2" {% if configuracion_seleccionada.modelo_whisper == 'large-v2' %}selected{% endif %}>
                                            Large-v2 (1550 MB) - Mejor para múltiples idiomas
                                        </option>
                                        <option value="large-v3" {% if configuracion_seleccionada.modelo_whisper == 'large-v3' %}selected{% endif %}>
                                            Large-v3 (1550 MB) - Estado del arte
                                        </option>
                                    </select>
                                </div>

                                <div class="form-group mb-3">
                                    <label for="temperatura">Temperatura</label>
                                    <input type="range" class="form-range" id="temperatura" name="temperatura" 
                                           min="0" max="1" step="0.1" 
                                           value="{{ configuracion_seleccionada.temperatura }}"
                                           oninput="updateTemperaturaValue(this.value)">
                                    <div class="d-flex justify-content-between">
                                        <small>0.0 (Conservativo)</small>
                                        <strong id="temperaturaValue">{{ configuracion_seleccionada.temperatura }}</strong>
                                        <small>1.0 (Creativo)</small>
                                    </div>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="usar_vad" 
                                           name="usar_vad" {% if configuracion_seleccionada.usar_vad %}checked{% endif %}>
                                    <label class="form-check-label" for="usar_vad">
                                        Usar VAD (Voice Activity Detection)
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Detecta automáticamente cuando hay voz en el audio.
                                    </small>
                                </div>

                                <div class="form-group mb-3" id="vad_filtro_group">
                                    <label for="vad_filtro">Filtro VAD</label>
                                    <select class="form-select" id="vad_filtro" name="vad_filtro">
                                        <option value="silero" {% if configuracion_seleccionada.vad_filtro == 'silero' %}selected{% endif %}>
                                            Silero (Recomendado)
                                        </option>
                                        <option value="auditok" {% if configuracion_seleccionada.vad_filtro == 'auditok' %}selected{% endif %}>
                                            Auditok
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <!-- Configuración de Diarización -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h3 class="card-title">
                                    <i class="fas fa-users"></i> Configuración de Diarización
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="min_hablantes">Mínimo de Hablantes</label>
                                            <input type="number" class="form-control" id="min_hablantes" 
                                                   name="min_hablantes" min="1" max="10" 
                                                   value="{{ configuracion_seleccionada.min_hablantes }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="max_hablantes">Máximo de Hablantes</label>
                                            <input type="number" class="form-control" id="max_hablantes" 
                                                   name="max_hablantes" min="1" max="20" 
                                                   value="{{ configuracion_seleccionada.max_hablantes }}">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group mb-3">
                                    <label for="umbral_clustering">Umbral de Clustering</label>
                                    <input type="range" class="form-range" id="umbral_clustering" 
                                           name="umbral_clustering" min="0.1" max="1.0" step="0.05" 
                                           value="{{ configuracion_seleccionada.umbral_clustering }}"
                                           oninput="updateUmbralValue(this.value)">
                                    <div class="d-flex justify-content-between">
                                        <small>0.1 (Más sensible)</small>
                                        <strong id="umbralValue">{{ configuracion_seleccionada.umbral_clustering }}</strong>
                                        <small>1.0 (Menos sensible)</small>
                                    </div>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="usar_enhanced_diarization" 
                                           name="usar_enhanced_diarization" 
                                           {% if configuracion_seleccionada.usar_enhanced_diarization %}checked{% endif %}>
                                    <label class="form-check-label" for="usar_enhanced_diarization">
                                        Diarización Mejorada
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Usa algoritmos avanzados para mejor separación de hablantes.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuración de Procesamiento -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h3 class="card-title">
                                    <i class="fas fa-sliders-h"></i> Configuración de Procesamiento
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="chunk_duracion">Duración del Chunk (seg)</label>
                                            <input type="number" class="form-control" id="chunk_duracion" 
                                                   name="chunk_duracion" min="5" max="60" 
                                                   value="{{ configuracion_seleccionada.chunk_duracion }}">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="overlap_duracion">Overlap (seg)</label>
                                            <input type="number" class="form-control" id="overlap_duracion" 
                                                   name="overlap_duracion" min="0" max="10" 
                                                   value="{{ configuracion_seleccionada.overlap_duracion }}">
                                        </div>
                                    </div>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="filtro_ruido" 
                                           name="filtro_ruido" 
                                           {% if configuracion_seleccionada.filtro_ruido %}checked{% endif %}>
                                    <label class="form-check-label" for="filtro_ruido">
                                        Filtro de Ruido
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Reduce el ruido de fondo antes del procesamiento.
                                    </small>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="normalizar_audio" 
                                           name="normalizar_audio" 
                                           {% if configuracion_seleccionada.normalizar_audio %}checked{% endif %}>
                                    <label class="form-check-label" for="normalizar_audio">
                                        Normalizar Audio
                                    </label>
                                    <small class="form-text text-muted d-block">
                                        Ajusta el volumen para optimizar la transcripción.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de Acción -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body text-center">
                                <button type="submit" class="btn btn-success btn-lg me-3" id="transcribirBtn">
                                    <i class="fas fa-microphone"></i> Transcribir Audio
                                </button>
                                <a href="{% url 'transcripcion:audios_listos' %}" class="btn btn-secondary btn-lg">
                                    <i class="fas fa-arrow-left"></i> Volver
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

            </form>

            <!-- Sección de Monitoreo de Transcripción -->
            <div class="row mt-4" id="monitoreoSection" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h3 class="card-title">
                                <i class="fas fa-tasks"></i> Estado de Transcripción
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Estado y Progreso -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="info-box bg-info">
                                        <span class="info-box-icon"><i class="fas fa-cog fa-spin" id="estadoIcon"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Estado Actual</span>
                                            <span class="info-box-number" id="estadoTexto">Iniciando...</span>
                                            <div class="progress">
                                                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                                            </div>
                                            <span class="progress-description" id="progressTexto">0% Completado</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="info-box bg-success">
                                        <span class="info-box-icon"><i class="fas fa-clock"></i></span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">Tiempo Transcurrido</span>
                                            <span class="info-box-number" id="tiempoTranscurrido">00:00</span>
                                            <span class="progress-description">Task ID: <code id="taskId">-</code></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Logs de Celery -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title">
                                                <i class="fas fa-terminal"></i> Logs de Procesamiento
                                            </h3>
                                        </div>
                                        <div class="card-body p-0">
                                            <div id="logsContainer" style="height: 200px; overflow-y: auto; background: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace; padding: 10px;">
                                                <div id="logsContent">
                                                    <div class="log-entry">[INFO] Iniciando sistema de monitoreo...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de Resultados -->
            <div class="row mt-4" id="resultadosSection" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h3 class="card-title">
                                <i class="fas fa-check-circle"></i> Resultados de Transcripción
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Estadísticas Generales -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="small-box bg-info">
                                        <div class="inner">
                                            <h3 id="duracionTotal">0s</h3>
                                            <p>Duración Total</p>
                                        </div>
                                        <div class="icon">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="small-box bg-success">
                                        <div class="inner">
                                            <h3 id="numHablantes">0</h3>
                                            <p>Hablantes Detectados</p>
                                        </div>
                                        <div class="icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="small-box bg-warning">
                                        <div class="inner">
                                            <h3 id="numPalabras">0</h3>
                                            <p>Palabras Totales</p>
                                        </div>
                                        <div class="icon">
                                            <i class="fas fa-comment"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="small-box bg-danger">
                                        <div class="inner">
                                            <h3 id="confianzaPromedio">0%</h3>
                                            <p>Confianza Promedio</p>
                                        </div>
                                        <div class="icon">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Texto Transcrito -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title">
                                                <i class="fas fa-file-alt"></i> Texto Transcrito
                                            </h3>
                                        </div>
                                        <div class="card-body">
                                            <div id="textoTranscrito" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                                                <p class="text-muted">El texto aparecerá aquí una vez completada la transcripción...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- JSON Estructurado -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title">
                                                <i class="fas fa-code"></i> JSON de Transcripción
                                            </h3>
                                            <div class="card-tools">
                                                <button type="button" class="btn btn-sm btn-primary" onclick="copyToClipboard('transcripcionJson')">
                                                    <i class="fas fa-copy"></i> Copiar
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body p-0">
                                            <pre id="transcripcionJson" style="height: 400px; overflow-y: auto; margin: 0; padding: 15px; background: #2d3748; color: #e2e8f0; font-size: 12px;"></pre>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title">
                                                <i class="fas fa-chart-bar"></i> Estadísticas Detalladas
                                            </h3>
                                            <div class="card-tools">
                                                <button type="button" class="btn btn-sm btn-primary" onclick="copyToClipboard('estadisticasJson')">
                                                    <i class="fas fa-copy"></i> Copiar
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body p-0">
                                            <pre id="estadisticasJson" style="height: 400px; overflow-y: auto; margin: 0; padding: 15px; background: #2d3748; color: #e2e8f0; font-size: 12px;"></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>
</div>

<script>
// Variables globales para monitoreo
let transcripcionId = null;
let taskId = null;
let monitoringInterval = null;
let startTime = null;

// Actualizar valor de temperatura
function updateTemperaturaValue(value) {
    document.getElementById('temperaturaValue').textContent = value;
}

// Actualizar valor de umbral
function updateUmbralValue(value) {
    document.getElementById('umbralValue').textContent = value;
}

// Manejar cambio de configuración base
document.getElementById('configuracion_base').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const configData = JSON.parse(selectedOption.dataset.config);
    
    // Actualizar todos los campos con la nueva configuración
    document.getElementById('modelo_whisper').value = configData.modelo_whisper;
    document.getElementById('temperatura').value = configData.temperatura;
    updateTemperaturaValue(configData.temperatura);
    
    document.getElementById('usar_vad').checked = configData.usar_vad;
    document.getElementById('vad_filtro').value = configData.vad_filtro;
    
    document.getElementById('min_hablantes').value = configData.min_hablantes;
    document.getElementById('max_hablantes').value = configData.max_hablantes;
    document.getElementById('umbral_clustering').value = configData.umbral_clustering;
    updateUmbralValue(configData.umbral_clustering);
    
    document.getElementById('usar_enhanced_diarization').checked = configData.usar_enhanced_diarization;
    document.getElementById('chunk_duracion').value = configData.chunk_duracion;
    document.getElementById('overlap_duracion').value = configData.overlap_duracion;
    
    document.getElementById('filtro_ruido').checked = configData.filtro_ruido;
    document.getElementById('normalizar_audio').checked = configData.normalizar_audio;
    document.getElementById('usar_gpu').checked = configData.usar_gpu;
    
    toggleVadOptions();
});

// Mostrar/ocultar opciones VAD
function toggleVadOptions() {
    const usarVad = document.getElementById('usar_vad').checked;
    const vadFiltroGroup = document.getElementById('vad_filtro_group');
    vadFiltroGroup.style.display = usarVad ? 'block' : 'none';
}

// Inicializar estado VAD
document.getElementById('usar_vad').addEventListener('change', toggleVadOptions);
toggleVadOptions();

// Manejar envío del formulario
document.getElementById('configuracionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('transcribirBtn');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    btn.disabled = true;
    
    // Mostrar sección de monitoreo
    document.getElementById('monitoreoSection').style.display = 'block';
    document.getElementById('resultadosSection').style.display = 'none';
    
    // Scroll to monitoring section
    document.getElementById('monitoreoSection').scrollIntoView({behavior: 'smooth'});
    
    // Enviar formulario
    const formData = new FormData(this);
    
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            transcripcionId = data.transcripcion_id;
            taskId = data.task_id;
            startTime = new Date();
            
            document.getElementById('taskId').textContent = taskId;
            addLog(`[INFO] Transcripción iniciada - ID: ${transcripcionId}`);
            addLog(`[INFO] Task Celery - ID: ${taskId}`);
            
            // Iniciar monitoreo
            startMonitoring();
        } else {
            addLog(`[ERROR] ${data.error || 'Error desconocido'}`);
            resetForm();
        }
    })
    .catch(error => {
        addLog(`[ERROR] Error de red: ${error.message}`);
        resetForm();
    });
});

// Iniciar monitoreo en tiempo real
function startMonitoring() {
    monitoringInterval = setInterval(checkTranscripcionStatus, 3000); // Cada 3 segundos
    updateTimer();
}

// Detener monitoreo
function stopMonitoring() {
    if (monitoringInterval) {
        clearInterval(monitoringInterval);
        monitoringInterval = null;
    }
}

// Verificar estado de transcripción
function checkTranscripcionStatus() {
    if (!transcripcionId) return;
    
    fetch(`/transcripcion/api/estado/${transcripcionId}/`)
    .then(response => response.json())
    .then(data => {
        updateProgress(data);
        
        if (data.estado === 'completado') {
            stopMonitoring();
            showResults(data);
        } else if (data.estado === 'error') {
            stopMonitoring();
            addLog(`[ERROR] ${data.mensaje_error || 'Error en procesamiento'}`);
            resetForm();
        }
    })
    .catch(error => {
        addLog(`[WARN] Error verificando estado: ${error.message}`);
    });
}

// Actualizar progreso
function updateProgress(data) {
    const estados = {
        'pendiente': { icon: 'fas fa-clock', text: 'Pendiente', progress: 0 },
        'en_proceso': { icon: 'fas fa-cog fa-spin', text: 'En Proceso', progress: 20 },
        'transcribiendo': { icon: 'fas fa-microphone', text: 'Transcribiendo', progress: 40 },
        'diarizando': { icon: 'fas fa-users', text: 'Identificando Hablantes', progress: 70 },
        'procesando': { icon: 'fas fa-magic', text: 'Procesando Resultados', progress: 90 },
        'completado': { icon: 'fas fa-check', text: 'Completado', progress: 100 },
        'error': { icon: 'fas fa-times', text: 'Error', progress: 0 }
    };
    
    const estadoInfo = estados[data.estado] || estados['pendiente'];
    const progreso = data.progreso_porcentaje || estadoInfo.progress;
    
    document.getElementById('estadoIcon').className = estadoInfo.icon;
    document.getElementById('estadoTexto').textContent = estadoInfo.text;
    document.getElementById('progressBar').style.width = `${progreso}%`;
    document.getElementById('progressTexto').textContent = `${progreso}% Completado`;
    
    if (data.mensaje_estado) {
        addLog(`[INFO] ${data.mensaje_estado}`);
    }
}

// Mostrar resultados finales
function showResults(data) {
    addLog('[SUCCESS] ¡Transcripción completada exitosamente!');
    
    // Actualizar estadísticas
    document.getElementById('duracionTotal').textContent = `${data.duracion_total || 0}s`;
    document.getElementById('numHablantes').textContent = data.numero_hablantes || 0;
    document.getElementById('numPalabras').textContent = data.palabras_totales || 0;
    document.getElementById('confianzaPromedio').textContent = `${Math.round((data.confianza_promedio || 0) * 100)}%`;
    
    // Mostrar texto transcrito
    if (data.texto_completo) {
        document.getElementById('textoTranscrito').innerHTML = `<p>${data.texto_completo}</p>`;
    }
    
    // Mostrar JSON de transcripción
    if (data.transcripcion_json) {
        document.getElementById('transcripcionJson').textContent = JSON.stringify(data.transcripcion_json, null, 2);
    }
    
    // Mostrar estadísticas JSON
    if (data.estadisticas_json) {
        document.getElementById('estadisticasJson').textContent = JSON.stringify(data.estadisticas_json, null, 2);
    }
    
    // Mostrar conversación estructurada si existe
    if (data.conversacion_json && data.conversacion_json.length > 0) {
        let conversacionHtml = '<div class="conversation">';
        data.conversacion_json.forEach(segmento => {
            conversacionHtml += `
                <div class="mb-3 p-3 border-left-primary">
                    <strong>${segmento.hablante || 'Desconocido'}</strong> 
                    <small class="text-muted">(${segmento.inicio}s - ${segmento.fin}s)</small>
                    <p class="mb-0 mt-1">${segmento.texto}</p>
                </div>
            `;
        });
        conversacionHtml += '</div>';
        document.getElementById('textoTranscrito').innerHTML = conversacionHtml;
    }
    
    // Mostrar sección de resultados
    document.getElementById('resultadosSection').style.display = 'block';
    document.getElementById('resultadosSection').scrollIntoView({behavior: 'smooth'});
    
    resetForm();
}

// Agregar entrada al log
function addLog(message) {
    const logsContent = document.getElementById('logsContent');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> ${message}`;
    
    logsContent.appendChild(logEntry);
    
    // Scroll to bottom
    const logsContainer = document.getElementById('logsContainer');
    logsContainer.scrollTop = logsContainer.scrollHeight;
}

// Actualizar timer
function updateTimer() {
    if (!startTime) return;
    
    const elapsed = Math.floor((new Date() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    
    document.getElementById('tiempoTranscurrido').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (monitoringInterval) {
        setTimeout(updateTimer, 1000);
    }
}

// Resetear formulario
function resetForm() {
    const btn = document.getElementById('transcribirBtn');
    btn.innerHTML = '<i class="fas fa-microphone"></i> Transcribir Audio';
    btn.disabled = false;
}

// Copiar al portapapeles
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        // Mostrar feedback visual
        const originalIcon = event.target.querySelector('i');
        const originalClass = originalIcon.className;
        originalIcon.className = 'fas fa-check';
        
        setTimeout(() => {
            originalIcon.className = originalClass;
        }, 2000);
    }).catch(err => {
        addLog('[ERROR] No se pudo copiar al portapapeles');
    });
}

// Validaciones
document.getElementById('min_hablantes').addEventListener('change', function() {
    const min = parseInt(this.value);
    const max = parseInt(document.getElementById('max_hablantes').value);
    if (min > max) {
        document.getElementById('max_hablantes').value = min;
    }
});

document.getElementById('max_hablantes').addEventListener('change', function() {
    const max = parseInt(this.value);
    const min = parseInt(document.getElementById('min_hablantes').value);
    if (max < min) {
        document.getElementById('min_hablantes').value = max;
    }
});

// Verificar si hay transcripción en progreso al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si hay transcripción en progreso para este audio
    const audioId = {{ audio.id }};
    
    fetch(`/transcripcion/api/audio-estado/${audioId}/`)
    .then(response => response.json())
    .then(data => {
        if (data.transcripcion_activa) {
            transcripcionId = data.transcripcion_id;
            taskId = data.task_id;
            startTime = new Date(data.fecha_inicio);
            
            document.getElementById('monitoreoSection').style.display = 'block';
            document.getElementById('taskId').textContent = taskId;
            addLog(`[INFO] Recuperando transcripción en progreso - ID: ${transcripcionId}`);
            
            if (data.estado !== 'completado' && data.estado !== 'error') {
                startMonitoring();
            } else if (data.estado === 'completado') {
                showResults(data);
            }
        }
    })
    .catch(error => {
        console.log('No hay transcripción en progreso');
    });
});
</script>

{% endblock %}
