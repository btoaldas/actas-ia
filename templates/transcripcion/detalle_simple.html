{% extends 'layouts/base.html' %}
{% load static %}
{% load transcripcion_extras %}

{% block title %}Editor Simple{% endblock %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token }}">
<div class="content-wrapper">
    <section class="content-header">
        <h1>üìù Editor de Transcripci√≥n - Simple</h1>
    </section>

    <section class="content">
        <div class="container-fluid">
            
            <!-- Debug info -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-info">
                        <strong>Debug Info:</strong><br>
                        ID Transcripci√≥n: {{ transcripcion.id }}<br>
                        Tiene estructura: {{ estructura|yesno:"S√≠,No" }}<br>
                        {% if estructura.conversacion %}
                        Segmentos encontrados: {{ estructura.conversacion|length }}
                        {% else %}
                        No hay segmentos
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Controles -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Controles</h3>
                        </div>
                        <div class="card-body">
                            <button onclick="regenerarTranscripcion()" class="btn btn-warning">
                                üîÑ Regenerar Transcripci√≥n
                            </button>
                            <button onclick="mostrarDatos()" class="btn btn-info ml-2">
                                üìä Mostrar Datos
                            </button>
                            <button onclick="cargarConversacion()" class="btn btn-success ml-2">
                                üîÑ Cargar Conversaci√≥n
                            </button>
                            <button onclick="agregarHablante()" class="btn btn-primary ml-2">
                                üë• Agregar Hablante
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estado de proceso y Reproductor de audio -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h3 class="card-title">Estado de procesamiento</h3>
                        </div>
                        <div class="card-body d-flex align-items-center justify-content-center">
                            {% transcripcion_badge transcripcion %}
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card h-100">
                        <div class="card-header">
                            <h3 class="card-title">üéß Reproductor de audio</h3>
                        </div>
                        <div class="card-body">
                            {% if archivo_audio_url %}
                                <audio id="playerPrincipal" controls preload="metadata" style="width: 100%;">
                                    <source src="{{ archivo_audio_url }}" type="audio/mpeg">
                                    Tu navegador no soporta el elemento de audio.
                                </audio>
                                <small class="text-muted d-block mt-2">Usa el bot√≥n Play de cada segmento para saltar al minuto exacto.</small>
                            {% else %}
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-exclamation-triangle"></i> No hay archivo de audio asociado a esta transcripci√≥n.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estad√≠sticas -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 id="total-segmentos">{{ estructura.conversacion|length|default:0 }}</h4>
                            <p>Total Segmentos</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 id="total-hablantes">
                                {% if estructura.cabecera.mapeo_hablantes %}
                                    {{ estructura.cabecera.mapeo_hablantes|length }}
                                {% else %}
                                    0
                                {% endif %}
                            </h4>
                            <p>Hablantes</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4>{{ transcripcion.id }}</h4>
                            <p>ID Transcripci√≥n</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h4 class="text-success">FUNCIONAL</h4>
                            <p>Estado</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conversaci√≥n directa desde Django -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üí¨ Conversaci√≥n</h3>
                        </div>
                        <div class="card-body">
                            {% if estructura.conversacion %}
                                <!-- Bot√≥n para agregar al inicio -->
                                <div class="text-center mb-3">
                                    <button onclick="agregarSegmento(0)" class="btn btn-outline-success btn-sm">
                                        ‚ûï Agregar segmento al inicio
                                    </button>
                                </div>
                                
                                {% for segmento in estructura.conversacion %}
                                <div class="card mb-3" style="border-left: 4px solid #007bff;">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <strong class="text-primary">
                                                üó£Ô∏è {{ segmento.hablante|default:"Desconocido" }}
                                            </strong>
                                            <small class="text-muted">
                                                ‚è±Ô∏è {{ segmento.inicio|floatformat:1 }}s - {{ segmento.fin|floatformat:1 }}s
                                            </small>
                                        </div>
                                        <p class="mb-2">{{ segmento.texto }}</p>
                                        <div class="btn-group btn-group-sm">
                                            <button onclick="editarSegmento({{ forloop.counter0 }})" class="btn btn-outline-primary">
                                                <i class="fas fa-edit"></i> Editar
                                            </button>
                                            <button onclick="reproducirSegmento({{ segmento.inicio }}, {{ segmento.fin }}, {{ forloop.counter0 }})" class="btn btn-outline-info">
                                                <i class="fas fa-play"></i> Play
                                            </button>
                                            <button onclick="eliminarSegmento({{ forloop.counter0 }})" class="btn btn-outline-danger">
                                                <i class="fas fa-trash"></i> Eliminar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Bot√≥n para agregar despu√©s de este segmento -->
                                <div class="text-center mb-2">
                                    <button onclick="agregarSegmento({{ forloop.counter }})" class="btn btn-outline-success btn-sm">
                                        ‚ûï Agregar segmento aqu√≠
                                    </button>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    No hay segmentos de conversaci√≥n disponibles.
                                </div>
                                <!-- Bot√≥n para agregar el primer segmento -->
                                <div class="text-center">
                                    <button onclick="agregarSegmento(0)" class="btn btn-success">
                                        ‚ûï Agregar primer segmento
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- JSON Raw -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìÑ Datos JSON</h3>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-tabs">
                                <li class="nav-item">
                                    <a class="nav-link active" data-toggle="tab" href="#conversacion-json">Conversaci√≥n</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-toggle="tab" href="#hablantes-json">Hablantes</a>
                                </li>
                            </ul>
                            <div class="tab-content mt-3">
                                <div class="tab-pane fade show active" id="conversacion-json">
                                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto;">{{ estructura.conversacion|pprint }}</pre>
                                </div>
                                <div class="tab-pane fade" id="hablantes-json">
                                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px;">{{ estructura.cabecera.mapeo_hablantes|pprint }}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>
</div>

<!-- Modal para editar segmento -->
<div class="modal fade" id="modalEditarSegmento" tabindex="-1" role="dialog" aria-labelledby="modalEditarSegmentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarSegmentoLabel">‚úèÔ∏è Editar Segmento</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                {% if archivo_audio_url %}
                <div class="mb-3">
                    <label class="d-block">üéß Previsualizaci√≥n de audio del segmento</label>
                    <audio id="playerModal" controls preload="metadata" style="width: 100%;">
                        <source src="{{ archivo_audio_url }}" type="audio/mpeg">
                        Tu navegador no soporta el elemento de audio.
                    </audio>
                    <small class="text-muted">Se posicionar√° al inicio del segmento al abrir el modal (no auto-reproduce).</small>
                </div>
                {% endif %}
                <form id="formEditarSegmento">
                    <input type="hidden" id="segmentoIndex" value="">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="segmentoHablante">üó£Ô∏è Hablante:</label>
                                <select class="form-control" id="segmentoHablante" required>
                                    {% for hablante_id, info in estructura.cabecera.mapeo_hablantes.items %}
                                    <option value="{{ info|speaker_label }}">{{ info|speaker_label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="segmentoInicio">‚è∞ Inicio (s):</label>
                                <input type="number" class="form-control" id="segmentoInicio" step="0.1" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="segmentoFin">‚è∞ Fin (s):</label>
                                <input type="number" class="form-control" id="segmentoFin" step="0.1" min="0" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="segmentoTexto">üí¨ Texto:</label>
                        <textarea class="form-control" id="segmentoTexto" rows="4" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">‚ùå Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarEdicionSegmento()">üíæ Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar hablante -->
<div class="modal fade" id="modalAgregarHablante" tabindex="-1" role="dialog" aria-labelledby="modalAgregarHablanteLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAgregarHablanteLabel">üë• Agregar Nuevo Hablante</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formAgregarHablante">
                    <div class="form-group">
                        <label for="nuevoHablanteName">üó£Ô∏è Nombre del Hablante:</label>
                        <input type="text" class="form-control" id="nuevoHablanteName" placeholder="Ej: Mar√≠a Garc√≠a" required>
                    </div>
                    <div class="form-group">
                        <label for="nuevoHablanteCargo">üíº Cargo (opcional):</label>
                        <input type="text" class="form-control" id="nuevoHablanteCargo" placeholder="Ej: Secretaria">
                    </div>
                    <div class="form-group">
                        <label for="nuevoHablanteColor">üé® Color (opcional):</label>
                        <input type="color" class="form-control" id="nuevoHablanteColor" value="#007bff">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">‚ùå Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarNuevoHablante()">üë• Agregar Hablante</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para agregar segmento -->
<div class="modal fade" id="modalAgregarSegmento" tabindex="-1" role="dialog" aria-labelledby="modalAgregarSegmentoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAgregarSegmentoLabel">‚ûï Agregar Nuevo Segmento</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formAgregarSegmento">
                    <input type="hidden" id="nuevaPosicion" value="">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="nuevoSegmentoHablante">üó£Ô∏è Hablante:</label>
                                <select class="form-control" id="nuevoSegmentoHablante" required>
                                    {% for hablante_id, info in estructura.cabecera.mapeo_hablantes.items %}
                                    <option value="{{ hablante_id }}">{{ info|speaker_label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="nuevoSegmentoInicio">‚è∞ Inicio (s):</label>
                                <input type="number" class="form-control" id="nuevoSegmentoInicio" step="0.1" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="nuevoSegmentoFin">‚è∞ Fin (s):</label>
                                <input type="number" class="form-control" id="nuevoSegmentoFin" step="0.1" min="0" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="nuevoSegmentoTexto">üí¨ Texto:</label>
                        <textarea class="form-control" id="nuevoSegmentoTexto" rows="4" placeholder="Escribe aqu√≠ el texto del segmento..." required></textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <span id="infoNuevaPosicion">Se agregar√° al final de la conversaci√≥n</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">‚ùå Cancelar</button>
                <button type="button" class="btn btn-success" onclick="guardarNuevoSegmento()">‚ûï Agregar Segmento</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// JavaScript s√∫per simple - sin errores
console.log('‚úÖ JavaScript cargado correctamente');

// Variables globales
var datosEstructura = {{ estructura_json|safe }};
var transcripcionId = {{ transcripcion.id }};
var segmentoActual = null;
var playerPrincipal = null;
var playbackEndSec = null;
var timeupdateHandlerRegistrado = false;

// Funci√≥n real para mostrar datos
window.mostrarDatos = function() {
    var info = `
üÜî ID Transcripci√≥n: ${transcripcionId}
üìä Total Segmentos: ${datosEstructura.conversacion ? datosEstructura.conversacion.length : 0}
üó£Ô∏è Hablantes: ${Object.keys(datosEstructura.cabecera.mapeo_hablantes || {}).length}
üìù Estado: {{ transcripcion.estado }}
üìÖ Fecha: {{ transcripcion.fecha_creacion|date:"d/m/Y H:i" }}
‚è±Ô∏è Duraci√≥n Total: ${calcularDuracionTotal()}s
    `;
    alert(info);
}

// Funci√≥n para calcular duraci√≥n total
function calcularDuracionTotal() {
    if (!datosEstructura.conversacion || datosEstructura.conversacion.length === 0) return 0;
    var ultimoSegmento = datosEstructura.conversacion[datosEstructura.conversacion.length - 1];
    return ultimoSegmento.fin || 0;
}

// Funci√≥n real para cargar conversaci√≥n
window.cargarConversacion = function() {
    console.log('üîÑ Recargando datos desde el servidor...');
    
    // Usar API b√°sica en lugar de v2
    fetch(`/transcripcion/api/estado/${transcripcionId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success || data.estado) {
                alert('‚úÖ Conversaci√≥n verificada en el servidor');
                location.reload(); // Recargar p√°gina para mostrar datos actualizados
            } else {
                alert('‚ùå Error al cargar: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå Error de conexi√≥n al servidor');
        });
}

// Funci√≥n real para editar segmento
window.editarSegmento = function(index) {
    if (!datosEstructura.conversacion || index >= datosEstructura.conversacion.length) {
        alert('‚ùå Segmento no encontrado');
        return;
    }
    
    segmentoActual = datosEstructura.conversacion[index];
    
    // Llenar el modal con los datos del segmento
    document.getElementById('segmentoIndex').value = index;
    document.getElementById('segmentoHablante').value = segmentoActual.hablante;
    document.getElementById('segmentoInicio').value = segmentoActual.inicio;
    document.getElementById('segmentoFin').value = segmentoActual.fin;
    document.getElementById('segmentoTexto').value = segmentoActual.texto;
    
    // Mostrar el modal
    $('#modalEditarSegmento').modal('show');
}

// Funci√≥n para guardar edici√≥n
window.guardarEdicionSegmento = function() {
    var index = parseInt(document.getElementById('segmentoIndex').value);
    var hablante = document.getElementById('segmentoHablante').value;
    var inicio = parseFloat(document.getElementById('segmentoInicio').value);
    var fin = parseFloat(document.getElementById('segmentoFin').value);
    var texto = document.getElementById('segmentoTexto').value;
    
    // Validaciones b√°sicas
    if (!texto.trim()) {
        alert('‚ùå El texto no puede estar vac√≠o');
        return;
    }
    
    if (inicio >= fin) {
        alert('‚ùå El tiempo de inicio debe ser menor que el tiempo de fin');
        return;
    }
    
    // Preparar datos para enviar
    var datosEdicion = {
        indice: index,
        hablante: hablante,
        inicio: inicio,
        fin: fin,
        texto: texto.trim()
    };
    
    console.log('üíæ Guardando edici√≥n:', datosEdicion);
    
    // Preparar FormData para la API b√°sica
    var formData = new FormData();
    formData.append('segmento_id', index);
    formData.append('hablante', hablante);
    formData.append('texto', texto);
    formData.append('inicio', inicio);
    formData.append('fin', fin);
    
    // Enviar a la API b√°sica (no v2)
    fetch(`/transcripcion/api/editar-segmento/${transcripcionId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success || data.exito) {
            alert('‚úÖ Segmento editado correctamente');
            $('#modalEditarSegmento').modal('hide');
            location.reload(); // Recargar para mostrar cambios
        } else {
            alert('‚ùå Error al editar: ' + (data.error || data.mensaje || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error de conexi√≥n al servidor');
    });
}

// Funci√≥n real para reproducir segmento
window.reproducirSegmento = function(inicio, fin, idx) {
    var player = document.getElementById('playerPrincipal');
    if (!player) {
        alert('‚ùå No hay reproductor disponible para esta transcripci√≥n');
        return;
    }
    // Normalizar a n√∫meros
    inicio = Number(inicio);
    fin = Number(fin);
    // Intentar recuperar de la estructura si vienen inv√°lidos
    if (!isFinite(inicio) || inicio < 0) {
        if (Number.isInteger(idx) && datosEstructura.conversacion && datosEstructura.conversacion[idx]) {
            var seg = datosEstructura.conversacion[idx];
            if (typeof seg.inicio === 'number') inicio = seg.inicio;
        }
    }
    // Derivar fin si no es v√°lido o no es mayor a inicio
    if (!isFinite(fin) || fin <= inicio) {
        if (Number.isInteger(idx) && datosEstructura.conversacion && datosEstructura.conversacion[idx]) {
            var esUltimo = (idx + 1) >= datosEstructura.conversacion.length;
            if (!esUltimo) {
                var siguiente = datosEstructura.conversacion[idx + 1];
                if (siguiente && typeof siguiente.inicio === 'number') {
                    fin = siguiente.inicio;
                }
            }
            if (!isFinite(fin) || fin <= inicio) {
                // Usar duraci√≥n del audio si est√° disponible
                var dur = Number(player.duration);
                if (isFinite(dur) && dur > inicio) {
                    fin = dur;
                } else if (typeof datosEstructura.conversacion[datosEstructura.conversacion.length - 1]?.fin === 'number') {
                    fin = datosEstructura.conversacion[datosEstructura.conversacion.length - 1].fin;
                }
            }
        }
    }
    // √öltimo resguardo: ventana m√≠nima fija
    if (!isFinite(fin) || fin <= inicio) {
        fin = inicio + 3; // 3s por defecto
    }
    // Asegurar una duraci√≥n m√≠nima perceptible
    if ((fin - inicio) < 0.2) {
        fin = inicio + 0.8; // 800ms m√≠nimo
    }

    // Ajustar un peque√±o margen para detener antes del fin
    playbackEndSec = Math.max(0, fin - 0.05);

    var startAt = Math.max(0, inicio);
    var doSeek = function() {
        try {
            if (typeof player.fastSeek === 'function') {
                player.fastSeek(startAt);
            } else {
                player.currentTime = startAt;
            }
        } catch (e) {
            // Fallback silencioso
        }
    };

    var tryPlay = function() {
        try {
            var pp = player.play();
            if (pp && typeof pp.then === 'function') {
                pp.catch(function(err){ console.warn('No se pudo auto-reproducir:', err); });
            }
        } catch (e) {
            console.warn('No se pudo iniciar la reproducci√≥n:', e);
        }
        // Re-seek de respaldo por si el navegador arranc√≥ en 0
        setTimeout(function(){
            if (Math.abs(player.currentTime - startAt) > 0.25) {
                doSeek();
            }
        }, 80);
    };

    // Pausar y preparar
    try { player.pause(); } catch (e) {}

    if (player.readyState < 1) { // No hay metadata a√∫n
        var onLoaded = function() {
            player.removeEventListener('loadedmetadata', onLoaded);
            doSeek();
            tryPlay();
        };
        player.addEventListener('loadedmetadata', onLoaded);
        try { player.load(); } catch (e) {}
    } else {
        doSeek();
        tryPlay();
    }
}

// Funci√≥n real para eliminar segmento
window.eliminarSegmento = function(index) {
    if (!datosEstructura.conversacion || index >= datosEstructura.conversacion.length) {
        alert('‚ùå Segmento no encontrado');
        return;
    }
    
    var segmento = datosEstructura.conversacion[index];
    var mensaje = `¬øEst√°s seguro de eliminar este segmento?\n\nüó£Ô∏è ${segmento.hablante}: "${segmento.texto.substring(0, 50)}..."`;
    
    if (!confirm(mensaje)) return;
    
    // Preparar FormData para la API b√°sica
    var formData = new FormData();
    formData.append('segmento_id', index);
    
    // Enviar a la API b√°sica (no v2)
    fetch(`/transcripcion/api/eliminar-segmento/${transcripcionId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success || data.exito) {
            alert('‚úÖ Segmento eliminado correctamente');
            location.reload(); // Recargar para mostrar cambios
        } else {
            alert('‚ùå Error al eliminar: ' + (data.error || data.mensaje || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error de conexi√≥n al servidor');
    });
}

// ========================================
// NUEVAS FUNCIONES PARA FUNCIONALIDADES AVANZADAS
// ========================================

// Funci√≥n para regenerar transcripci√≥n completa
window.regenerarTranscripcion = function() {
    var confirmacion = confirm(`üîÑ ¬øEst√°s seguro de regenerar la transcripci√≥n completa?\n\n‚ö†Ô∏è Se perder√°n todos los cambios manuales realizados.\n‚ú® El audio se procesar√° nuevamente desde cero.`);
    
    if (!confirmacion) return;
    
    console.log('ÔøΩ Iniciando regeneraci√≥n de transcripci√≥n...');
    
    // Preparar FormData para la API
    var formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCsrfToken());
    
    fetch(`/transcripcion/api/regenerar-transcripcion/${transcripcionId}/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ ${data.mensaje}\n\nÔøΩ La p√°gina se recargar√° para mostrar el estado actualizado.`);
            location.reload();
        } else {
            alert(`‚ùå Error al regenerar: ${data.error || 'Error desconocido'}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error de conexi√≥n al servidor');
    });
}

// Funci√≥n para mostrar modal de agregar hablante
window.agregarHablante = function() {
    $('#modalAgregarHablante').modal('show');
}

// Funci√≥n para guardar nuevo hablante
window.guardarNuevoHablante = function() {
    var nombreHablante = document.getElementById('nuevoHablanteName').value.trim();
    var cargoHablante = document.getElementById('nuevoHablanteCargo').value.trim();
    
    if (!nombreHablante) {
        alert('‚ùå El nombre del hablante es obligatorio');
        return;
    }
    
    // Verificar si ya existe
    var mapeoHablantes = datosEstructura.cabecera.mapeo_hablantes || {};
    var existe = Object.values(mapeoHablantes).some(h => 
        h.nombre && h.nombre.toLowerCase() === nombreHablante.toLowerCase()
    );
    
    if (existe) {
        alert('‚ùå Ya existe un hablante con ese nombre');
        return;
    }
    
    console.log('üë• Agregando nuevo hablante...');
    
    // Preparar FormData para la API
    var formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCsrfToken());
    formData.append('nombre', nombreHablante);
    formData.append('cargo', cargoHablante);
    
    fetch(`/transcripcion/api/agregar-hablante/${transcripcionId}/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ ${data.mensaje}`);
            
            // Limpiar formulario
            document.getElementById('nuevoHablanteName').value = '';
            document.getElementById('nuevoHablanteCargo').value = '';
            $('#modalAgregarHablante').modal('hide');
            
            // Recargar para mostrar cambios
            location.reload();
        } else {
            alert(`‚ùå Error al agregar hablante: ${data.error || 'Error desconocido'}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error de conexi√≥n al servidor');
    });
}

// Funci√≥n para mostrar modal de agregar segmento
window.agregarSegmento = function(posicion) {
    // Guardar la posici√≥n donde insertar
    window.posicionNuevoSegmento = posicion;
    var posInput = document.getElementById('nuevaPosicion');
    if (posInput) posInput.value = posicion;
    
    // Calcular tiempo sugerido basado en segmentos adyacentes
    var tiempoInicio = 0, tiempoFin = 30;
    
    if (datosEstructura.conversacion && datosEstructura.conversacion.length > 0) {
        if (posicion === 0) {
            // Al inicio
            tiempoFin = Math.max(1, datosEstructura.conversacion[0].inicio - 1);
        } else if (posicion >= datosEstructura.conversacion.length) {
            // Al final
            var ultimoSegmento = datosEstructura.conversacion[datosEstructura.conversacion.length - 1];
            tiempoInicio = ultimoSegmento.fin + 1;
            tiempoFin = tiempoInicio + 30;
        } else {
            // Entre segmentos
            var segmentoAnterior = datosEstructura.conversacion[posicion - 1];
            var segmentoSiguiente = datosEstructura.conversacion[posicion];
            tiempoInicio = segmentoAnterior.fin + 0.5;
            tiempoFin = Math.max(tiempoInicio + 1, segmentoSiguiente.inicio - 0.5);
        }
    }
    
    // Prellenar formulario
    document.getElementById('nuevoSegmentoInicio').value = tiempoInicio.toFixed(1);
    document.getElementById('nuevoSegmentoFin').value = tiempoFin.toFixed(1);
    document.getElementById('nuevoSegmentoTexto').value = '';
    var infoPos = document.getElementById('infoNuevaPosicion');
    if (infoPos) {
        if (posicion === 0) infoPos.textContent = 'Se agregar√° al inicio de la conversaci√≥n';
        else if (posicion >= (datosEstructura.conversacion?.length || 0)) infoPos.textContent = 'Se agregar√° al final de la conversaci√≥n';
        else infoPos.textContent = `Se agregar√° en la posici√≥n ${posicion}`;
    }
    
    // Llenar select de hablantes
    var selectHablante = document.getElementById('nuevoSegmentoHablante');
    selectHablante.innerHTML = '<option value="">Seleccionar hablante...</option>';
    
    var mapeoHablantes = datosEstructura.cabecera.mapeo_hablantes || {};
    Object.entries(mapeoHablantes).forEach(([id, info]) => {
        var option = document.createElement('option');
        option.value = id; // backend acepta ID
        var label;
        if (typeof info === 'string') {
            label = info;
        } else {
            label = info.nombre || info.nombre_completo || info.nombre_real || (info.nombre && info.apellidos ? (info.nombre + ' ' + info.apellidos) : null) || `Hablante ${id}`;
        }
        option.textContent = `${id}: ${label}`;
        selectHablante.appendChild(option);
    });
    
    $('#modalAgregarSegmento').modal('show');
}

// Funci√≥n para guardar nuevo segmento
window.guardarNuevoSegmento = function() {
    var inicio = parseFloat(document.getElementById('nuevoSegmentoInicio').value);
    var fin = parseFloat(document.getElementById('nuevoSegmentoFin').value);
    var texto = document.getElementById('nuevoSegmentoTexto').value.trim();
    var hablanteId = document.getElementById('nuevoSegmentoHablante').value;
    
    // Validaciones
    if (isNaN(inicio) || isNaN(fin)) {
        alert('‚ùå Los tiempos de inicio y fin deben ser n√∫meros v√°lidos');
        return;
    }
    
    if (inicio >= fin) {
        alert('‚ùå El tiempo de inicio debe ser menor que el tiempo de fin');
        return;
    }
    
    if (!texto) {
        alert('‚ùå El texto del segmento es obligatorio');
        return;
    }
    
    if (!hablanteId) {
        alert('‚ùå Debe seleccionar un hablante');
        return;
    }
    
    var posInput = document.getElementById('nuevaPosicion');
    var posicion = (posInput && posInput.value !== '') ? parseInt(posInput.value) : (window.posicionNuevoSegmento || 0);
    
    console.log('‚ûï Insertando nuevo segmento en posici√≥n:', posicion);
    
    // Preparar FormData para la API
    var formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCsrfToken());
    formData.append('posicion', posicion);
    formData.append('inicio', inicio);
    formData.append('fin', fin);
    formData.append('texto', texto);
    formData.append('hablante_id', hablanteId);
    
    fetch(`/transcripcion/api/insertar-segmento/${transcripcionId}/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ ${data.mensaje}`);
            $('#modalAgregarSegmento').modal('hide');
            
            // Recargar para mostrar cambios
            location.reload();
        } else {
            alert(`‚ùå Error al insertar segmento: ${data.error || 'Error desconocido'}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Error de conexi√≥n al servidor');
    });
}

// Funci√≥n auxiliar para obtener CSRF token
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
}

// Inicializaci√≥n cuando el DOM est√© listo
$(document).ready(function() {
    console.log('üìù Editor avanzado inicializado');
    console.log('üéØ Funciones disponibles:', ['mostrarDatos', 'cargarConversacion', 'editarSegmento', 'reproducirSegmento', 'eliminarSegmento', 'regenerarTranscripcion', 'agregarHablante', 'agregarSegmento']);
    console.log('üìä Datos cargados:', {
        transcripcionId: transcripcionId,
        segmentos: datosEstructura.conversacion ? datosEstructura.conversacion.length : 0,
        hablantes: Object.keys(datosEstructura.cabecera.mapeo_hablantes || {}).length
    });

    // Configurar reproductor principal si existe
    playerPrincipal = document.getElementById('playerPrincipal');
    if (playerPrincipal && !timeupdateHandlerRegistrado) {
        playerPrincipal.addEventListener('timeupdate', function() {
            if (typeof playbackEndSec === 'number' && !isNaN(playbackEndSec)) {
                if (playerPrincipal.currentTime >= playbackEndSec) {
                    try { playerPrincipal.pause(); } catch (e) {}
                }
            }
        });
        timeupdateHandlerRegistrado = true;
    }

    // Pausar reproductor del modal al cerrar
    $('#modalEditarSegmento').on('hidden.bs.modal', function () {
        var pm = document.getElementById('playerModal');
        if (pm) {
            try { pm.pause(); } catch (e) {}
        }
    });

    // Polling de estado cada 5s para actualizar el badge de estado
    try {
        var badgeContainer = $(".card-title:contains('Estado de procesamiento')").closest('.card').find('.card-body');
        function renderBadgeHtml(data) {
            // Render simple seg√∫n estado de negocio y progreso (sin recompilar plantilla)
            var estado = (data.estado || '').toLowerCase();
            var progreso = data.progreso || data.progreso_porcentaje || 0;
            var map = {
                'pendiente': ['secondary', 'far fa-clock', 'Pendiente'],
                'en_proceso': ['info', 'fas fa-spinner fa-spin', 'En proceso'],
                'transcribiendo': ['primary', 'fas fa-keyboard', 'Transcribiendo'],
                'diarizando': ['secondary', 'fas fa-user-friends', 'Diarizando'],
                'procesando': ['warning', 'fas fa-cogs', 'Procesando'],
                'completado': ['success', 'fas fa-check', 'Completado'],
                'error': ['danger', 'fas fa-times', 'Error'],
                'cancelado': ['dark', 'fas fa-ban', 'Cancelado']
            };
            var cfg = map[estado] || ['light', 'fas fa-question', 'Desconocido'];
            var html = '<span class="badge badge-' + cfg[0] + '"><i class="' + cfg[1] + '"></i> ' + cfg[2] + '</span>';
            if (progreso > 0 && progreso < 100) {
                html += ' <span class="badge badge-light ml-1">' + parseInt(progreso) + '%</span>';
            }
            return html;
        }
        function tickEstado() {
            fetch('/transcripcion/api/estado/' + transcripcionId + '/')
                .then(r => r.json())
                .then(data => {
                    if (badgeContainer && badgeContainer.length) {
                        badgeContainer.html(renderBadgeHtml(data));
                    }
                })
                .catch(() => {});
        }
        setInterval(tickEstado, 5000);
    } catch (e) { /* noop */ }
});

// Sobrescribir/Extender editarSegmento para posicionar el reproductor del modal
var _editarSegmentoOriginal = window.editarSegmento;
window.editarSegmento = function(index) {
    // Llamar a la implementaci√≥n actual para llenar el formulario
    _editarSegmentoOriginal(index);
    // Posicionar el reproductor del modal (si existe)
    setTimeout(function(){
        var pm = document.getElementById('playerModal');
        if (pm && segmentoActual && typeof segmentoActual.inicio === 'number') {
            try { pm.currentTime = Math.max(0, segmentoActual.inicio); } catch (e) {}
        }
    }, 200);
}
</script>
{% endblock %}