{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ titulo_pagina }}{% endblock %}

{% block extrastyle %}
<!-- CSS específico para el detalle de transcripción con edición avanzada -->
<link rel="stylesheet" href="{% static 'css/detalle_transcripcion_avanzado.css' %}">
<style>
/* Estilos para la interfaz de edición avanzada */
.chat-message {
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 3px solid transparent;
    margin-bottom: 10px;
}

.chat-message:hover {
    background-color: #f8f9fa;
    border-left-color: #007bff;
}

.chat-message.editando {
    background-color: #fff3cd;
    border-left-color: #ffc107;
}

.chat-message.seleccionado {
    background-color: #d1ecf1;
    border-left-color: #17a2b8;
}

.segment-controls {
    opacity: 0;
    transition: opacity 0.3s ease;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
}

.chat-message:hover .segment-controls {
    opacity: 1;
}

.editable-content {
    border: 1px solid transparent;
    border-radius: 4px;
    padding: 5px;
    min-height: 40px;
    transition: border-color 0.3s ease;
}

.editable-content.editando {
    border-color: #ffc107;
    background-color: #fff;
}

.time-display {
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    color: #6c757d;
    font-weight: bold;
}

.speaker-tag {
    background-color: #007bff;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 500;
}

.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.floating-save-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    display: none;
}

.segment-editor {
    background-color: #f8f9fa;
    border: 2px solid #ffc107;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
}

.json-preview {
    max-height: 300px;
    overflow-y: auto;
    background-color: #2d3748;
    color: #e2e8f0;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    border-radius: 6px;
    padding: 15px;
}

.estructura-tabs .nav-link {
    border-radius: 6px 6px 0 0;
    border: none;
    background-color: #f8f9fa;
    margin-right: 5px;
}

.estructura-tabs .nav-link.active {
    background-color: #007bff;
    color: white;
}

/* Animaciones para feedback visual */
@keyframes pulseSuccess {
    0% { background-color: #d4edda; }
    50% { background-color: #c3e6cb; }
    100% { background-color: #d4edda; }
}

@keyframes pulseError {
    0% { background-color: #f8d7da; }
    50% { background-color: #f5c6cb; }
    100% { background-color: #f8d7da; }
}

.animate-success {
    animation: pulseSuccess 0.8s ease-in-out;
}

.animate-error {
    animation: pulseError 0.8s ease-in-out;
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    border-radius: 6px;
}

.hablante-color {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
    border: 2px solid #fff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.modo-edicion-activo {
    background: linear-gradient(45deg, #fff3cd, #ffeaa7);
    border: 2px solid #ffc107;
    border-radius: 10px;
    padding: 10px;
    margin: 10px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper" data-transcripcion-id="{{ transcripcion.id }}">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>{{ titulo_pagina }}</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'transcripcion:transcripciones_dashboard' %}">Transcripciones</a></li>
                        <li class="breadcrumb-item active">Detalle #{{ transcripcion.id }}</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <!-- CSRF Token para AJAX -->
            {% csrf_token %}
            
            <!-- Estadísticas y controles principales -->
            <div class="row">
                <div class="col-md-8">
                    <!-- Información del Audio -->
                    <div class="card card-outline card-primary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-file-audio"></i> {{ transcripcion.procesamiento_audio.titulo }}
                            </h3>
                            <div class="card-tools">
                                {% if transcripcion.estado == 'completado' %}
                                    <span class="badge badge-success">{{ transcripcion.estado|title }}</span>
                                {% elif transcripcion.estado == 'error' %}
                                    <span class="badge badge-danger">{{ transcripcion.estado|title }}</span>
                                {% else %}
                                    <span class="badge badge-warning">{{ transcripcion.estado|title }}</span>
                                {% endif %}
                                
                                <!-- Modo edición toggle -->
                                <button type="button" class="btn btn-sm btn-warning ml-2" id="toggle-modo-edicion" title="Activar/Desactivar modo edición">
                                    <i class="fas fa-edit"></i> <span id="modo-texto">Editar</span>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    {% if transcripcion.procesamiento_audio.descripcion %}
                                        <p class="text-muted">{{ transcripcion.procesamiento_audio.descripcion }}</p>
                                    {% endif %}
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Tipo:</strong> {{ transcripcion.procesamiento_audio.tipo_reunion.nombre }}</p>
                                            <p><strong>Usuario:</strong> {{ transcripcion.procesamiento_audio.usuario.get_full_name|default:transcripcion.procesamiento_audio.usuario.username }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Duración:</strong> {{ transcripcion.procesamiento_audio.duracion_formateada }}</p>
                                            <p><strong>Fecha:</strong> {{ transcripcion.fecha_creacion|date:"d/m/Y H:i" }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <!-- Reproductor de audio -->
                                    {% if archivo_audio_url %}
                                        <audio controls class="w-100 mb-2" id="audio-player">
                                            <source src="{{ archivo_audio_url }}" type="audio/mpeg">
                                            <source src="{{ archivo_audio_url }}" type="audio/wav">
                                            Tu navegador no soporta el elemento de audio.
                                        </audio>
                                        <p class="text-muted mt-2"><small>Click en segmentos para sincronizar</small></p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <!-- Estadísticas rápidas -->
                    <div class="stats-card">
                        <h5><i class="fas fa-chart-bar"></i> Estadísticas</h5>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="info-box-content">
                                    <span class="info-box-text">Segmentos</span>
                                    <span class="info-box-number" id="total-segmentos">{{ estructura.conversacion|length|default:0 }}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="info-box-content">
                                    <span class="info-box-text">Hablantes</span>
                                    <span class="info-box-number" id="total-hablantes">{{ estructura.cabecera.mapeo_hablantes|length|default:0 }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small>Última edición: <span id="fecha-edicion">{{ estructura.metadata.fecha_ultima_edicion|default:"No disponible" }}</span></small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Interactivo Mejorado -->
            <div class="row">
                <div class="col-12">
                    <div class="card card-outline card-success">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-comments"></i> Conversación Transcrita - Editor Avanzado
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-sm btn-info" id="btn-agregar-segmento">
                                    <i class="fas fa-plus"></i> Agregar Segmento
                                </button>
                                <button type="button" class="btn btn-sm btn-warning" id="btn-gestionar-hablantes">
                                    <i class="fas fa-users-cog"></i> Gestionar Hablantes
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary" id="btn-vista-json">
                                    <i class="fas fa-code"></i> Ver JSON
                                </button>
                                <span class="badge badge-primary ml-2" id="contador-mensajes">
                                    <span id="num-mensajes">{{ estructura.conversacion|length|default:0 }}</span> segmentos
                                </span>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <!-- Indicador de modo edición -->
                            <div id="indicador-modo-edicion" class="modo-edicion-activo" style="display: none;">
                                <div class="text-center">
                                    <i class="fas fa-edit text-warning"></i>
                                    <strong>MODO EDICIÓN ACTIVO</strong>
                                    <small class="ml-3">Haz clic en cualquier segmento para editarlo</small>
                                </div>
                            </div>
                            
                            <!-- Lista de segmentos -->
                            <div class="direct-chat-messages" id="chat-messages" style="height: 600px; position: relative;">
                                <div id="loading-overlay" class="loading-overlay" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Cargando...</span>
                                    </div>
                                </div>
                                
                                <div id="conversacion-container">
                                    <!-- Los segmentos se cargarán dinámicamente aquí -->
                                </div>
                                
                                <!-- Mensaje cuando no hay conversación -->
                                <div id="no-conversacion" class="alert alert-info text-center m-3" style="display: none;">
                                    <i class="fas fa-info-circle"></i>
                                    No hay conversación transcrita disponible.
                                    <br><small>Los segmentos aparecerán aquí una vez completado el procesamiento.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Estructura JSON Visualizable -->
            <div class="row">
                <div class="col-12">
                    <div class="card card-outline card-secondary collapsed-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-code"></i> Estructura JSON Completa
                            </h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-sm btn-primary" id="btn-editar-json">
                                    <i class="fas fa-edit"></i> Editar JSON
                                </button>
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body" style="display: none;">
                            <!-- Tabs para diferentes vistas del JSON -->
                            <ul class="nav nav-tabs estructura-tabs" id="estructura-tabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="tab-conversacion" data-toggle="tab" href="#panel-conversacion" role="tab">
                                        <i class="fas fa-comments"></i> Conversación
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="tab-cabecera" data-toggle="tab" href="#panel-cabecera" role="tab">
                                        <i class="fas fa-info-circle"></i> Cabecera
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="tab-metadata" data-toggle="tab" href="#panel-metadata" role="tab">
                                        <i class="fas fa-chart-bar"></i> Metadata
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="tab-completo" data-toggle="tab" href="#panel-completo" role="tab">
                                        <i class="fas fa-file-code"></i> Completo
                                    </a>
                                </li>
                            </ul>
                            
                            <div class="tab-content mt-3" id="estructura-content">
                                <div class="tab-pane fade show active" id="panel-conversacion" role="tabpanel">
                                    <div class="json-preview" id="json-conversacion"></div>
                                </div>
                                <div class="tab-pane fade" id="panel-cabecera" role="tabpanel">
                                    <div class="json-preview" id="json-cabecera"></div>
                                </div>
                                <div class="tab-pane fade" id="panel-metadata" role="tabpanel">
                                    <div class="json-preview" id="json-metadata"></div>
                                </div>
                                <div class="tab-pane fade" id="panel-completo" role="tabpanel">
                                    <div class="json-preview" id="json-completo"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </section>
</div>

<!-- Botón flotante para guardar cambios -->
<button type="button" class="btn btn-success btn-lg floating-save-btn" id="btn-guardar-cambios" title="Guardar todos los cambios">
    <i class="fas fa-save"></i>
</button>

<!-- Modales para edición -->
{% include 'transcripcion/modales/modal_editar_segmento.html' %}
{% include 'transcripcion/modales/modal_agregar_segmento.html' %}
{% include 'transcripcion/modales/modal_gestionar_hablantes.html' %}
{% include 'transcripcion/modales/modal_editar_json.html' %}

{% endblock %}

{% block extrajs %}
<!-- CSRF Token -->
<meta name="csrf-token" content="{{ csrf_token }}">

<!-- Scripts para edición avanzada -->
<script src="{% static 'js/editor_transcripcion_funcional.js' %}"></script>

<script>
// Configuración global para el editor
window.TranscripcionEditor = {
    transcripcionId: {{ transcripcion.id }},
    audioUrl: '{{ archivo_audio_url|escapejs }}',
    modoEdicion: false,
    cambiosPendientes: false,
    estructuraOriginal: null,
    
    // Estructura de datos directa
    estructura: {{ estructura_json|safe }},
    
    // URLs de las APIs
    urls: {
        obtenerEstructura: '{% url "transcripcion:api_obtener_estructura" transcripcion.id %}',
        editarSegmento: '{% url "transcripcion:api_editar_segmento_v2" transcripcion.id %}',
        agregarSegmento: '{% url "transcripcion:api_agregar_segmento_v2" transcripcion.id %}',
        eliminarSegmento: '{% url "transcripcion:api_eliminar_segmento_v2" transcripcion.id %}',
        gestionarHablantes: '{% url "transcripcion:api_gestionar_hablantes_v2" transcripcion.id %}',
        guardarEstructura: '{% url "transcripcion:api_guardar_estructura_v2" transcripcion.id %}'
    }
};

// Inicializar al cargar la página
$(document).ready(function() {
    console.log('🚀 Inicializando Editor Avanzado de Transcripción');
    
    // Configurar CSRF para AJAX
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", $('[name=csrfmiddlewaretoken]').val());
            }
        }
    });
    
    // Cargar estructura inicial
    TranscripcionEditor.cargarEstructura();
    
    // Configurar tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    console.log('✅ Editor Avanzado inicializado correctamente');
});
</script>
{% endblock %}