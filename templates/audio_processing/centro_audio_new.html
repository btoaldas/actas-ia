{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Centro de Procesamiento de Audio - {{ title }}{% endblock %}

{% block content %}
<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper">
  <!-- Content Header (Page header) -->
  <div class="content-header">
    <div class="container-fluid">
      <div class="row mb-2">
        <div class="col-sm-6">
          <h1><i class="fas fa-microphone-alt mr-2"></i>Centro de Procesamiento de Audio</h1>
        </div>
        <div class="col-sm-6">
          <ol class="breadcrumb float-sm-right">
            <li class="breadcrumb-item"><a href="/">Inicio</a></li>
            <li class="breadcrumb-item active">Audio</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Main content -->
  <section class="content">
    <div class="container-fluid">
      <!-- Info boxes -->
      <div class="row">
        <div class="col-12 col-sm-6 col-md-3">
          <div class="info-box">
            <span class="info-box-icon bg-info elevation-1"><i class="fas fa-cog"></i></span>
            <div class="info-box-content">
              <span class="info-box-text">Total Procesos</span>
              <span class="info-box-number">{{ stats.total|default:0 }}</span>
            </div>
          </div>
        </div>
        
        <div class="col-12 col-sm-6 col-md-3">
          <div class="info-box mb-3">
            <span class="info-box-icon bg-success elevation-1"><i class="fas fa-check"></i></span>
            <div class="info-box-content">
              <span class="info-box-text">Completados</span>
              <span class="info-box-number">{{ stats.completed|default:0 }}</span>
            </div>
          </div>
        </div>
        
        <div class="col-12 col-sm-6 col-md-3">
          <div class="info-box mb-3">
            <span class="info-box-icon bg-warning elevation-1"><i class="fas fa-spinner"></i></span>
            <div class="info-box-content">
              <span class="info-box-text">Procesando</span>
              <span class="info-box-number">{{ stats.processing|default:0 }}</span>
            </div>
          </div>
        </div>
        
        <div class="col-12 col-sm-6 col-md-3">
          <div class="info-box mb-3">
            <span class="info-box-icon bg-danger elevation-1"><i class="fas fa-exclamation-triangle"></i></span>
            <div class="info-box-content">
              <span class="info-box-text">Errores</span>
              <span class="info-box-number">{{ stats.error|default:0 }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Audio Processing Cards -->
      <div class="row">
        <!-- Recording Card -->
        <div class="col-md-6">
          <div class="card card-outline card-danger">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-microphone mr-2"></i>
                Grabar Audio
              </h3>
            </div>
            <div class="card-body">
              <p class="text-muted">Graba audio directamente desde tu micrófono para procesamiento inmediato.</p>
              
              <div class="recording-controls">
                <button id="recordButton" class="btn btn-danger btn-lg btn-block">
                  <i class="fas fa-circle mr-2"></i>
                  Iniciar Grabación
                </button>
                
                <div id="recordingStatus" class="alert alert-info mt-3" style="display: none;">
                  <i class="fas fa-circle text-danger"></i>
                  <span class="ml-2">Grabando...</span>
                  <span id="recordingTimer" class="float-right font-weight-bold">00:00</span>
                </div>
                
                <div id="audioPlayer" class="mt-3" style="display: none;">
                  <audio controls class="w-100"></audio>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Upload Card -->
        <div class="col-md-6">
          <div class="card card-outline card-primary">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-upload mr-2"></i>
                Subir Archivo
              </h3>
            </div>
            <div class="card-body">
              <p class="text-muted">Arrastra y suelta o selecciona un archivo de audio para procesar.</p>
              
              <div id="uploadZone" class="border border-dashed border-primary rounded p-4 text-center">
                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                <p class="mb-2"><strong>Arrastra archivos aquí o haz clic para seleccionar</strong></p>
                <p class="text-muted small">Formatos soportados: MP3, WAV, M4A, WEBM</p>
                <input type="file" id="fileInput" accept="audio/*" class="d-none">
              </div>
              
              <div id="selectedFile" class="mt-3" style="display: none;">
                <div class="alert alert-success">
                  <i class="fas fa-file-audio mr-2"></i>
                  <span id="fileName"></span>
                  <div class="mt-2">
                    <small class="text-muted">
                      Tamaño: <span id="fileSize"></span> | 
                      Tipo: <span id="fileType"></span>
                    </small>
                  </div>
                </div>
                
                <!-- Reproductor para archivo subido -->
                <div id="uploadedAudioPlayer" class="mt-3" style="display: none;">
                  <div class="card card-outline card-info">
                    <div class="card-header">
                      <h6 class="card-title">
                        <i class="fas fa-headphones"></i> Vista previa del audio
                      </h6>
                    </div>
                    <div class="card-body">
                      <audio id="previewAudio" controls class="w-100" preload="metadata">
                        Tu navegador no soporta la reproducción de audio.
                      </audio>
                      <div class="mt-2">
                        <small class="text-muted">
                          <span id="audioDuration"></span> | 
                          <span id="audioChannels"></span> | 
                          <span id="audioSampleRate"></span>
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Processing Form -->
      <div class="row">
        <div class="col-12">
          <div class="card card-outline card-success">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-cogs mr-2"></i>
                Configuración del Procesamiento
              </h3>
            </div>
            <div class="card-body">
              <form id="audioForm">
                {% csrf_token %}
                
                <!-- Primera fila -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="proceso_nombre">Nombre del Proceso</label>
                      <input type="text" class="form-control" id="proceso_nombre" name="proceso_nombre" 
                             placeholder="Ej: Reunión del 15 de Enero">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="tipo_reunion">Tipo de Reunión</label>
                      <select class="form-control" id="tipo_reunion" name="tipo_reunion">
                        <option value="reunion_trabajo">Reunión de Trabajo</option>
                        <option value="conferencia">Conferencia</option>
                        <option value="entrevista">Entrevista</option>
                        <option value="seminario">Seminario</option>
                        <option value="llamada">Llamada</option>
                        <option value="otro">Otro</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Segunda fila - Participantes Avanzados -->
                <div class="row">
                  <div class="col-12">
                    <div class="form-group">
                      <label><i class="fas fa-users"></i> Participantes de la Reunión</label>
                      <div class="card card-outline card-info">
                        <div class="card-header">
                          <h6 class="card-title">Gestión de Participantes</h6>
                          <div class="card-tools">
                            <button type="button" id="addParticipant" class="btn btn-sm btn-success">
                              <i class="fas fa-plus"></i> Agregar Participante
                            </button>
                          </div>
                        </div>
                        <div class="card-body">
                          <div id="participantsList">
                            <!-- Los participantes se agregarán dinámicamente aquí -->
                          </div>
                          
                          <!-- Participantes en texto libre (backup) -->
                          <div class="mt-3">
                            <label for="participantes_texto">Participantes (texto libre - opcional)</label>
                            <textarea class="form-control" id="participantes_texto" name="participantes_texto" rows="2"
                                      placeholder="Lista adicional de participantes en formato libre"></textarea>
                            <small class="text-muted">Este campo es opcional y complementario a la lista detallada de arriba.</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Tercera fila - Ubicación -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="ubicacion">Ubicación</label>
                      <input type="text" class="form-control" id="ubicacion" name="ubicacion"
                             placeholder="Ej: Sala de Juntas A, Online, etc.">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="fecha_reunion">Fecha de la Reunión</label>
                      <input type="datetime-local" class="form-control" id="fecha_reunion" name="fecha_reunion">
                    </div>
                  </div>
                </div>

                <!-- Cuarta fila -->
                <div class="row">
                  <div class="col-md-8">
                    <div class="form-group">
                      <label for="descripcion">Descripción</label>
                      <textarea class="form-control" id="descripcion" name="descripcion" rows="3"
                                placeholder="Descripción opcional del contenido del audio"></textarea>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="etiquetas">Etiquetas</label>
                      <input type="text" class="form-control" id="etiquetas" name="etiquetas"
                             placeholder="trabajo, importante, urgente">
                    </div>
                    <div class="form-group">
                      <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="confidencial" name="confidencial">
                        <label class="custom-control-label" for="confidencial">Contenido Confidencial</label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Botón de procesamiento -->
                <div class="row">
                  <div class="col-12">
                    <button type="submit" id="processButton" class="btn btn-success btn-lg btn-block" disabled>
                      <i class="fas fa-play mr-2"></i>
                      <span class="btn-text">Procesar Audio</span>
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Processes -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-history mr-2"></i>
                Procesos Recientes
              </h3>
              <div class="card-tools">
                <button type="button" class="btn btn-tool" id="refreshProcesses" title="Refrescar">
                  <i class="fas fa-sync-alt"></i>
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered table-striped">
                  <thead>
                    <tr>
                      <th>Nombre</th>
                      <th>Fecha</th>
                      <th>Estado</th>
                      <th>Progreso</th>
                      <th>Audio Procesado</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="recentProcesses">
                    {% if recent_processes %}
                      {% for proceso in recent_processes %}
                        <tr>
                          <td>
                            <strong>{{ proceso.titulo|default:"Sin título" }}</strong>
                            {% if proceso.tipo_reunion %}
                              <br><small class="text-muted">{{ proceso.get_tipo_reunion_display }}</small>
                            {% endif %}
                          </td>
                          <td>
                            <span class="text-muted">{{ proceso.created_at|date:"d/m/Y" }}</span>
                            <br><small>{{ proceso.created_at|time:"H:i" }}</small>
                          </td>
                          <td>
                            {% if proceso.estado == 'completado' %}
                              <span class="badge badge-success">
                                <i class="fas fa-check mr-1"></i>Completado
                              </span>
                            {% elif proceso.estado == 'procesando' %}
                              <span class="badge badge-warning">
                                <i class="fas fa-spinner fa-spin mr-1"></i>Procesando
                              </span>
                            {% elif proceso.estado == 'transcribiendo' %}
                              <span class="badge badge-info">
                                <i class="fas fa-file-alt mr-1"></i>Transcribiendo
                              </span>
                            {% elif proceso.estado == 'error' %}
                              <span class="badge badge-danger">
                                <i class="fas fa-exclamation-triangle mr-1"></i>Error
                              </span>
                            {% else %}
                              <span class="badge badge-secondary">
                                <i class="fas fa-clock mr-1"></i>Pendiente
                              </span>
                            {% endif %}
                          </td>
                          <td>
                            {% if proceso.estado == 'completado' %}
                              <div class="progress progress-sm">
                                <div class="progress-bar bg-success" style="width: 100%"></div>
                              </div>
                              <small class="text-success">100%</small>
                            {% elif proceso.estado == 'procesando' %}
                              <div class="progress progress-sm">
                                <div class="progress-bar bg-warning progress-bar-striped progress-bar-animated" style="width: 60%"></div>
                              </div>
                              <small class="text-warning">Procesando...</small>
                            {% elif proceso.estado == 'transcribiendo' %}
                              <div class="progress progress-sm">
                                <div class="progress-bar bg-info progress-bar-striped progress-bar-animated" style="width: 80%"></div>
                              </div>
                              <small class="text-info">Transcribiendo...</small>
                            {% elif proceso.estado == 'error' %}
                              <div class="progress progress-sm">
                                <div class="progress-bar bg-danger" style="width: 100%"></div>
                              </div>
                              <small class="text-danger">Error</small>
                            {% else %}
                              <div class="progress progress-sm">
                                <div class="progress-bar bg-secondary" style="width: 10%"></div>
                              </div>
                              <small class="text-muted">En cola</small>
                            {% endif %}
                          </td>
                          <td>
                            {% if proceso.estado == 'completado' and proceso.archivo_mejorado %}
                              <div class="audio-player-mini">
                                <audio controls preload="none" style="width: 200px; height: 30px;">
                                  <source src="{{ proceso.archivo_mejorado.url }}" type="audio/mpeg">
                                  <source src="{{ proceso.archivo_mejorado.url }}" type="audio/wav">
                                  Tu navegador no soporta audio HTML5.
                                </audio>
                                <br><small class="text-muted">Audio procesado</small>
                              </div>
                            {% elif proceso.archivo_audio %}
                              <div class="audio-player-mini">
                                <audio controls preload="none" style="width: 200px; height: 30px;">
                                  <source src="{{ proceso.archivo_audio.url }}" type="audio/mpeg">
                                  <source src="{{ proceso.archivo_audio.url }}" type="audio/wav">
                                  Tu navegador no soporta audio HTML5.
                                </audio>
                                <br><small class="text-muted">Audio original</small>
                              </div>
                            {% else %}
                              <span class="text-muted">
                                <i class="fas fa-times"></i> Sin audio
                              </span>
                            {% endif %}
                          </td>
                          <td>
                            <div class="btn-group btn-group-sm">
                              {% if proceso.estado == 'completado' %}
                                <a href="{% url 'audio_processing:detalle_procesamiento' proceso.id %}" 
                                   class="btn btn-info btn-sm" title="Ver detalle">
                                  <i class="fas fa-eye"></i>
                                </a>
                                {% if proceso.archivo_transcripcion %}
                                  <a href="{{ proceso.archivo_transcripcion.url }}" 
                                     class="btn btn-success btn-sm" title="Descargar transcripción" target="_blank">
                                    <i class="fas fa-download"></i>
                                  </a>
                                {% endif %}
                              {% elif proceso.estado == 'error' %}
                                <a href="{% url 'audio_processing:detalle_procesamiento' proceso.id %}" 
                                   class="btn btn-warning btn-sm" title="Ver error">
                                  <i class="fas fa-exclamation-circle"></i>
                                </a>
                              {% else %}
                                <button class="btn btn-secondary btn-sm" disabled title="Procesando...">
                                  <i class="fas fa-clock"></i>
                                </button>
                              {% endif %}
                            </div>
                          </td>
                        </tr>
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td colspan="6" class="text-center text-muted">
                          <i class="fas fa-info-circle mr-2"></i>
                          {% if es_demo %}
                            Inicia sesión para ver tus procesos
                          {% else %}
                            No hay procesos recientes
                          {% endif %}
                        </td>
                      </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let mediaRecorder;
    let audioChunks = [];
    let recordingTimer;
    let recordingTime = 0;
    let selectedAudioFile = null;

    // Elementos del DOM
    const recordButton = document.getElementById('recordButton');
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const audioForm = document.getElementById('audioForm');
    const processButton = document.getElementById('processButton');
    const recordingStatus = document.getElementById('recordingStatus');
    const recordingTimerDisplay = document.getElementById('recordingTimer');
    const audioPlayer = document.getElementById('audioPlayer');
    const selectedFileDiv = document.getElementById('selectedFile');
    const fileName = document.getElementById('fileName');

    // ===== GRABACIÓN DE AUDIO =====
    recordButton.addEventListener('click', async function() {
        if (!mediaRecorder || mediaRecorder.state === 'inactive') {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = function(event) {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = function() {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    // Crear un objeto File en lugar de solo un Blob para tener un nombre
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    selectedAudioFile = new File([audioBlob], `grabacion_${timestamp}.webm`, { 
                        type: 'audio/webm' 
                    });
                    
                    // Mostrar reproductor
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = audioPlayer.querySelector('audio');
                    audio.src = audioUrl;
                    audioPlayer.style.display = 'block';
                    
                    // Habilitar botón de procesamiento
                    processButton.disabled = false;
                    
                    // Limpiar chunks para próxima grabación
                    audioChunks = [];
                    
                    console.log('Grabación completada:', selectedAudioFile);
                };
                
                mediaRecorder.start();
                startRecording();
                
            } catch (error) {
                console.error('Error al acceder al micrófono:', error);
                alert('Error al acceder al micrófono. Verifica los permisos.');
            }
        } else {
            mediaRecorder.stop();
            stopRecording();
        }
    });

    function startRecording() {
        recordButton.innerHTML = '<i class="fas fa-stop mr-2"></i>Detener Grabación';
        recordButton.classList.remove('btn-danger');
        recordButton.classList.add('btn-warning');
        recordingStatus.style.display = 'block';
        
        recordingTime = 0;
        recordingTimer = setInterval(function() {
            recordingTime++;
            const minutes = Math.floor(recordingTime / 60);
            const seconds = recordingTime % 60;
            recordingTimerDisplay.textContent = 
                String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
        }, 1000);
    }

    function stopRecording() {
        recordButton.innerHTML = '<i class="fas fa-circle mr-2"></i>Iniciar Grabación';
        recordButton.classList.remove('btn-warning');
        recordButton.classList.add('btn-danger');
        recordingStatus.style.display = 'none';
        
        if (recordingTimer) {
            clearInterval(recordingTimer);
        }
    }

    // ===== SUBIDA DE ARCHIVOS =====
    uploadZone.addEventListener('click', function() {
        fileInput.click();
    });

    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('border-success');
    });

    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('border-success');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('border-success');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelection(files[0]);
        }
    });

    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelection(e.target.files[0]);
        }
    });

    function handleFileSelection(file) {
        if (file.type.startsWith('audio/')) {
            selectedAudioFile = file;
            fileName.textContent = file.name;
            document.getElementById('fileSize').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
            document.getElementById('fileType').textContent = file.type;
            selectedFileDiv.style.display = 'block';
            processButton.disabled = false;
            
            // Mostrar reproductor con metadatos
            showAudioPreview(file);
            
            // Ocultar reproductor de grabación si estaba visible
            audioPlayer.style.display = 'none';
        } else {
            alert('Por favor selecciona un archivo de audio válido.');
        }
    }

    // ===== NUEVA FUNCIÓN: MOSTRAR VISTA PREVIA DE AUDIO =====
    function showAudioPreview(file) {
        const uploadedAudioPlayer = document.getElementById('uploadedAudioPlayer');
        const previewAudio = document.getElementById('previewAudio');
        
        // Crear URL temporal para el archivo
        const audioUrl = URL.createObjectURL(file);
        previewAudio.src = audioUrl;
        
        // Mostrar el reproductor
        uploadedAudioPlayer.style.display = 'block';
        
        // Obtener metadatos cuando se cargue
        previewAudio.addEventListener('loadedmetadata', function() {
            const duration = Math.round(previewAudio.duration);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            
            document.getElementById('audioDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Intentar obtener más metadatos usando Web Audio API
            if (window.AudioContext || window.webkitAudioContext) {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    audioContext.decodeAudioData(e.target.result)
                        .then(audioBuffer => {
                            document.getElementById('audioChannels').textContent = `${audioBuffer.numberOfChannels} canal(es)`;
                            document.getElementById('audioSampleRate').textContent = `${audioBuffer.sampleRate} Hz`;
                        })
                        .catch(error => {
                            console.log('No se pudieron obtener metadatos adicionales:', error);
                            document.getElementById('audioChannels').textContent = 'N/A canales';
                            document.getElementById('audioSampleRate').textContent = 'N/A Hz';
                        });
                };
                
                reader.readAsArrayBuffer(file);
            }
        });
    }

    // ===== GESTIÓN DE PARTICIPANTES =====
    let participantsCounter = 0;
    const participantsList = document.getElementById('participantsList');
    const addParticipantBtn = document.getElementById('addParticipant');

    function createParticipantRow(participant = null) {
        participantsCounter++;
        const participantId = participant ? participant.id : participantsCounter;
        
        const participantHtml = `
            <div class="participant-row border rounded p-3 mb-3" data-participant-id="${participantId}">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Nombres</label>
                            <input type="text" class="form-control participant-name" 
                                   value="${participant ? participant.nombres : ''}" 
                                   placeholder="Nombres">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Apellidos</label>
                            <input type="text" class="form-control participant-lastname" 
                                   value="${participant ? participant.apellidos : ''}" 
                                   placeholder="Apellidos">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>Cargo</label>
                            <input type="text" class="form-control participant-position" 
                                   value="${participant ? participant.cargo : ''}" 
                                   placeholder="Cargo">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Institución</label>
                            <input type="text" class="form-control participant-institution" 
                                   value="${participant ? participant.institucion : ''}" 
                                   placeholder="Institución">
                        </div>
                    </div>
                    <div class="col-md-1">
                        <div class="form-group">
                            <label>Orden</label>
                            <div class="input-group">
                                <input type="number" class="form-control participant-order" 
                                       value="${participant ? participant.orden : participantsCounter}" 
                                       min="1" max="20">
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-danger btn-sm remove-participant" 
                                            title="Eliminar participante">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        participantsList.insertAdjacentHTML('beforeend', participantHtml);
        
        // Agregar evento para eliminar
        const newRow = participantsList.lastElementChild;
        const removeBtn = newRow.querySelector('.remove-participant');
        removeBtn.addEventListener('click', function() {
            newRow.remove();
        });
    }

    function getParticipantsData() {
        const participants = [];
        const participantRows = document.querySelectorAll('.participant-row');
        
        participantRows.forEach(row => {
            const nombres = row.querySelector('.participant-name').value.trim();
            const apellidos = row.querySelector('.participant-lastname').value.trim();
            const cargo = row.querySelector('.participant-position').value.trim();
            const institucion = row.querySelector('.participant-institution').value.trim();
            const orden = parseInt(row.querySelector('.participant-order').value) || 1;
            
            if (nombres || apellidos) { // Solo agregar si tiene al menos nombre o apellido
                participants.push({
                    nombres,
                    apellidos,
                    cargo,
                    institucion,
                    orden
                });
            }
        });
        
        // Ordenar por orden
        participants.sort((a, b) => a.orden - b.orden);
        
        return participants;
    }

    // Evento para agregar participante
    addParticipantBtn.addEventListener('click', function() {
        createParticipantRow();
    });

    // Agregar un participante por defecto
    createParticipantRow();

    function handleFileSelection(file) {
        if (file.type.startsWith('audio/')) {
            selectedAudioFile = file;
            fileName.textContent = file.name;
            selectedFileDiv.style.display = 'block';
            processButton.disabled = false;
            
            // Ocultar reproductor de grabación si estaba visible
            audioPlayer.style.display = 'none';
        } else {
            alert('Por favor selecciona un archivo de audio válido.');
        }
    }

    // ===== PROCESAMIENTO =====
    audioForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!selectedAudioFile) {
            alert('Por favor graba o selecciona un archivo de audio primero.');
            return;
        }

        console.log('Archivo seleccionado:', selectedAudioFile);
        console.log('Tipo de archivo:', selectedAudioFile.type);
        console.log('Tamaño de archivo:', selectedAudioFile.size);

        const formData = new FormData();
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Datos del formulario
        formData.append('nombre_proceso', document.getElementById('proceso_nombre').value);
        formData.append('tipo_reunion', document.getElementById('tipo_reunion').value);
        formData.append('participantes_texto', document.getElementById('participantes_texto').value);
        formData.append('ubicacion', document.getElementById('ubicacion').value);
        formData.append('descripcion', document.getElementById('descripcion').value);
        formData.append('etiquetas', document.getElementById('etiquetas').value);
        formData.append('confidencial', document.getElementById('confidencial').checked);
        formData.append('fecha_reunion', document.getElementById('fecha_reunion').value);
        formData.append('archivo', selectedAudioFile);
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        // Datos de participantes detallados
        const participantsData = getParticipantsData();
        formData.append('participantes_detallados', JSON.stringify(participantsData));

        // Debug: mostrar los datos que se envían
        console.log('Datos del formulario:');
        for (let [key, value] of formData.entries()) {
            console.log(key, ':', value);
        }

        // Cambiar estado del botón
        processButton.disabled = true;
        processButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Procesando...';

        try {
            const response = await fetch('/audio/api/procesar/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });

            if (!response.ok) {
                // Si la respuesta HTTP no es exitosa, intentar obtener el mensaje de error
                const errorResult = await response.json();
                throw new Error(errorResult.message || `Error HTTP ${response.status}`);
            }

            const result = await response.json();

            if (result.status === 'success') {
                // Mostrar mensaje de éxito
                const alertHtml = `
                    <div class="alert alert-success alert-dismissible">
                        <button type="button" class="close" data-dismiss="alert">×</button>
                        <i class="fas fa-check-circle mr-2"></i>
                        Audio procesado exitosamente. ID: ${result.procesamiento_id}
                    </div>
                `;
                document.querySelector('.content').insertAdjacentHTML('afterbegin', alertHtml);
                
                // Limpiar formulario
                audioForm.reset();
                selectedAudioFile = null;
                selectedFileDiv.style.display = 'none';
                audioPlayer.style.display = 'none';
                
            } else {
                throw new Error(result.message || 'Error en el procesamiento');
            }

        } catch (error) {
            console.error('Error:', error);
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible">
                    <button type="button" class="close" data-dismiss="alert">×</button>
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Error al procesar el audio: ${error.message}
                </div>
            `;
            document.querySelector('.content').insertAdjacentHTML('afterbegin', alertHtml);
        } finally {
            // Restaurar botón
            processButton.disabled = false;
            processButton.innerHTML = '<i class="fas fa-play mr-2"></i>Procesar Audio';
        }
    });

    // ===== OBTENER CSRF TOKEN =====
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ===== ACTUALIZACIÓN AUTOMÁTICA DE DATOS =====
    function updateStats() {
        fetch('/audio/api/stats/')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Actualizar contadores
                    document.querySelector('.info-box-number').textContent = data.stats.total;
                    document.querySelectorAll('.info-box-number')[1].textContent = data.stats.completed;
                    document.querySelectorAll('.info-box-number')[2].textContent = data.stats.processing;
                    document.querySelectorAll('.info-box-number')[3].textContent = data.stats.error;
                }
            })
            .catch(error => console.error('Error actualizando estadísticas:', error));
    }

    function updateRecentProcesses() {
        fetch('/audio/api/recent-processes/')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const tbody = document.getElementById('recentProcesses');
                    
                    if (data.processes.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    No hay procesos recientes
                                </td>
                            </tr>
                        `;
                        return;
                    }

                    // Construir HTML de la tabla
                    let html = '';
                    data.processes.forEach(proceso => {
                        let estadoBadge = '';
                        let progresoBarra = '';
                        let acciones = '';

                        // Estado
                        switch(proceso.estado) {
                            case 'completado':
                                estadoBadge = '<span class="badge badge-success"><i class="fas fa-check mr-1"></i>Completado</span>';
                                progresoBarra = '<div class="progress progress-sm"><div class="progress-bar bg-success" style="width: 100%"></div></div><small class="text-success">100%</small>';
                                acciones = `<a href="/audio/detalle/${proceso.id}/" class="btn btn-info btn-sm" title="Ver detalle"><i class="fas fa-eye"></i></a>`;
                                break;
                            case 'procesando':
                                estadoBadge = '<span class="badge badge-warning"><i class="fas fa-spinner fa-spin mr-1"></i>Procesando</span>';
                                progresoBarra = '<div class="progress progress-sm"><div class="progress-bar bg-warning progress-bar-striped progress-bar-animated" style="width: 60%"></div></div><small class="text-warning">Procesando...</small>';
                                acciones = '<button class="btn btn-secondary btn-sm" disabled><i class="fas fa-clock"></i></button>';
                                break;
                            case 'transcribiendo':
                                estadoBadge = '<span class="badge badge-info"><i class="fas fa-file-alt mr-1"></i>Transcribiendo</span>';
                                progresoBarra = '<div class="progress progress-sm"><div class="progress-bar bg-info progress-bar-striped progress-bar-animated" style="width: 80%"></div></div><small class="text-info">Transcribiendo...</small>';
                                acciones = '<button class="btn btn-secondary btn-sm" disabled><i class="fas fa-clock"></i></button>';
                                break;
                            case 'error':
                                estadoBadge = '<span class="badge badge-danger"><i class="fas fa-exclamation-triangle mr-1"></i>Error</span>';
                                progresoBarra = '<div class="progress progress-sm"><div class="progress-bar bg-danger" style="width: 100%"></div></div><small class="text-danger">Error</small>';
                                acciones = `<a href="/audio/detalle/${proceso.id}/" class="btn btn-warning btn-sm" title="Ver error"><i class="fas fa-exclamation-circle"></i></a>`;
                                break;
                            default:
                                estadoBadge = '<span class="badge badge-secondary"><i class="fas fa-clock mr-1"></i>Pendiente</span>';
                                progresoBarra = '<div class="progress progress-sm"><div class="progress-bar bg-secondary" style="width: 10%"></div></div><small class="text-muted">En cola</small>';
                                acciones = '<button class="btn btn-secondary btn-sm" disabled><i class="fas fa-clock"></i></button>';
                        }

                        // Reproductor de audio
                        let audioPlayer = '<span class="text-muted"><i class="fas fa-times"></i> Sin audio</span>';
                        if (proceso.estado === 'completado' && proceso.audio_procesado_url) {
                            audioPlayer = `
                                <div class="audio-player-mini">
                                    <audio controls preload="none" style="width: 200px; height: 30px;">
                                        <source src="${proceso.audio_procesado_url}" type="audio/mpeg">
                                        <source src="${proceso.audio_procesado_url}" type="audio/wav">
                                        Tu navegador no soporta audio HTML5.
                                    </audio>
                                    <br><small class="text-muted">Audio procesado</small>
                                    ${proceso.duracion ? `<br><small class="text-info">${proceso.duracion}</small>` : ''}
                                    ${proceso.tamano_mb ? `<br><small class="text-info">${proceso.tamano_mb} MB</small>` : ''}
                                </div>
                            `;
                        } else if (proceso.audio_original_url) {
                            audioPlayer = `
                                <div class="audio-player-mini">
                                    <audio controls preload="none" style="width: 200px; height: 30px;">
                                        <source src="${proceso.audio_original_url}" type="audio/mpeg">
                                        <source src="${proceso.audio_original_url}" type="audio/wav">
                                        Tu navegador no soporta audio HTML5.
                                    </audio>
                                    <br><small class="text-muted">Audio original</small>
                                    ${proceso.duracion ? `<br><small class="text-info">${proceso.duracion}</small>` : ''}
                                    ${proceso.tamano_mb ? `<br><small class="text-info">${proceso.tamano_mb} MB</small>` : ''}
                                </div>
                            `;
                        }

                        html += `
                            <tr>
                                <td>
                                    <strong>${proceso.titulo || 'Sin título'}</strong>
                                    ${proceso.tipo_reunion ? `<br><small class="text-muted">${proceso.tipo_reunion}</small>` : ''}
                                </td>
                                <td>
                                    <span class="text-muted">${proceso.fecha}</span>
                                    <br><small>${proceso.hora}</small>
                                </td>
                                <td>${estadoBadge}</td>
                                <td>${progresoBarra}</td>
                                <td>${audioPlayer}</td>
                                <td><div class="btn-group btn-group-sm">${acciones}</div></td>
                            </tr>
                        `;
                    });

                    tbody.innerHTML = html;
                }
            })
            .catch(error => console.error('Error actualizando procesos recientes:', error));
    }

    // Actualizar datos cada 30 segundos
    setInterval(() => {
        updateStats();
        updateRecentProcesses();
    }, 30000);

    // Actualizar una vez al cargar
    setTimeout(() => {
        updateStats();
        updateRecentProcesses();
    }, 2000);

    // Botón de refrescar
    document.getElementById('refreshProcesses').addEventListener('click', function() {
        const button = this;
        const icon = button.querySelector('i');
        
        // Animación de loading
        icon.classList.add('fa-spin');
        button.disabled = true;
        
        // Actualizar datos
        Promise.all([updateStats(), updateRecentProcesses()])
            .finally(() => {
                setTimeout(() => {
                    icon.classList.remove('fa-spin');
                    button.disabled = false;
                }, 500);
            });
    });
});
</script>
{% endblock %}
