{% extends "layouts/base.html" %}
{% load static %}

{% block title %} Lista de Procesamientos de Audio {% endblock %}

{% block stylesheets %}
<!-- Estilos específicos para el widget de audio -->
<link rel="stylesheet" href="{% static 'css/audio_widget.css' %}">

<!-- Solo estilos mínimos necesarios, usando AdminLTE -->
<style>
.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
}
</style>
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock stylesheets %}

{% block content %}
<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-list text-primary"></i>
                        Lista de Procesamientos de Audio
                    </h1>
                    <p class="text-muted">Gestión completa de procesamientos de audio</p>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            
            <!-- Filtros -->
            <div class="card card-primary card-outline collapsed-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-filter"></i> Filtros de Búsqueda y Ordenación
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" onclick="toggleSeccionConEstado(this, 'filtrosSection')" title="Expandir filtros">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="filtrosSection" style="display: none;">
                    <form method="get" id="filtroForm">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="titulo">Buscar por título</label>
                                    <input type="text" class="form-control" id="titulo" name="titulo" 
                                           placeholder="Ingrese título..." value="{{ titulo_actual }}">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="tipo_reunion">Tipo de reunión</label>
                                    <select class="form-control" id="tipo_reunion" name="tipo_reunion">
                                        <option value="">-- Todos --</option>
                                        {% for tipo in tipos_reunion %}
                                        <option value="{{ tipo.id }}" {% if tipo_reunion_actual == tipo.id|stringformat:'s' %}selected{% endif %}>
                                            {{ tipo.nombre }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="estado">Estado</label>
                                    <select class="form-control" id="estado" name="estado">
                                        <option value="">-- Todos --</option>
                                        <option value="pendiente" {% if estado_actual == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                        <option value="procesando" {% if estado_actual == 'procesando' %}selected{% endif %}>Procesando</option>
                                        <option value="transcribiendo" {% if estado_actual == 'transcribiendo' %}selected{% endif %}>Transcribiendo</option>
                                        <option value="completado" {% if estado_actual == 'completado' %}selected{% endif %}>Completado</option>
                                        <option value="error" {% if estado_actual == 'error' %}selected{% endif %}>Error</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="fecha_desde">Fecha desde</label>
                                    <input type="date" class="form-control" id="fecha_desde" name="fecha_desde" value="{{ fecha_desde_actual }}">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="fecha_hasta">Fecha hasta</label>
                                    <input type="date" class="form-control" id="fecha_hasta" name="fecha_hasta" value="{{ fecha_hasta_actual }}">
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="submit" class="btn btn-primary btn-block" title="Aplicar filtros">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                        
                        <!-- Ocultar página actual para mantener filtros -->
                        {% if request.GET.page %}
                        <input type="hidden" name="page" value="{{ request.GET.page }}">
                        {% endif %}
                    </form>
                    
                    <!-- Ordenación -->
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <label for="orden">Ordenar por:</label>
                            <select class="form-control" name="orden" id="orden" onchange="cambiarOrden()">
                                <option value="-created_at" {% if orden_actual == "-created_at" %}selected{% endif %}>Fecha creación (reciente)</option>
                                <option value="created_at" {% if orden_actual == "created_at" %}selected{% endif %}>Fecha creación (antiguo)</option>
                                <option value="-fecha_reunion" {% if orden_actual == "-fecha_reunion" %}selected{% endif %}>Fecha reunión (reciente)</option>
                                <option value="fecha_reunion" {% if orden_actual == "fecha_reunion" %}selected{% endif %}>Fecha reunión (antiguo)</option>
                                <option value="titulo" {% if orden_actual == "titulo" %}selected{% endif %}>Título (A-Z)</option>
                                <option value="-titulo" {% if orden_actual == "-titulo" %}selected{% endif %}>Título (Z-A)</option>
                                <option value="tipo_reunion" {% if orden_actual == "tipo_reunion" %}selected{% endif %}>Tipo reunión (A-Z)</option>
                                <option value="-tipo_reunion" {% if orden_actual == "-tipo_reunion" %}selected{% endif %}>Tipo reunión (Z-A)</option>
                                <option value="estado" {% if orden_actual == "estado" %}selected{% endif %}>Estado (A-Z)</option>
                                <option value="-estado" {% if orden_actual == "-estado" %}selected{% endif %}>Estado (Z-A)</option>
                                <option value="-duracion" {% if orden_actual == "-duracion" %}selected{% endif %}>Duración (mayor)</option>
                                <option value="duracion" {% if orden_actual == "duracion" %}selected{% endif %}>Duración (menor)</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="button" onclick="limpiarFiltros()" class="btn btn-secondary" title="Limpiar filtros">
                                <i class="fas fa-times"></i> Limpiar Filtros
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Acciones rápidas y resultados -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <h5 class="text-muted">{{ total_procesamientos }} procesamiento(s) encontrado(s)</h5>
                </div>
                <div class="col-md-6 text-right">
                    <a href="{% url 'audio_processing:centro_audio' %}" class="btn btn-success">
                        <i class="fas fa-microphone"></i> Nueva Grabación
                    </a>
                    <a href="{% url 'audio_processing:centro_audio' %}" class="btn btn-info">
                        <i class="fas fa-upload"></i> Subir Archivo
                    </a>
                </div>
            </div>
            
            <!-- Widget Reproductor de Audio -->
            <div class="card card-outline card-primary" id="audioPlayerWidget" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-play text-primary"></i> Reproductor de Audio
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" onclick="
                            console.log('Close button clicked');
                            var widget = document.getElementById('audioPlayerWidget');
                            var player = document.getElementById('audioPlayer');
                            if (widget && player) {
                                player.pause();
                                player.src = '';
                                widget.style.display = 'none';
                            }
                        " title="Cerrar reproductor">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <audio id="audioPlayer" controls class="w-100" preload="metadata">
                                Tu navegador no soporta la reproducción de audio.
                            </audio>
                        </div>
                        <div class="col-md-4">
                            <div id="audioInfo">
                                <h6 id="audioTitle" class="text-primary">Ningún audio seleccionado</h6>
                                <small id="audioDetails" class="text-muted">Haz clic en el botón Play de cualquier procesamiento para reproducir</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grid de procesamientos -->
            {% if page_obj %}
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-th-large"></i> Lista de Procesamientos de Audio
                    </h3>
                    <div class="card-tools">
                        <span class="badge badge-info">{{ total_procesamientos }} procesamiento(s)</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for procesamiento in page_obj %}
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card h-100 card-outline {% if procesamiento.estado == 'completado' %}card-success{% elif procesamiento.estado == 'error' %}card-danger{% elif procesamiento.estado in 'procesando,transcribiendo,diarizando' %}card-primary{% else %}card-warning{% endif %}">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-file-audio text-info"></i>
                                        {{ procesamiento.titulo|truncatechars:25 }}
                                    </h5>
                                    <div class="card-tools">
                                        <span class="badge badge-success">
                                            <i class="fas fa-check"></i> {{ procesamiento.estado }}
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Información básica -->
                                    <div class="mb-2">
                                        <strong>Tipo:</strong> 
                                        <span class="badge badge-secondary">{{ procesamiento.tipo_reunion.nombre }}</span>
                                    </div>
                                    
                                    <!-- Fechas -->
                                    <div class="mb-2 small text-muted">
                                        <i class="fas fa-calendar"></i> Creado: {{ procesamiento.created_at|date:"d/m/Y H:i" }}
                                        {% if procesamiento.fecha_reunion %}
                                            <br><i class="fas fa-calendar-check"></i> Reunión: {{ procesamiento.fecha_reunion|date:"d/m/Y" }}
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Duración -->
                                    {% if procesamiento.duracion_seg %}
                                    <div class="mb-2">
                                        <strong>Duración:</strong> 
                                        <i class="fas fa-clock text-muted"></i> {{ procesamiento.duracion_seg|floatformat:0 }}s
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer">
                                    <div class="btn-group w-100" role="group">
                                        <a href="{% url 'audio_processing:detalle_procesamiento' procesamiento.id %}" 
                                           class="btn btn-sm btn-info flex-fill" title="Ver detalles">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if procesamiento.archivo_audio %}
                                            <button type="button" class="btn btn-sm btn-primary flex-fill" 
                                                    onclick="
                                                        console.log('Button clicked'); 
                                                        var widget = document.getElementById('audioPlayerWidget');
                                                        var player = document.getElementById('audioPlayer');
                                                        var title = document.getElementById('audioTitle');
                                                        var details = document.getElementById('audioDetails');
                                                        
                                                        if (widget && player && title && details) {
                                                            widget.style.display = 'block';
                                                            player.src = '{{ procesamiento.archivo_audio.url }}';
                                                            player.load();
                                                            title.innerHTML = '<i class=&quot;fas fa-music&quot;></i> {{ procesamiento.titulo|escapejs }}';
                                                            details.innerHTML = '<small class=&quot;text-info&quot;>Audio: {{ procesamiento.archivo_audio.url }}</small>';
                                                            widget.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                                            player.play().catch(function(e) { console.log('Auto-play blocked:', e); });
                                                        } else {
                                                            alert('Error: elementos no encontrados');
                                                        }
                                                    " 
                                                    title="Reproducir audio">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        {% endif %}
                                        <a href="{% url 'audio_processing:editar_procesamiento' procesamiento.id %}" 
                                           class="btn btn-sm btn-warning flex-fill" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No se encontraron procesamientos</h5>
                        <a href="{% url 'audio_processing:centro_audio' %}" class="btn btn-primary">
                            <i class="fas fa-arrow-left"></i> Volver al Centro de Audio
                        </a>
                    </div>
                </div>
            {% endif %}

            <!-- Paginación -->
            {% if page_obj.has_other_pages %}
            <div class="card">
                <div class="card-body">
                    <nav aria-label="Paginación">
                        <ul class="pagination justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" title="Primera página">
                                    &laquo; Primera
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" title="Página anterior">
                                    Anterior
                                </a>
                            </li>
                            {% endif %}
                            {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                            </li>
                            {% endif %}
                            {% endfor %}
                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" title="Página siguiente">
                                    Siguiente
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" title="Última página">
                                    Última &raquo;
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
            {% endif %}

        </div>
    </section>
</div>

<script>
// Funcionalidad para filtros y ordenación
function limpiarFiltros() {
    window.location.href = window.location.pathname;
}

function cambiarOrden() {
    var ordenSelect = document.getElementById('orden');
    var ordenValue = ordenSelect.value;
    
    // Construir URL con parámetros actuales
    var url = new URL(window.location);
    if (ordenValue) {
        url.searchParams.set('orden', ordenValue);
    } else {
        url.searchParams.delete('orden');
    }
    url.searchParams.delete('page'); // Reset página al cambiar orden
    
    window.location.href = url.toString();
}

// Funcionalidad para colapsar/expandir secciones
function toggleSeccion(button, targetId) {
    var target = document.getElementById(targetId);
    var icon = button.querySelector('i');
    
    if (target.style.display === 'none' || target.style.display === '') {
        target.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
        button.setAttribute('aria-expanded', 'true');
    } else {
        target.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
        button.setAttribute('aria-expanded', 'false');
    }
}

// Auto-submit del formulario al cambiar campos de filtro
document.addEventListener('DOMContentLoaded', function() {
    // Configurar auto-submit para campos de fecha
    var fechaDesde = document.getElementById('fecha_desde');
    var fechaHasta = document.getElementById('fecha_hasta');
    
    if (fechaDesde) {
        fechaDesde.addEventListener('change', function() {
            if (this.value) {
                document.getElementById('filtroForm').submit();
            }
        });
    }
    
    if (fechaHasta) {
        fechaHasta.addEventListener('change', function() {
            if (this.value) {
                document.getElementById('filtroForm').submit();
            }
        });
    }
    
    // Estado inicial de secciones colapsables
    var filtrosSection = document.getElementById('filtrosSection');
    var estadisticasSection = document.getElementById('estadisticasSection');
    
    // Mantener estado de localStorage si existe
    if (localStorage.getItem('filtrosVisible') === 'false') {
        filtrosSection.style.display = 'none';
        document.querySelector('[onclick*="filtrosSection"] i').className = 'fas fa-chevron-down';
    }
    
    if (localStorage.getItem('estadisticasVisible') === 'false') {
        estadisticasSection.style.display = 'none';
        document.querySelector('[onclick*="estadisticasSection"] i').className = 'fas fa-chevron-down';
    }
});

// Guardar estado de secciones en localStorage
function toggleSeccionConEstado(button, targetId) {
    toggleSeccion(button, targetId);
    
    var target = document.getElementById(targetId);
    var visible = target.style.display !== 'none';
    
    if (targetId === 'filtrosSection') {
        localStorage.setItem('filtrosVisible', visible);
    } else if (targetId === 'estadisticasSection') {
        localStorage.setItem('estadisticasVisible', visible);
    }
}
</script>

{% endblock content %}

{% block javascripts %}
<script>
console.log('JavaScript inline funcionando');
console.log('DOM elements check:', {
    audioPlayerWidget: !!document.getElementById('audioPlayerWidget'),
    audioPlayer: !!document.getElementById('audioPlayer'),
    audioTitle: !!document.getElementById('audioTitle'),
    audioDetails: !!document.getElementById('audioDetails')
});
</script>
{% endblock javascripts %}