{% extends "layouts/base.html" %}
{% load static %}

{% block title %}Centrodasda de Procesamiento de Audio - {{ title }}{% endblock %}

{% block stylesheets %}
<style>
/* ===== VARIABLES CSS ===== */
:root {
    --primary-color: #3B82F6;
    --secondary-color: #1E40AF;
    --success-color: #10B981;
    --warning-color: #F59E0B;
    --error-color: #EF4444;
    --dark-color: #1F2937;
    --light-color: #F8FAFC;
    --border-radius: 12px;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
    --shadow-lg: 0 8px 25px rgba(0,0,0,0.2);
}

/* ===== LAYOUT PRINCIPAL ===== */
.audio-center {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 2rem 0;
}

.container-fluid {
    max-width: 1400px;
}

/* ===== HEADER SECTION ===== */
.audio-header {
    text-align: center;
    margin-bottom: 3rem;
    color: white;
}

.audio-header h1 {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.audio-header p {
    font-size: 1.2rem;
    opacity: 0.9;
    max-width: 600px;
    margin: 0 auto;
}

/* ===== STATS CARDS ===== */
.stats-section {
    margin-bottom: 3rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.stat-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: var(--border-radius);
    padding: 2rem;
    text-align: center;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-lg);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 1.5rem;
    color: white;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--dark-color);
}

.stat-label {
    color: #6B7280;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
}

.stat-total .stat-icon { background: var(--primary-color); }
.stat-completed .stat-icon { background: var(--success-color); }
.stat-processing .stat-icon { background: var(--warning-color); }
.stat-error .stat-icon { background: var(--error-color); }

/* ===== MAIN ACTIONS SECTION ===== */
.actions-section {
    margin-bottom: 3rem;
}

.actions-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

.action-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: var(--border-radius);
    padding: 2.5rem;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.action-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
}

.action-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
}

.action-header {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
}

.action-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
    font-size: 1.2rem;
    color: white;
}

.action-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--dark-color);
    margin: 0;
}

.action-description {
    color: #6B7280;
    margin-bottom: 2rem;
    line-height: 1.6;
}

/* ===== RECORDING SECTION ===== */
.recording-card .action-icon {
    background: linear-gradient(135deg, #EF4444, #DC2626);
}

.recording-controls {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.record-button {
    background: linear-gradient(135deg, #EF4444, #DC2626);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.record-button:hover {
    background: linear-gradient(135deg, #DC2626, #B91C1C);
    transform: scale(1.02);
}

.record-button.recording {
    background: linear-gradient(135deg, #F59E0B, #D97706);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
    50% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
}

.recording-status {
    text-align: center;
    padding: 1rem;
    background: rgba(239, 68, 68, 0.1);
    border-radius: var(--border-radius);
    color: var(--error-color);
    font-weight: 600;
    display: none;
}

.recording-timer {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--error-color);
}

/* ===== UPLOAD SECTION ===== */
.upload-card .action-icon {
    background: linear-gradient(135deg, #3B82F6, #1D4ED8);
}

.upload-zone {
    border: 2px dashed #D1D5DB;
    border-radius: var(--border-radius);
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    background: rgba(59, 130, 246, 0.05);
}

.upload-zone:hover {
    border-color: var(--primary-color);
    background: rgba(59, 130, 246, 0.1);
}

.upload-zone.drag-over {
    border-color: var(--primary-color);
    background: rgba(59, 130, 246, 0.2);
    transform: scale(1.02);
}

.upload-icon {
    font-size: 3rem;
    color: var(--primary-color);
    margin-bottom: 1rem;
}

.upload-text {
    color: var(--dark-color);
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.upload-hint {
    color: #6B7280;
    font-size: 0.9rem;
}

#fileInput {
    display: none;
}

/* ===== FORM SECTION ===== */
.form-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: var(--border-radius);
    padding: 2.5rem;
    box-shadow: var(--shadow-md);
    margin-bottom: 2rem;
}

.form-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--dark-color);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
}

.form-title i {
    margin-right: 0.5rem;
    color: var(--primary-color);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--dark-color);
}

.form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #E5E7EB;
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
}

/* ===== PROCESS BUTTON ===== */
.process-button {
    width: 100%;
    background: linear-gradient(135deg, var(--success-color), #059669);
    color: white;
    border: none;
    border-radius: var(--border-radius);
    padding: 1rem 2rem;
    font-size: 1.2rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.process-button:hover {
    background: linear-gradient(135deg, #059669, #047857);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.process-button:disabled {
    background: #9CA3AF;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.process-button .spinner {
    display: none;
    margin-right: 0.5rem;
}

.process-button.processing .spinner {
    display: inline-block;
}

/* ===== RECENT PROCESSES ===== */
.recent-section {
    margin-top: 3rem;
}

.recent-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: var(--border-radius);
    padding: 2rem;
    box-shadow: var(--shadow-md);
}

.recent-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.recent-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--dark-color);
    margin: 0;
}

.recent-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.recent-item {
    background: white;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}

.recent-item:hover {
    transform: translateX(5px);
    box-shadow: var(--shadow-md);
}

.recent-item.completed {
    border-left-color: var(--success-color);
}

.recent-item.processing {
    border-left-color: var(--warning-color);
}

.recent-item.error {
    border-left-color: var(--error-color);
}

.item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.item-title {
    font-weight: 600;
    color: var(--dark-color);
}

.item-status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-completed {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-color);
}

.status-processing {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning-color);
}

.status-error {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error-color);
}

.item-details {
    color: #6B7280;
    font-size: 0.9rem;
}

/* ===== PROGRESS BAR ===== */
.progress-container {
    background: #F3F4F6;
    border-radius: 10px;
    height: 8px;
    margin: 0.5rem 0;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), var(--success-color));
    border-radius: 10px;
    transition: width 0.3s ease;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .actions-grid {
        grid-template-columns: 1fr;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .audio-header h1 {
        font-size: 2rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .action-card {
        padding: 1.5rem;
    }
    
    .form-card {
        padding: 1.5rem;
    }
}

/* ===== ANIMATIONS ===== */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in-up {
    animation: fadeInUp 0.6s ease-out;
}

/* ===== AUDIO PLAYER ===== */
.audio-player {
    background: white;
    border-radius: var(--border-radius);
    padding: 1rem;
    margin-top: 1rem;
    box-shadow: var(--shadow-sm);
    display: none;
}

.audio-player audio {
    width: 100%;
}

/* ===== SUCCESS/ERROR MESSAGES ===== */
.alert {
    padding: 1rem 1.5rem;
    border-radius: var(--border-radius);
    margin-bottom: 1rem;
    font-weight: 600;
}

.alert-success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-color);
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.alert-error {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error-color);
    border: 1px solid rgba(239, 68, 68, 0.2);
}

.alert-warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning-color);
    border: 1px solid rgba(245, 158, 11, 0.2);
}
</style>
{% endblock %}

{% block content %}
<div class="audio-center">
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="audio-header fade-in-up">
            <h1><i class="fas fa-microphone-alt"></i> Centro dsadde Procesamiento de Audio</h1>
            <p>Graba, sube y procesa archivos de audio con tecnología avanzada de IA para transcripción y análisis</p>
        </div>

        <!-- Stats Section -->
        <div class="stats-section fade-in-up">
            <div class="stats-grid">
                <div class="stat-card stat-total">
                    <div class="stat-icon">
                        <i class="fas fa-file-audio"></i>
                    </div>
                    <div class="stat-number" id="totalProcesses">{{ stats.total|default:0 }}</div>
                    <div class="stat-label">Total Procesamientos</div>
                </div>
                <div class="stat-card stat-completed">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-number" id="completedProcesses">{{ stats.completed|default:0 }}</div>
                    <div class="stat-label">Completados</div>
                </div>
                <div class="stat-card stat-processing">
                    <div class="stat-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    <div class="stat-number" id="processingProcesses">{{ stats.processing|default:0 }}</div>
                    <div class="stat-label">En Proceso</div>
                </div>
                <div class="stat-card stat-error">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-number" id="errorProcesses">{{ stats.error|default:0 }}</div>
                    <div class="stat-label">Con Errores</div>
                </div>
            </div>
        </div>

        <!-- Main Actions Section -->
        <div class="actions-section fade-in-up">
            <div class="actions-grid">
                <!-- Recording Card -->
                <div class="action-card recording-card">
                    <div class="action-header">
                        <div class="action-icon">
                            <i class="fas fa-microphone"></i>
                        </div>
                        <h3 class="action-title">Grabar Audio en Vivo</h3>
                    </div>
                    <p class="action-description">
                        Graba audio directamente desde tu micrófono con calidad profesional. El sistema procesará automáticamente el audio.
                    </p>
                    
                    <div class="recording-controls">
                        <button type="button" class="record-button" id="recordButton">
                            <i class="fas fa-play"></i> Iniciar Grabación
                        </button>
                        <div class="recording-status" id="recordingStatus">
                            <div class="recording-timer" id="recordingTimer">00:00</div>
                            <div>Grabando... Presiona detener cuando termines</div>
                        </div>
                    </div>
                    
                    <div class="audio-player" id="recordedAudioPlayer">
                        <audio controls id="recordedAudio"></audio>
                    </div>
                </div>

                <!-- Upload Card -->
                <div class="action-card upload-card">
                    <div class="action-header">
                        <div class="action-icon">
                            <i class="fas fa-upload"></i>
                        </div>
                        <h3 class="action-title">Subir Archivo de Audio</h3>
                    </div>
                    <p class="action-description">
                        Arrastra y suelta o selecciona archivos de audio (MP3, WAV, M4A, OGG) para procesar con nuestro pipeline avanzado.
                    </p>
                    
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">Arrastra archivos aquí o haz clic para seleccionar</div>
                        <div class="upload-hint">Formatos soportados: MP3, WAV, M4A, OGG (máx. 100MB)</div>
                        <input type="file" id="fileInput" accept="audio/*" multiple>
                    </div>
                    
                    <div class="audio-player" id="uploadedAudioPlayer">
                        <audio controls id="uploadedAudio"></audio>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Section -->
        <div class="form-card fade-in-up">
            <h3 class="form-title">
                <i class="fas fa-cogs"></i>
                Configuración del Procesamiento
            </h3>
            
            <form id="audioProcessForm">
                {% csrf_token %}
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="proceso_nombre">
                            <i class="fas fa-tag"></i> Nombre del Proceso
                        </label>
                        <input type="text" class="form-control" id="proceso_nombre" name="proceso_nombre" 
                               placeholder="Ej: Reunión de equipo - 7 Sep 2025" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="tipo_reunion">
                            <i class="fas fa-users"></i> Tipo de Reunión
                        </label>
                        <select class="form-control form-select" id="tipo_reunion" name="tipo_reunion" required>
                            <option value="">Seleccionar tipo...</option>
                            {% if tipos_reunion %}
                                {% for tipo in tipos_reunion %}
                                <option value="{{ tipo.id }}">{{ tipo.nombre }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="" disabled>No hay tipos de reunión, contacte al administrador</option>
                            {% endif %}
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="participantes">
                            <i class="fas fa-user-friends"></i> Participantes
                        </label>
                        <input type="text" class="form-control" id="participantes" name="participantes" 
                               placeholder="Ej: Juan Pérez, María García, Carlos López">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="ubicacion">
                            <i class="fas fa-map-marker-alt"></i> Ubicación
                        </label>
                        <input type="text" class="form-control" id="ubicacion" name="ubicacion" 
                               placeholder="Ej: Sala de reuniones A, Oficina principal">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="descripcion">
                        <i class="fas fa-align-left"></i> Descripción / Agenda
                    </label>
                    <textarea class="form-control form-textarea" id="descripcion" name="descripcion" 
                              placeholder="Describe brevemente el contenido de la reunión o proceso..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="etiquetas">
                            <i class="fas fa-tags"></i> Etiquetas
                        </label>
                        <input type="text" class="form-control" id="etiquetas" name="etiquetas" 
                               placeholder="Ej: importante, urgente, proyecto-x (separadas por comas)">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="confidencial">
                            <i class="fas fa-lock"></i> Confidencialidad
                        </label>
                        <select class="form-control form-select" id="confidencial" name="confidencial">
                            <option value="false">Público</option>
                            <option value="true">Confidencial</option>
                        </select>
                    </div>
                </div>
                
                <button type="submit" class="process-button" id="processButton">
                    <i class="fas fa-spinner fa-spin spinner"></i>
                    <i class="fas fa-play"></i>
                    Iniciar Procesamiento
                </button>
            </form>
        </div>

        <!-- Recent Processes Section -->
        <div class="recent-section fade-in-up">
            <div class="recent-card">
                <div class="recent-header">
                    <h3 class="recent-title">
                        <i class="fas fa-history"></i> Procesamientos Recientes
                    </h3>
                    <a href="{% url 'audio_processing:lista_procesamientos' %}" class="btn btn-outline-primary">
                        <i class="fas fa-list"></i> Ver Todos
                    </a>
                </div>
                
                <div class="recent-list" id="recentProcesses">
                    {% if recent_processes %}
                        {% for proceso in recent_processes %}
                        <div class="recent-item {{ proceso.estado }}">
                            <div class="item-header">
                                <div class="item-title">{{ proceso.nombre_proceso }}</div>
                                <div class="item-status status-{{ proceso.estado }}">
                                    {{ proceso.get_estado_display }}
                                </div>
                            </div>
                            <div class="item-details">
                                <i class="fas fa-calendar"></i> {{ proceso.created_at|date:"d M Y H:i" }}
                                {% if proceso.duracion_seg %}
                                    | <i class="fas fa-clock"></i> {{ proceso.duracion_formateada }}
                                {% endif %}
                                {% if proceso.progreso < 100 and proceso.estado == 'procesando' %}
                                    <div class="progress-container">
                                        <div class="progress-bar" style="width: {{ proceso.progreso }}%">
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No hay procesamientos aún. ¡Comienza grabando o subiendo tu primer archivo!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<div id="messageContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>
{% endblock %}

{% block javascripts %}
<script>
// ===== VARIABLES GLOBALES =====
let mediaRecorder;
let recordedChunks = [];
let isRecording = false;
let recordingStartTime;
let recordingTimer;
let currentAudioFile = null;
let currentAudioSource = null; // 'recording' o 'upload'

// ===== INICIALIZACIÓN =====
document.addEventListener('DOMContentLoaded', function() {
    initializeUploadZone();
    initializeRecording();
    initializeForm();
    loadStats();
    loadRecentProcesses();
    
    // Actualizar stats cada 10 segundos
    setInterval(loadStats, 10000);
    
    // Actualizar procesos recientes cada 15 segundos
    setInterval(loadRecentProcesses, 15000);
});

// ===== MANEJO DE ARCHIVOS =====
function initializeUploadZone() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    
    // Click en zona de subida
    uploadZone.addEventListener('click', () => {
        fileInput.click();
    });
    
    // Cambio en input de archivo
    fileInput.addEventListener('change', handleFileSelect);
    
    // Drag and drop
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
    });
    
    uploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
    });
    
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect({ target: { files } });
        }
    });
}

function handleFileSelect(event) {
    const files = event.target.files;
    if (files.length === 0) return;
    
    const file = files[0];
    
    // Validar tipo de archivo
    const allowedTypes = ['audio/mp3', 'audio/mpeg', 'audio/wav', 'audio/m4a', 'audio/ogg'];
    if (!allowedTypes.includes(file.type) && !file.name.match(/\.(mp3|wav|m4a|ogg)$/i)) {
        showMessage('Por favor selecciona un archivo de audio válido (MP3, WAV, M4A, OGG)', 'error');
        return;
    }
    
    // Validar tamaño (100MB)
    if (file.size > 100 * 1024 * 1024) {
        showMessage('El archivo es demasiado grande. Máximo 100MB permitido.', 'error');
        return;
    }
    
    currentAudioFile = file;
    currentAudioSource = 'upload';
    
    // Mostrar reproductor
    const audioPlayer = document.getElementById('uploadedAudioPlayer');
    const audio = document.getElementById('uploadedAudio');
    const url = URL.createObjectURL(file);
    audio.src = url;
    audioPlayer.style.display = 'block';
    
    // Actualizar zona de subida
    const uploadZone = document.getElementById('uploadZone');
    uploadZone.innerHTML = `
        <div class="upload-icon" style="color: var(--success-color);">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="upload-text">Archivo seleccionado: ${file.name}</div>
        <div class="upload-hint">Tamaño: ${(file.size / 1024 / 1024).toFixed(2)} MB</div>
    `;
    
    showMessage('Archivo cargado correctamente. Completa el formulario y presiona "Iniciar Procesamiento".', 'success');
}

// ===== GRABACIÓN DE AUDIO =====
function initializeRecording() {
    const recordButton = document.getElementById('recordButton');
    recordButton.addEventListener('click', toggleRecording);
}

async function toggleRecording() {
    if (!isRecording) {
        await startRecording();
    } else {
        stopRecording();
    }
}

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        mediaRecorder = new MediaRecorder(stream);
        recordedChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'audio/wav' });
            currentAudioFile = new File([blob], `grabacion_${Date.now()}.wav`, { type: 'audio/wav' });
            currentAudioSource = 'recording';
            
            // Mostrar reproductor
            const audioPlayer = document.getElementById('recordedAudioPlayer');
            const audio = document.getElementById('recordedAudio');
            const url = URL.createObjectURL(blob);
            audio.src = url;
            audioPlayer.style.display = 'block';
            
            showMessage('Grabación completada. Completa el formulario y presiona "Iniciar Procesamiento".', 'success');
        };
        
        mediaRecorder.start();
        isRecording = true;
        recordingStartTime = Date.now();
        
        // Actualizar UI
        updateRecordingUI();
        
        // Iniciar timer
        recordingTimer = setInterval(updateRecordingTimer, 1000);
        
    } catch (error) {
        console.error('Error accessing microphone:', error);
        showMessage('Error al acceder al micrófono. Verifica los permisos.', 'error');
    }
}

function stopRecording() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        
        // Detener el stream
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        
        // Limpiar timer
        clearInterval(recordingTimer);
        
        // Actualizar UI
        updateRecordingUI();
    }
}

function updateRecordingUI() {
    const recordButton = document.getElementById('recordButton');
    const recordingStatus = document.getElementById('recordingStatus');
    
    if (isRecording) {
        recordButton.innerHTML = '<i class="fas fa-stop"></i> Detener Grabación';
        recordButton.classList.add('recording');
        recordingStatus.style.display = 'block';
    } else {
        recordButton.innerHTML = '<i class="fas fa-play"></i> Iniciar Grabación';
        recordButton.classList.remove('recording');
        recordingStatus.style.display = 'none';
    }
}

function updateRecordingTimer() {
    if (!isRecording) return;
    
    const elapsed = Date.now() - recordingStartTime;
    const seconds = Math.floor(elapsed / 1000);
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    
    const timerDisplay = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    document.getElementById('recordingTimer').textContent = timerDisplay;
}

// ===== FORMULARIO Y PROCESAMIENTO =====
function initializeForm() {
    const form = document.getElementById('audioProcessForm');
    form.addEventListener('submit', handleFormSubmit);
}

async function handleFormSubmit(event) {
    event.preventDefault();
    
    // Validar que hay un archivo
    if (!currentAudioFile) {
        showMessage('Por favor graba audio o sube un archivo antes de procesar.', 'warning');
        return;
    }
    
    // Validar campos requeridos
    const requiredFields = ['proceso_nombre', 'tipo_reunion'];
    let isValid = true;
    
    requiredFields.forEach(fieldName => {
        const field = document.getElementById(fieldName);
        if (!field.value.trim()) {
            field.style.borderColor = 'var(--error-color)';
            isValid = false;
        } else {
            field.style.borderColor = '#E5E7EB';
        }
    });
    
    if (!isValid) {
        showMessage('Por favor completa todos los campos requeridos.', 'warning');
        return;
    }
    
    // Mostrar estado de procesamiento
    const processButton = document.getElementById('processButton');
    processButton.classList.add('processing');
    processButton.disabled = true;
    
    try {
        // Crear FormData
        const formData = new FormData();
        formData.append('archivo', currentAudioFile);
        formData.append('nombre_proceso', document.getElementById('proceso_nombre').value);
        formData.append('tipo_reunion', document.getElementById('tipo_reunion').value);
        formData.append('participantes', document.getElementById('participantes').value);
        formData.append('ubicacion', document.getElementById('ubicacion').value);
        formData.append('descripcion', document.getElementById('descripcion').value);
        formData.append('etiquetas', document.getElementById('etiquetas').value);
        formData.append('confidencial', document.getElementById('confidencial').value);
        formData.append('source', currentAudioSource);
        
        // Enviar a la API
        const response = await fetch('{% url "audio_processing:api_procesar_audio" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const result = await response.json();
        
        if (response.ok && result.status === 'success') {
            showMessage('¡Procesamiento iniciado exitosamente! Se está procesando en segundo plano.', 'success');
            
            // Limpiar formulario
            resetForm();
            
            // Actualizar stats y procesos recientes
            setTimeout(() => {
                loadStats();
                loadRecentProcesses();
            }, 1000);
            
        } else {
            throw new Error(result.message || 'Error al procesar el archivo');
        }
        
    } catch (error) {
        console.error('Error:', error);
        showMessage(`Error al procesar: ${error.message}`, 'error');
    } finally {
        // Restaurar botón
        processButton.classList.remove('processing');
        processButton.disabled = false;
    }
}

function resetForm() {
    // Limpiar formulario
    document.getElementById('audioProcessForm').reset();
    
    // Limpiar archivos
    currentAudioFile = null;
    currentAudioSource = null;
    
    // Ocultar reproductores
    document.getElementById('recordedAudioPlayer').style.display = 'none';
    document.getElementById('uploadedAudioPlayer').style.display = 'none';
    
    // Restaurar zona de subida
    const uploadZone = document.getElementById('uploadZone');
    uploadZone.innerHTML = `
        <div class="upload-icon">
            <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <div class="upload-text">Arrastra archivos aquí o haz clic para seleccionar</div>
        <div class="upload-hint">Formatos soportados: MP3, WAV, M4A, OGG (máx. 100MB)</div>
        <input type="file" id="fileInput" accept="audio/*" multiple>
    `;
    
    // Reinicializar eventos
    initializeUploadZone();
}

// ===== CARGA DE DATOS =====
async function loadStats() {
    try {
    const response = await fetch('{% url "audio_processing:api_stats" %}', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const stats = await response.json();
            document.getElementById('totalProcesses').textContent = stats.total || 0;
            document.getElementById('completedProcesses').textContent = stats.completed || 0;
            document.getElementById('processingProcesses').textContent = stats.processing || 0;
            document.getElementById('errorProcesses').textContent = stats.error || 0;
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadRecentProcesses() {
    try {
    const response = await fetch('{% url "audio_processing:api_recent_processes" %}', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const processes = await response.json();
            updateRecentProcessesList(processes);
        }
    } catch (error) {
        console.error('Error loading recent processes:', error);
    }
}

function updateRecentProcessesList(processes) {
    const container = document.getElementById('recentProcesses');
    
    if (processes.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted">No hay procesamientos aún. ¡Comienza grabando o subiendo tu primer archivo!</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = processes.map(proceso => `
        <div class="recent-item ${proceso.estado}">
            <div class="item-header">
                <div class="item-title">${proceso.nombre_proceso}</div>
                <div class="item-status status-${proceso.estado}">
                    ${proceso.estado_display}
                </div>
            </div>
            <div class="item-details">
                <i class="fas fa-calendar"></i> ${proceso.created_at}
                ${proceso.duracion ? `| <i class="fas fa-clock"></i> ${proceso.duracion}` : ''}
                ${proceso.progreso < 100 && proceso.estado === 'procesando' ? 
                    `<div class="progress-container">
                        <div class="progress-bar" style="width: ${proceso.progreso}%"></div>
                    </div>` : ''
                }
            </div>
        </div>
    `).join('');
}

// ===== UTILIDADES =====
function showMessage(message, type = 'info') {
    const container = document.getElementById('messageContainer');
    const messageId = Date.now();
    
    const messageElement = document.createElement('div');
    messageElement.className = `alert alert-${type}`;
    messageElement.style.marginBottom = '10px';
    messageElement.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
        <button type="button" style="float: right; background: none; border: none; font-size: 1.2em; color: inherit; cursor: pointer;" onclick="this.parentElement.remove()">×</button>
    `;
    
    container.appendChild(messageElement);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (messageElement.parentElement) {
            messageElement.remove();
        }
    }, 5000);
}

// ===== MANEJO DE ERRORES GLOBALES =====
window.addEventListener('error', function(event) {
    console.error('Error global:', event.error);
});

window.addEventListener('unhandledrejection', function(event) {
    console.error('Promise rejection:', event.reason);
});
</script>
{% endblock %}
