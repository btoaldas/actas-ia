{% extends "layouts/base.html" %}
{% load static %}

{% block title %} Detalle de Procesamiento - {{ procesamiento.titulo }} {% endblock %}

{% block stylesheets %}
<!-- WaveSurfer.js CSS -->
<style>
.detail-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.info-card {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.audio-comparison {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.audio-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.waveform-container {
    background: #ffffff;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
    min-height: 120px;
}

.audio-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 1rem;
    flex-wrap: wrap;
}

.control-button {
    background: #007bff;
    color: white;
    border: none;
    border-radius: 25px;
    padding: 8px 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
}

.control-button:hover {
    background: #0056b3;
    transform: translateY(-1px);
}

.control-button:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
}

.play-btn { background: #28a745; }
.pause-btn { background: #ffc107; color: #000; }
.stop-btn { background: #dc3545; }
.download-btn { background: #17a2b8; }

.play-btn:hover { background: #1e7e34; }
.pause-btn:hover { background: #e0a800; }
.stop-btn:hover { background: #c82333; }
.download-btn:hover { background: #138496; }

.audio-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.stat-item {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #e9ecef;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    font-size: 0.9rem;
    color: #6c757d;
    margin-top: 0.5rem;
}

.comparison-title {
    background: linear-gradient(90deg, #007bff, #28a745);
    color: white;
    padding: 1rem;
    border-radius: 10px;
    text-align: center;
    margin-bottom: 2rem;
    font-size: 1.5rem;
    font-weight: bold;
}

.vs-divider {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 2rem 0;
}

.vs-text {
    background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
    color: white;
    padding: 1rem 2rem;
    border-radius: 50px;
    font-size: 1.2rem;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 2rem;
}

.action-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 25px;
    font-weight: bold;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.btn-start { background: #28a745; color: white; }
.btn-stop { background: #dc3545; color: white; }
.btn-restart { background: #007bff; color: white; }
.btn-delete { background: #6c757d; color: white; }

.btn-start:hover { background: #1e7e34; color: white; transform: translateY(-2px); }
.btn-stop:hover { background: #c82333; color: white; transform: translateY(-2px); }
.btn-restart:hover { background: #0056b3; color: white; transform: translateY(-2px); }
.btn-delete:hover { background: #545b62; color: white; transform: translateY(-2px); }

.log-entry {
    border-left: 3px solid #007bff;
    padding: 0.8rem;
    margin-bottom: 0.5rem;
    background: #f8f9fa;
    border-radius: 0 8px 8px 0;
}

.log-entry.error {
    border-left-color: #dc3545;
    background: #fff5f5;
}

.log-entry.warning {
    border-left-color: #ffc107;
    background: #fffdf0;
}

.log-entry.info {
    border-left-color: #28a745;
    background: #f0fff4;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: bold;
    font-size: 1rem;
}

.status-pendiente { background: #fff3cd; color: #856404; }
.status-procesando { background: #d1ecf1; color: #0c5460; }
.status-completado { background: #d4edda; color: #155724; }
.status-error { background: #f8d7da; color: #721c24; }
.status-cancelado { background: #e2e3e5; color: #383d41; }

.progress-container {
    background: #e9ecef;
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    margin: 1rem 0;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #007bff, #28a745);
    border-radius: 10px;
    transition: width 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

@media (max-width: 768px) {
    .audio-controls {
        justify-content: center;
    }
    
    .action-buttons {
        justify-content: center;
    }
    
    .audio-stats {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock stylesheets %}

{% block content %}

<div class="content-wrapper">
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-waveform text-primary"></i>
                        Detalle de Procesamiento
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'audio_processing:centro_audio' %}">Audio</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'audio_processing:lista_procesamientos' %}">Lista</a></li>
                        <li class="breadcrumb-item active">{{ procesamiento.titulo }}</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            
            <!-- Header con información principal -->
            <div class="detail-header">
                <div class="row">
                    <div class="col-md-8">
                        <h2><i class="fas fa-file-audio"></i> {{ procesamiento.titulo }}</h2>
                        <p class="mb-2"><strong>Tipo:</strong> {{ procesamiento.tipo_reunion.nombre }}</p>
                        <p class="mb-2"><strong>Descripción:</strong> {{ procesamiento.descripcion|default:"Sin descripción" }}</p>
                        <p class="mb-0"><strong>Creado:</strong> {{ procesamiento.created_at|date:"d/m/Y H:i" }}</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="status-badge status-{{ procesamiento.estado }}">
                            {{ procesamiento.get_estado_display|default:procesamiento.estado|capfirst }}
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: {{ procesamiento.progreso|default:0 }}%">
                                {{ procesamiento.progreso|default:0 }}%
                            </div>
                        </div>
                        <small>{{ procesamiento.mensaje_estado|default:"Sin mensaje" }}</small>
                    </div>
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="info-card">
                <h4><i class="fas fa-cogs"></i> Acciones de Control</h4>
                <div class="action-buttons">
                    {% if procesamiento.estado == 'pendiente' %}
                        <form method="post" action="{% url 'audio_processing:iniciar_procesamiento' procesamiento.id %}" 
                              style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="action-btn btn-start" 
                                    onclick="return confirm('¿Iniciar el procesamiento de este audio?')">
                                <i class="fas fa-play"></i> Iniciar Procesamiento
                            </button>
                        </form>
                    {% endif %}
                    
                    {% if procesamiento.estado == 'procesando' %}
                        <form method="post" action="{% url 'audio_processing:detener_procesamiento' procesamiento.id %}" 
                              style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="action-btn btn-stop" 
                                    onclick="return confirm('¿Detener este procesamiento?')">
                                <i class="fas fa-stop"></i> Detener Procesamiento
                            </button>
                        </form>
                    {% endif %}
                    
                    {% if procesamiento.estado in 'error,cancelado,completado' %}
                        <form method="post" action="{% url 'audio_processing:reiniciar_procesamiento' procesamiento.id %}" 
                              style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="action-btn btn-restart" 
                                    onclick="return confirm('¿Reiniciar este procesamiento? Se perderán los resultados actuales.')">
                                <i class="fas fa-redo"></i> Reiniciar Procesamiento
                            </button>
                        </form>
                    {% endif %}
                    
                    <a href="{% url 'audio_processing:lista_procesamientos' %}" class="action-btn btn-delete">
                        <i class="fas fa-arrow-left"></i> Volver a Lista
                    </a>
                </div>
            </div>

            <!-- Comparación de Audio (solo si está completado) -->
            {% if procesamiento.estado == 'completado' and procesamiento.archivo_audio and procesamiento.archivo_mejorado %}
            <div class="audio-comparison">
                <div class="comparison-title">
                    <i class="fas fa-chart-line"></i> Comparación de Audio: Original vs Procesado
                </div>

                <div class="row">
                    <!-- Audio Original -->
                    <div class="col-md-6">
                        <div class="audio-section">
                            <h4><i class="fas fa-microphone text-info"></i> Audio Original</h4>
                            <div class="waveform-container">
                                <div id="waveform-original"></div>
                            </div>
                            <div class="audio-controls">
                                <button id="play-original" class="control-button play-btn">
                                    <i class="fas fa-play"></i> Reproducir
                                </button>
                                <button id="pause-original" class="control-button pause-btn" disabled>
                                    <i class="fas fa-pause"></i> Pausar
                                </button>
                                <button id="stop-original" class="control-button stop-btn" disabled>
                                    <i class="fas fa-stop"></i> Detener
                                </button>
                                <a href="{{ procesamiento.archivo_audio.url }}" 
                                   class="control-button download-btn" download>
                                    <i class="fas fa-download"></i> Descargar
                                </a>
                            </div>
                            <div class="audio-stats">
                                <div class="stat-item">
                                    <div class="stat-value">{{ procesamiento.tamano_mb|default:"N/A" }}</div>
                                    <div class="stat-label">MB</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">{{ procesamiento.duracion_formateada|default:"N/A" }}</div>
                                    <div class="stat-label">Duración</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">{{ procesamiento.formato|default:"N/A" }}</div>
                                    <div class="stat-label">Formato</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audio Procesado -->
                    <div class="col-md-6">
                        <div class="audio-section">
                            <h4><i class="fas fa-magic text-success"></i> Audio Procesado</h4>
                            <div class="waveform-container">
                                <div id="waveform-processed"></div>
                            </div>
                            <div class="audio-controls">
                                <button id="play-processed" class="control-button play-btn">
                                    <i class="fas fa-play"></i> Reproducir
                                </button>
                                <button id="pause-processed" class="control-button pause-btn" disabled>
                                    <i class="fas fa-pause"></i> Pausar
                                </button>
                                <button id="stop-processed" class="control-button stop-btn" disabled>
                                    <i class="fas fa-stop"></i> Detener
                                </button>
                                <a href="{{ procesamiento.archivo_mejorado.url }}" 
                                   class="control-button download-btn" download>
                                    <i class="fas fa-download"></i> Descargar
                                </a>
                            </div>
                            <div class="audio-stats">
                                {% if procesamiento.metadatos_procesamiento.processed_size %}
                                <div class="stat-item">
                                    <div class="stat-value">{{ procesamiento.metadatos_procesamiento.processed_size|filesizeformat }}</div>
                                    <div class="stat-label">Tamaño</div>
                                </div>
                                {% endif %}
                                {% if procesamiento.duracion_seg %}
                                <div class="stat-item">
                                    <div class="stat-value">{{ procesamiento.duracion_seg|floatformat:1 }}s</div>
                                    <div class="stat-label">Duración</div>
                                </div>
                                {% endif %}
                                {% if procesamiento.sample_rate %}
                                <div class="stat-item">
                                    <div class="stat-value">{{ procesamiento.sample_rate }}Hz</div>
                                    <div class="stat-label">Sample Rate</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="vs-divider">
                    <div class="vs-text">
                        <i class="fas fa-exchange-alt"></i> COMPARACIÓN
                    </div>
                </div>

                <!-- Mejoras aplicadas -->
                <div class="info-card">
                    <h4><i class="fas fa-check-circle text-success"></i> Mejoras Aplicadas</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> Normalización de volumen (-16 LUFS)</li>
                                <li><i class="fas fa-check text-success"></i> Conversión a mono (mejor para transcripción)</li>
                                <li><i class="fas fa-check text-success"></i> Sample rate 16kHz (óptimo para STT)</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success"></i> Reducción de ruido de fondo</li>
                                <li><i class="fas fa-check text-success"></i> Filtros de frecuencia optimizados</li>
                                <li><i class="fas fa-check text-success"></i> Compresión dinámica para claridad</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Información técnica -->
            <div class="info-card">
                <h4><i class="fas fa-info-circle"></i> Información Técnica</h4>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>ID:</strong> {{ procesamiento.id }}</p>
                        <p><strong>Usuario:</strong> {{ procesamiento.usuario.get_full_name|default:procesamiento.usuario.username }}</p>
                        <p><strong>Estado:</strong> {{ procesamiento.get_estado_display|default:procesamiento.estado }}</p>
                        <p><strong>Progreso:</strong> {{ procesamiento.progreso|default:0 }}%</p>
                        {% if procesamiento.fecha_procesamiento %}
                        <p><strong>Fecha de procesamiento:</strong> {{ procesamiento.fecha_procesamiento|date:"d/m/Y H:i:s" }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if procesamiento.fecha_completado %}
                        <p><strong>Fecha completado:</strong> {{ procesamiento.fecha_completado|date:"d/m/Y H:i:s" }}</p>
                        {% endif %}
                        {% if procesamiento.version_pipeline %}
                        <p><strong>Versión pipeline:</strong> {{ procesamiento.version_pipeline }}</p>
                        {% endif %}
                        {% if procesamiento.metadatos_procesamiento %}
                        <p><strong>Metadatos:</strong> 
                            <button class="btn btn-sm btn-outline-info" data-toggle="collapse" data-target="#metadatos">
                                Ver JSON
                            </button>
                        </p>
                        <div class="collapse" id="metadatos">
                            <pre class="bg-light p-2">{{ procesamiento.metadatos_procesamiento|pprint }}</pre>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Logs del procesamiento -->
            <div class="info-card">
                <h4><i class="fas fa-list-ul"></i> Logs del Procesamiento</h4>
                {% if logs %}
                    {% for log in logs %}
                    <div class="log-entry {{ log.nivel }}">
                        <div class="d-flex justify-content-between">
                            <strong>{{ log.timestamp|date:"d/m/Y H:i:s" }}</strong>
                            <span class="badge badge-{{ log.nivel }}">{{ log.nivel|upper }}</span>
                        </div>
                        <p class="mb-1">{{ log.mensaje }}</p>
                        {% if log.detalles_json %}
                        <details>
                            <summary class="text-muted" style="cursor: pointer;">Ver detalles</summary>
                            <pre class="mt-2 bg-light p-2">{{ log.detalles_json|pprint }}</pre>
                        </details>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No hay logs disponibles para este procesamiento.</p>
                {% endif %}
            </div>

        </div>
    </section>
</div>

{% endblock content %}

{% block javascripts %}
<!-- WaveSurfer.js library -->
<script src="https://unpkg.com/wavesurfer.js@7"></script>

<script>
$(document).ready(function() {
    {% if procesamiento.estado == 'completado' and procesamiento.archivo_audio and procesamiento.archivo_mejorado %}
    
    // Inicializar WaveSurfer para audio original
    let wavesurferOriginal = null;
    let wavesurferProcessed = null;
    
    try {
        wavesurferOriginal = WaveSurfer.create({
            container: '#waveform-original',
            waveColor: '#007bff',
            progressColor: '#0056b3',
            height: 80,
            normalize: true,
            responsive: true,
            barWidth: 2,
            barHeight: 1,
            backend: 'MediaElement'
        });
        
        wavesurferOriginal.load('{{ procesamiento.archivo_audio.url }}');
        
        // Controles para audio original
        $('#play-original').click(function() {
            wavesurferOriginal.play();
            $(this).prop('disabled', true);
            $('#pause-original, #stop-original').prop('disabled', false);
        });
        
        $('#pause-original').click(function() {
            wavesurferOriginal.pause();
            $('#play-original').prop('disabled', false);
            $(this).prop('disabled', true);
        });
        
        $('#stop-original').click(function() {
            wavesurferOriginal.stop();
            $('#play-original').prop('disabled', false);
            $('#pause-original, #stop-original').prop('disabled', true);
        });
        
        wavesurferOriginal.on('finish', function() {
            $('#play-original').prop('disabled', false);
            $('#pause-original, #stop-original').prop('disabled', true);
        });
        
    } catch (error) {
        console.error('Error inicializando WaveSurfer original:', error);
        $('#waveform-original').html('<p class="text-muted">Error cargando forma de onda del audio original</p>');
    }
    
    try {
        // Inicializar WaveSurfer para audio procesado
        wavesurferProcessed = WaveSurfer.create({
            container: '#waveform-processed',
            waveColor: '#28a745',
            progressColor: '#1e7e34',
            height: 80,
            normalize: true,
            responsive: true,
            barWidth: 2,
            barHeight: 1,
            backend: 'MediaElement'
        });
        
        wavesurferProcessed.load('{{ procesamiento.archivo_mejorado.url }}');
        
        // Controles para audio procesado
        $('#play-processed').click(function() {
            wavesurferProcessed.play();
            $(this).prop('disabled', true);
            $('#pause-processed, #stop-processed').prop('disabled', false);
        });
        
        $('#pause-processed').click(function() {
            wavesurferProcessed.pause();
            $('#play-processed').prop('disabled', false);
            $(this).prop('disabled', true);
        });
        
        $('#stop-processed').click(function() {
            wavesurferProcessed.stop();
            $('#play-processed').prop('disabled', false);
            $('#pause-processed, #stop-processed').prop('disabled', true);
        });
        
        wavesurferProcessed.on('finish', function() {
            $('#play-processed').prop('disabled', false);
            $('#pause-processed, #stop-processed').prop('disabled', true);
        });
        
    } catch (error) {
        console.error('Error inicializando WaveSurfer procesado:', error);
        $('#waveform-processed').html('<p class="text-muted">Error cargando forma de onda del audio procesado</p>');
    }
    
    {% endif %}
    
    // Auto-refresh si está procesando
    {% if procesamiento.estado == 'procesando' %}
    setInterval(function() {
        location.reload();
    }, 5000); // Refresh cada 5 segundos
    {% endif %}
});
</script>
{% endblock javascripts %}
