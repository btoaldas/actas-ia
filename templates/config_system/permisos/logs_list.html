{% extends 'config_system/base.html' %}
{% load static %}

{% block title %}{{ title }} - Sistema de Permisos{% endblock %}

{% block page_title %}
    <i class="fas fa-list-alt mr-2"></i>{{ title }}
{% endblock %}

{% block breadcrumb_active %}Logs de Permisos{% endblock %}

{% block main_content %}

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-filter mr-1"></i>Filtros de Búsqueda
            </h3>
            <div class="card-tools">
                <a href="{% url 'config_system:permisos_dashboard' %}" class="btn btn-tool">
                    <i class="fas fa-arrow-left"></i> Dashboard
                </a>
            </div>
        </div>
        <div class="card-body">
            <form method="get" class="row">
                <div class="col-md-3">
                    <label for="accion" class="form-label">Acción</label>
                    <select name="accion" id="accion" class="form-control">
                        <option value="">Todas las acciones</option>
                        <option value="login" {% if filtros.accion == 'login' %}selected{% endif %}>Login</option>
                        <option value="logout" {% if filtros.accion == 'logout' %}selected{% endif %}>Logout</option>
                        <option value="acceso_denegado" {% if filtros.accion == 'acceso_denegado' %}selected{% endif %}>Acceso denegado</option>
                        <option value="permiso_verificado" {% if filtros.accion == 'permiso_verificado' %}selected{% endif %}>Permiso verificado</option>
                        <option value="perfil_asignado" {% if filtros.accion == 'perfil_asignado' %}selected{% endif %}>Perfil asignado</option>
                        <option value="perfil_removido" {% if filtros.accion == 'perfil_removido' %}selected{% endif %}>Perfil removido</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="usuario" class="form-label">Usuario</label>
                    <input type="text" name="usuario" id="usuario" class="form-control" 
                           placeholder="Buscar usuario..." value="{{ filtros.usuario }}">
                </div>
                <div class="col-md-2">
                    <label for="fecha_desde" class="form-label">Desde</label>
                    <input type="date" name="fecha_desde" id="fecha_desde" class="form-control" 
                           value="{{ filtros.fecha_desde }}">
                </div>
                <div class="col-md-2">
                    <label for="fecha_hasta" class="form-label">Hasta</label>
                    <input type="date" name="fecha_hasta" id="fecha_hasta" class="form-control" 
                           value="{{ filtros.fecha_hasta }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search mr-1"></i>Filtrar
                    </button>
                    <a href="{% url 'config_system:logs_permisos' %}" class="btn btn-secondary">
                        <i class="fas fa-times mr-1"></i>Limpiar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-left-primary">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Logs
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_logs }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-list fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-success">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Exitosos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ logs_exitosos }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-warning">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Fallidos
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ logs_fallidos }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-info">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Hoy
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ logs_hoy }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-day fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de logs -->
    <div class="card">
        <div class="card-header">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-list mr-1"></i>Logs de Permisos
                <span class="badge badge-secondary ml-2">{{ logs.count }} registros</span>
            </h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="logsTable">
                    <thead class="thead-light">
                        <tr>
                            <th>Fecha/Hora</th>
                            <th>Acción</th>
                            <th>Usuario</th>
                            <th>Ejecutor</th>
                            <th>URL</th>
                            <th>Estado</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr class="{% if not log.exitoso %}table-warning{% endif %}">
                            <td>
                                <small class="text-muted">
                                    {{ log.fecha|date:"d/m/Y" }}<br>
                                    {{ log.fecha|time:"H:i:s" }}
                                </small>
                            </td>
                            <td>
                                {% if log.accion == 'login' %}
                                    <span class="badge badge-success">
                                        <i class="fas fa-sign-in-alt mr-1"></i>Login
                                    </span>
                                {% elif log.accion == 'logout' %}
                                    <span class="badge badge-secondary">
                                        <i class="fas fa-sign-out-alt mr-1"></i>Logout
                                    </span>
                                {% elif log.accion == 'acceso_denegado' %}
                                    <span class="badge badge-danger">
                                        <i class="fas fa-ban mr-1"></i>Acceso Denegado
                                    </span>
                                {% elif log.accion == 'permiso_verificado' %}
                                    <span class="badge badge-info">
                                        <i class="fas fa-check mr-1"></i>Verificado
                                    </span>
                                {% elif log.accion == 'perfil_asignado' %}
                                    <span class="badge badge-primary">
                                        <i class="fas fa-user-plus mr-1"></i>Asignado
                                    </span>
                                {% elif log.accion == 'perfil_removido' %}
                                    <span class="badge badge-warning">
                                        <i class="fas fa-user-minus mr-1"></i>Removido
                                    </span>
                                {% else %}
                                    <span class="badge badge-light">{{ log.get_accion_display }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ log.usuario_afectado.username }}</strong><br>
                                <small class="text-muted">{{ log.usuario_afectado.get_full_name|default:"-" }}</small>
                            </td>
                            <td>
                                {% if log.usuario_ejecutor %}
                                    <strong>{{ log.usuario_ejecutor.username }}</strong><br>
                                    <small class="text-muted">{{ log.usuario_ejecutor.get_full_name|default:"-" }}</small>
                                {% else %}
                                    <span class="text-muted">Sistema</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.url_solicitada %}
                                    <small class="text-muted">{{ log.url_solicitada|truncatechars:40 }}</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.exitoso %}
                                    <span class="badge badge-success">
                                        <i class="fas fa-check mr-1"></i>Exitoso
                                    </span>
                                {% else %}
                                    <span class="badge badge-danger">
                                        <i class="fas fa-times mr-1"></i>Fallido
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-info" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#detalles{{ log.id }}" 
                                        aria-expanded="false">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <div class="collapse mt-2" id="detalles{{ log.id }}">
                                    <div class="card card-body">
                                        {% if log.permiso_codigo %}
                                            <strong>Permiso:</strong> {{ log.permiso_codigo }}<br>
                                        {% endif %}
                                        {% if log.perfil_nombre %}
                                            <strong>Perfil:</strong> {{ log.perfil_nombre }}<br>
                                        {% endif %}
                                        {% if log.ip_address %}
                                            <strong>IP:</strong> {{ log.ip_address }}<br>
                                        {% endif %}
                                        {% if log.mensaje %}
                                            <strong>Mensaje:</strong> {{ log.mensaje }}
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-3x mb-3"></i><br>
                                No se encontraron logs con los filtros aplicados
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginación -->
            {% if logs.has_other_pages %}
            <nav aria-label="Paginación">
                <ul class="pagination justify-content-center">
                    {% if logs.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ logs.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                    {% endif %}
                    
                    {% for num in logs.paginator.page_range %}
                        {% if logs.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > logs.number|add:'-3' and num < logs.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if logs.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ logs.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
{% endblock %}
