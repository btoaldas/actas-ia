{% extends 'config_system/base.html' %}
{% load static %}

{% block title %}Asignación Masiva de Perfiles{% endblock %}

{% block page_title %}
    <i class="fas fa-users-cog mr-2"></i>Asignación Masiva de Perfiles
{% endblock %}

{% block breadcrumb_active %}Asignación Masiva{% endblock %}

{% block main_content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-users mr-1"></i>
                    Asignar Perfiles a Múltiples Usuarios
                </h3>
                <div class="card-tools">
                    <a href="{% url 'config_system:usuarios_perfiles_list' %}" class="btn btn-tool">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                </div>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="usuarios_seleccionados">
                                    <i class="fas fa-user mr-1"></i>
                                    Seleccionar Usuarios
                                </label>
                                <select multiple class="form-control select2" id="usuarios_seleccionados" name="usuarios_seleccionados" required>
                                    {% for usuario in usuarios %}
                                        <option value="{{ usuario.id }}">
                                            {{ usuario.get_full_name|default:usuario.username }}
                                            {% if usuario.email %} - {{ usuario.email }}{% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    Mantén presionado Ctrl/Cmd para seleccionar múltiples usuarios
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="perfiles_seleccionados">
                                    <i class="fas fa-shield-alt mr-1"></i>
                                    Seleccionar Perfiles
                                </label>
                                <select multiple class="form-control select2" id="perfiles_seleccionados" name="perfiles_seleccionados" required>
                                    {% for perfil in perfiles %}
                                        <option value="{{ perfil.id }}">
                                            {{ perfil.nombre }}
                                            {% if perfil.descripcion %} - {{ perfil.descripcion|truncatechars:50 }}{% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    Mantén presionado Ctrl/Cmd para seleccionar múltiples perfiles
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <i class="fas fa-cog mr-1"></i>
                            Opciones de Asignación
                        </label>
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="reemplazar_existentes" name="reemplazar_existentes">
                            <label class="custom-control-label" for="reemplazar_existentes">
                                Reemplazar perfiles existentes
                            </label>
                            <small class="form-text text-muted">
                                Si está marcado, se eliminarán los perfiles actuales y se asignarán solo los seleccionados
                            </small>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="form-group mb-0">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-1"></i>
                            Asignar Perfiles
                        </button>
                        <a href="{% url 'config_system:usuarios_perfiles_list' %}" class="btn btn-secondary ml-2">
                            <i class="fas fa-times mr-1"></i>
                            Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Información de ayuda -->
<div class="row mt-3">
    <div class="col-12">
        <div class="card card-info">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-info-circle mr-1"></i>
                    Información
                </h3>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h5><i class="icon fas fa-info"></i> ¿Cómo funciona la asignación masiva?</h5>
                    <ul class="mb-0">
                        <li><strong>Modo Agregar:</strong> Se añaden los perfiles seleccionados a los usuarios, manteniendo los perfiles existentes</li>
                        <li><strong>Modo Reemplazar:</strong> Se eliminan todos los perfiles actuales y se asignan únicamente los seleccionados</li>
                        <li><strong>Usuarios:</strong> Selecciona uno o más usuarios que recibirán los perfiles</li>
                        <li><strong>Perfiles:</strong> Selecciona uno o más perfiles para asignar</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Inicializar Select2 para múltiple selección
    $('.select2').select2({
        placeholder: 'Selecciona una o más opciones...',
        allowClear: true,
        width: '100%'
    });
    
    // Validación del formulario
    $('form').on('submit', function(e) {
        var usuarios = $('#usuarios_seleccionados').val();
        var perfiles = $('#perfiles_seleccionados').val();
        
        if (!usuarios || usuarios.length === 0) {
            e.preventDefault();
            Swal.fire({
                icon: 'warning',
                title: 'Usuarios requeridos',
                text: 'Debes seleccionar al menos un usuario.'
            });
            return false;
        }
        
        if (!perfiles || perfiles.length === 0) {
            e.preventDefault();
            Swal.fire({
                icon: 'warning',
                title: 'Perfiles requeridos',
                text: 'Debes seleccionar al menos un perfil.'
            });
            return false;
        }
        
        // Confirmación antes de enviar
        e.preventDefault();
        var modo = $('#reemplazar_existentes').is(':checked') ? 'reemplazar' : 'agregar';
        var mensaje = modo === 'reemplazar' 
            ? 'Se eliminarán los perfiles actuales y se asignarán solo los seleccionados.' 
            : 'Se agregarán los perfiles seleccionados a los usuarios.';
            
        Swal.fire({
            title: '¿Confirmar asignación?',
            text: mensaje,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#007bff',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, asignar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                $('form')[0].submit();
            }
        });
    });
});
</script>
{% endblock %}
