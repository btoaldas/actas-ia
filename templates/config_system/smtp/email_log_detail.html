{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Detalle del Log de Envío{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{% static 'plugins/datatables/datatables.min.css' %}">
    <style>
        .detail-card {
            margin-bottom: 1rem;
        }
        .status-badge {
            font-size: 0.875rem;
        }
        .log-content {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error-content {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
    </style>
{% endblock stylesheets %}

{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-envelope"></i>
                            Detalle del Log de Envío #{{ log.id }}
                        </h3>
                        <div class="card-tools">
                            <a href="{% url 'config_system:email_logs' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Volver
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Información básica -->
                            <div class="col-md-6">
                                <div class="card detail-card">
                                    <div class="card-header">
                                        <h5 class="card-title">Información del Envío</h5>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-borderless">
                                            <tr>
                                                <td><strong>Estado:</strong></td>
                                                <td>
                                                    {% if log.exitoso %}
                                                        <span class="badge badge-success status-badge">
                                                            <i class="fas fa-check"></i> Exitoso
                                                        </span>
                                                    {% else %}
                                                        <span class="badge badge-danger status-badge">
                                                            <i class="fas fa-times"></i> Fallido
                                                        </span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>Fecha/Hora:</strong></td>
                                                <td>{{ log.fecha_envio|date:"d/m/Y H:i:s" }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Destinatario:</strong></td>
                                                <td>{{ log.destinatario }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Asunto:</strong></td>
                                                <td>{{ log.asunto }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Configuración SMTP:</strong></td>
                                                <td>
                                                    {% if log.configuracion_smtp %}
                                                        <a href="{% url 'config_system:smtp_edit' log.configuracion_smtp.pk %}">
                                                            {{ log.configuracion_smtp.nombre }}
                                                        </a>
                                                    {% else %}
                                                        <span class="text-muted">No disponible</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Detalles técnicos -->
                            <div class="col-md-6">
                                <div class="card detail-card">
                                    <div class="card-header">
                                        <h5 class="card-title">Detalles Técnicos</h5>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-borderless">
                                            <tr>
                                                <td><strong>Tamaño del mensaje:</strong></td>
                                                <td>{{ log.mensaje|length }} caracteres</td>
                                            </tr>
                                            {% if log.configuracion_smtp %}
                                            <tr>
                                                <td><strong>Servidor SMTP:</strong></td>
                                                <td>{{ log.configuracion_smtp.servidor }}:{{ log.configuracion_smtp.puerto }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Usuario:</strong></td>
                                                <td>{{ log.configuracion_smtp.usuario }}</td>
                                            </tr>
                                            <tr>
                                                <td><strong>TLS:</strong></td>
                                                <td>
                                                    {% if log.configuracion_smtp.usar_tls %}
                                                        <span class="badge badge-success">Activado</span>
                                                    {% else %}
                                                        <span class="badge badge-secondary">Desactivado</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endif %}
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contenido del mensaje -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title">Contenido del Mensaje</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="log-content">{{ log.mensaje }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Error (si existe) -->
                        {% if not log.exitoso and log.error %}
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header bg-danger">
                                        <h5 class="card-title text-white">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Error de Envío
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="log-content error-content">{{ log.error }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block javascripts %}
    <script src="{% static 'plugins/datatables/datatables.min.js' %}"></script>
{% endblock javascripts %}
