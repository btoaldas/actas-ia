{% extends "config_system/base.html" %}
{% load static %}

{% block page_title %}Dashboard de Configuraciones{% endblock %}
{% block breadcrumb_active %}Dashboard{% endblock %}

{% block main_content %}
<div class="row">
    <!-- Stats Cards -->
    <div class="col-lg-3 col-6">
        <div class="small-box bg-info">
            <div class="inner">
                <h3>{{ stats.total_configs_ia }}</h3>
                <p>Configuraciones IA</p>
            </div>
            <div class="icon">
                <i class="fas fa-robot"></i>
            </div>
            <a href="{% url 'config_system:ia_list' %}" class="small-box-footer">
                Ver más <i class="fas fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <div class="col-lg-3 col-6">
        <div class="small-box bg-success">
            <div class="inner">
                <h3>{{ stats.total_configs_whisper }}</h3>
                <p>Configuraciones Whisper</p>
            </div>
            <div class="icon">
                <i class="fas fa-microphone"></i>
            </div>
            <a href="{% url 'config_system:whisper_list' %}" class="small-box-footer">
                Ver más <i class="fas fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <div class="col-lg-3 col-6">
        <div class="small-box bg-warning">
            <div class="inner">
                <h3>{{ stats.configs_activas }}</h3>
                <p>Configuraciones Activas</p>
            </div>
            <div class="icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="small-box-footer">
                <small>{{ stats.configs_inactivas }} inactivas</small>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-6">
        <div class="small-box bg-danger">
            <div class="inner">
                <h3>{{ stats.usuarios_con_permisos }}</h3>
                <p>Usuarios con Permisos</p>
            </div>
            <div class="icon">
                <i class="fas fa-users-cog"></i>
            </div>
            <a href="{% url 'config_system:usuarios_list' %}" class="small-box-footer">
                Ver más <i class="fas fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>
</div>

<!-- Segunda fila de estadísticas SMTP -->
<div class="row">
    <div class="col-lg-3 col-6">
        <div class="small-box bg-primary">
            <div class="inner">
                <h3>{{ stats.total_configs_smtp }}</h3>
                <p>Proveedores SMTP</p>
            </div>
            <div class="icon">
                <i class="fas fa-envelope"></i>
            </div>
            <a href="{% url 'config_system:smtp_list' %}" class="small-box-footer">
                Ver más <i class="fas fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <div class="col-lg-3 col-6">
        <div class="small-box bg-success">
            <div class="inner">
                <h3>{{ smtp_stats.emails_enviados_hoy }}</h3>
                <p>Emails Enviados Hoy</p>
            </div>
            <div class="icon">
                <i class="fas fa-paper-plane"></i>
            </div>
            <a href="{% url 'config_system:email_logs' %}" class="small-box-footer">
                Ver logs <i class="fas fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <div class="col-lg-3 col-6">
        <div class="small-box bg-info">
            <div class="inner">
                <h3>{{ smtp_stats.proveedores_activos }}</h3>
                <p>SMTP Activos</p>
            </div>
            <div class="icon">
                <i class="fas fa-server"></i>
            </div>
            <a href="{% url 'config_system:smtp_stats' %}" class="small-box-footer">
                Estadísticas <i class="fas fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>

    <div class="col-lg-3 col-6">
        <div class="small-box {% if smtp_stats.emails_error_hoy > 0 %}bg-warning{% else %}bg-secondary{% endif %}">
            <div class="inner">
                <h3>{{ smtp_stats.emails_error_hoy }}</h3>
                <p>Errores Hoy</p>
            </div>
            <div class="icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <a href="{% url 'config_system:email_test' %}" class="small-box-footer">
                Probar envío <i class="fas fa-arrow-circle-right"></i>
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Configuraciones IA Activas -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-robot text-primary"></i>
                    Configuraciones IA Activas
                </h3>
                <div class="card-tools">
                    <a href="{% url 'config_system:ia_create' %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> Nueva Config IA
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                {% if configs_ia_activas %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Proveedor</th>
                                    <th>Principal</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for config in configs_ia_activas %}
                                <tr>
                                    <td>
                                        <strong>{{ config.nombre }}</strong>
                                        {% if config.es_principal %}
                                            <span class="badge badge-success ml-1">Principal</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge provider-badge badge-{% if config.proveedor == 'openai' %}primary{% elif config.proveedor == 'deepseek' %}info{% elif config.proveedor == 'ollama' %}warning{% else %}secondary{% endif %}">
                                            {{ config.get_proveedor_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if config.es_principal %}
                                            <i class="fas fa-star text-warning"></i>
                                        {% else %}
                                            <i class="far fa-star text-muted"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'config_system:ia_edit' config.pk %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'config_system:ia_test' config.pk %}" class="btn btn-sm btn-outline-success test-config">
                                            <i class="fas fa-vial"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center p-3">
                        <i class="fas fa-robot fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No hay configuraciones IA activas</p>
                        <a href="{% url 'config_system:ia_create' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Crear Primera Config IA
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Configuraciones Whisper Activas -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-microphone text-success"></i>
                    Configuraciones Whisper Activas
                </h3>
                <div class="card-tools">
                    <a href="{% url 'config_system:whisper_create' %}" class="btn btn-success btn-sm">
                        <i class="fas fa-plus"></i> Nueva Config Whisper
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                {% if configs_whisper_activas %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Modelo</th>
                                    <th>Idioma</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for config in configs_whisper_activas %}
                                <tr>
                                    <td>
                                        <strong>{{ config.nombre }}</strong>
                                        {% if config.usar_pyannote %}
                                            <small class="badge badge-info">Pyannote</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <code>{{ config.modelo_whisper }}</code>
                                    </td>
                                    <td>
                                        <span class="badge badge-secondary">{{ config.idioma|upper }}</span>
                                    </td>
                                    <td>
                                        <a href="{% url 'config_system:whisper_edit' config.pk %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'config_system:whisper_test' config.pk %}" class="btn btn-sm btn-outline-success test-config">
                                            <i class="fas fa-vial"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center p-3">
                        <i class="fas fa-microphone fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No hay configuraciones Whisper activas</p>
                        <a href="{% url 'config_system:whisper_create' %}" class="btn btn-success">
                            <i class="fas fa-plus"></i> Crear Primera Config Whisper
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Configuraciones SMTP Activas -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-envelope text-info"></i>
                    Proveedores SMTP Activos
                </h3>
                <div class="card-tools">
                    <a href="{% url 'config_system:smtp_create' %}" class="btn btn-info btn-sm">
                        <i class="fas fa-plus"></i> Nueva Config SMTP
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                {% if configs_smtp_activas %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Proveedor</th>
                                    <th>Estado</th>
                                    <th>Uso Diario</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for config in configs_smtp_activas %}
                                <tr>
                                    <td>
                                        {% if config.por_defecto %}
                                            <i class="fas fa-star text-warning" title="Por defecto"></i>
                                        {% endif %}
                                        <strong>{{ config.nombre }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge provider-badge badge-{% if config.proveedor == 'office365' %}primary{% elif config.proveedor == 'gmail' %}danger{% elif config.proveedor == 'sendgrid' %}info{% else %}secondary{% endif %}">
                                            {{ config.get_proveedor_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if config.test_exitoso %}
                                            <span class="badge badge-success">
                                                <i class="fas fa-check"></i> OK
                                            </span>
                                        {% elif config.ultimo_test %}
                                            <span class="badge badge-danger">
                                                <i class="fas fa-times"></i> Error
                                            </span>
                                        {% else %}
                                            <span class="badge badge-secondary">
                                                <i class="fas fa-question"></i> Sin probar
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 8px;">
                                            {% if config.limite_diario > 0 %}
                                                {% widthratio config.emails_enviados_hoy config.limite_diario 100 as porcentaje %}
                                                <div class="progress-bar {% if porcentaje > 80 %}bg-warning{% elif porcentaje > 95 %}bg-danger{% else %}bg-success{% endif %}" 
                                                     style="width: {{ porcentaje }}%"></div>
                                            {% else %}
                                                <div class="progress-bar bg-secondary" style="width: 0%"></div>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">{{ config.emails_enviados_hoy }} / {{ config.limite_diario }}</small>
                                    </td>
                                    <td>
                                        <a href="{% url 'config_system:smtp_detail' config.pk %}" class="btn btn-sm btn-outline-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{% url 'config_system:smtp_test_single' config.pk %}" class="btn btn-sm btn-outline-success test-config">
                                            <i class="fas fa-paper-plane"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center p-3">
                        <i class="fas fa-envelope fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No hay proveedores SMTP configurados</p>
                        <a href="{% url 'config_system:smtp_create' %}" class="btn btn-info">
                            <i class="fas fa-plus"></i> Crear Primera Config SMTP
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Logs de Email Recientes -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-list-alt text-secondary"></i>
                    Logs de Email Recientes
                </h3>
                <div class="card-tools">
                    <a href="{% url 'config_system:email_logs' %}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-list"></i> Ver Todos
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                {% if logs_email_recientes %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Destinatario</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Proveedor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs_email_recientes %}
                                <tr>
                                    <td>
                                        <small>{{ log.destinatario|truncatechars:25 }}</small><br>
                                        <span class="text-muted small">{{ log.asunto|truncatechars:30 }}</span>
                                    </td>
                                    <td>
                                        {% if log.estado == 'enviado' %}
                                            <span class="badge badge-success">
                                                <i class="fas fa-check"></i> Enviado
                                            </span>
                                        {% elif log.estado == 'error' %}
                                            <span class="badge badge-danger">
                                                <i class="fas fa-times"></i> Error
                                            </span>
                                        {% elif log.estado == 'pendiente' %}
                                            <span class="badge badge-warning">
                                                <i class="fas fa-clock"></i> Pendiente
                                            </span>
                                        {% else %}
                                            <span class="badge badge-info">
                                                <i class="fas fa-sync"></i> Reintentando
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ log.fecha_creacion|timesince }} atrás</small>
                                    </td>
                                    <td>
                                        {% if log.configuracion_smtp %}
                                            <small>{{ log.configuracion_smtp.nombre|truncatechars:15 }}</small>
                                        {% else %}
                                            <small class="text-muted">Sistema</small>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center p-3">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No hay logs de email recientes</p>
                        <a href="{% url 'config_system:email_test' %}" class="btn btn-secondary">
                            <i class="fas fa-paper-plane"></i> Enviar Email de Prueba
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Últimas Actividades -->
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-history text-info"></i>
                    Últimas Actividades de Configuración
                </h3>
            </div>
            <div class="card-body">
                {% if ultimas_actividades %}
                    <div class="timeline">
                        {% for actividad in ultimas_actividades %}
                        <div class="time-label">
                            <span class="bg-{% cycle 'blue' 'green' 'yellow' 'red' %}">
                                {{ actividad.fecha_creacion|date:"d M Y" }}
                            </span>
                        </div>
                        <div>
                            <i class="fas fa-{% if actividad.accion == 'crear' %}plus{% elif actividad.accion == 'editar' %}edit{% elif actividad.accion == 'eliminar' %}trash{% elif actividad.accion == 'probar' %}vial{% else %}cog{% endif %} bg-{% cycle 'blue' 'green' 'yellow' 'red' %}"></i>
                            <div class="timeline-item">
                                <span class="time">
                                    <i class="fas fa-clock"></i> {{ actividad.fecha_creacion|time:"H:i" }}
                                </span>
                                <h3 class="timeline-header">
                                    {% if actividad.usuario %}
                                        <strong>{{ actividad.usuario.get_full_name|default:actividad.usuario.username }}</strong>
                                    {% else %}
                                        <strong>Sistema</strong>
                                    {% endif %}
                                    {{ actividad.get_accion_display|lower }} configuración
                                </h3>
                                <div class="timeline-body">
                                    <strong>{{ actividad.configuracion_nombre }}</strong>
                                    {% if actividad.detalles %}
                                        <br><small class="text-muted">{{ actividad.detalles }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        <div>
                            <i class="fas fa-clock bg-gray"></i>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center">
                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No hay actividades recientes</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% csrf_token %}
{% endblock main_content %}
