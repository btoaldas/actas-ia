{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">{{ title }}</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        {% for item in breadcrumbs %}
                            {% if forloop.last %}
                                <li class="breadcrumb-item active">{{ item.name }}</li>
                            {% else %}
                                <li class="breadcrumb-item"><a href="{{ item.url }}">{{ item.name }}</a></li>
                            {% endif %}
                        {% endfor %}
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-key mr-1"></i>
                                {{ title }}
                            </h3>
                        </div>
                        
                        <form method="post" class="needs-validation" novalidate>
                            {% csrf_token %}
                            
                            <div class="card-body">
                                {% if form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {{ form.non_field_errors }}
                                </div>
                                {% endif %}
                                
                                <div class="row">
                                    <!-- Información Básica -->
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.name.id_for_label }}" class="required">
                                                {{ form.name.label }}
                                            </label>
                                            {{ form.name }}
                                            {% if form.name.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.name.errors.0 }}
                                            </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                Nombre descriptivo del permiso
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.code.id_for_label }}" class="required">
                                                {{ form.code.label }}
                                            </label>
                                            {{ form.code }}
                                            {% if form.code.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.code.errors.0 }}
                                            </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                Código único. Ej: menu.actas, view.actas_list
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.permission_type.id_for_label }}" class="required">
                                                {{ form.permission_type.label }}
                                            </label>
                                            {{ form.permission_type }}
                                            {% if form.permission_type.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.permission_type.errors.0 }}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.app_name.id_for_label }}">
                                                {{ form.app_name.label }}
                                            </label>
                                            {{ form.app_name }}
                                            {% if form.app_name.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.app_name.errors.0 }}
                                            </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                Nombre de la aplicación Django
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Detalles Técnicos -->
                                <h5 class="mt-4 mb-3">
                                    <i class="fas fa-cogs mr-1"></i>
                                    Detalles Técnicos
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.url_pattern.id_for_label }}">
                                                {{ form.url_pattern.label }}
                                            </label>
                                            {{ form.url_pattern }}
                                            {% if form.url_pattern.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.url_pattern.errors.0 }}
                                            </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                Patrón de URL. Ej: /actas/, actas:list
                                            </small>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.view_name.id_for_label }}">
                                                {{ form.view_name.label }}
                                            </label>
                                            {{ form.view_name }}
                                            {% if form.view_name.errors %}
                                            <div class="invalid-feedback d-block">
                                                {{ form.view_name.errors.0 }}
                                            </div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                Nombre de la vista Django
                                            </small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="{{ form.description.id_for_label }}">
                                        {{ form.description.label }}
                                    </label>
                                    {{ form.description }}
                                    {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.description.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Estado -->
                                <div class="form-group">
                                    <div class="custom-control custom-switch">
                                        {{ form.is_active }}
                                        <label class="custom-control-label" for="{{ form.is_active.id_for_label }}">
                                            {{ form.is_active.label }}
                                        </label>
                                    </div>
                                    {% if form.is_active.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.is_active.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="card-footer">
                                <div class="row">
                                    <div class="col-6">
                                        <a href="{% url 'config_system:new_permissions:system_list' %}" class="btn btn-secondary">
                                            <i class="fas fa-times mr-1"></i>
                                            Cancelar
                                        </a>
                                    </div>
                                    <div class="col-6 text-right">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save mr-1"></i>
                                            {% if permission %}Actualizar{% else %}Crear{% endif %} Permiso
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block javascripts %}
{{ block.super }}
<script>
$(document).ready(function() {
    // Validación del formulario
    $('.needs-validation').on('submit', function(event) {
        if (this.checkValidity() === false) {
            event.preventDefault();
            event.stopPropagation();
        }
        $(this).addClass('was-validated');
    });
    
    // Auto-generar código basado en el nombre y tipo
    $('#id_name, #id_permission_type').on('input change', function() {
        var name = $('#id_name').val();
        var type = $('#id_permission_type').val();
        
        if (name && type && !$('#id_code').val()) {
            var code = type + '.' + name.toLowerCase()
                .replace(/\s+/g, '_')
                .replace(/[^a-z0-9_]/g, '');
            $('#id_code').val(code);
        }
    });
    
    // Mostrar/ocultar campos según el tipo
    $('#id_permission_type').change(function() {
        var type = $(this).val();
        
        if (type === 'view') {
            $('#id_view_name').closest('.form-group').show();
            $('#id_url_pattern').closest('.form-group').show();
        } else if (type === 'menu') {
            $('#id_view_name').closest('.form-group').hide();
            $('#id_url_pattern').closest('.form-group').show();
        } else if (type === 'module') {
            $('#id_view_name').closest('.form-group').hide();
            $('#id_url_pattern').closest('.form-group').hide();
        }
    });
    
    // Ejecutar al cargar
    $('#id_permission_type').trigger('change');
});
</script>
{% endblock %}
