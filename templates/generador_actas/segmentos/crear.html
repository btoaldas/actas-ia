{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock title %}

{% block content %}
<div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>
                        {% if form.instance.pk %}
                            <i class="fas fa-edit"></i> Editar Segmento
                        {% else %}
                            <i class="fas fa-plus-circle"></i> Crear Segmento
                        {% endif %}
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'generador_actas:dashboard' %}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'generador_actas:lista_segmentos' %}">Segmentos</a></li>
                        <li class="breadcrumb-item active">
                            {% if form.instance.pk %}Editar{% else %}Crear{% endif %}
                        </li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- CONFIGURACI√ìN AVANZADA -->
                        <div class="card card-warning collapsed-card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-cogs"></i> ‚öôÔ∏è Configuraci√≥n Avanzada</h3>
                                <div class="card-tools">
                                    <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.formato_salida.id_for_label }}">üìÑ Formato de Salida</label>
                                            {{ form.formato_salida }}
                                            <small class="form-text text-muted">Formato en que se mostrar√° el contenido</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.orden_defecto.id_for_label }}">üî¢ Orden por Defecto</label>
                                            {{ form.orden_defecto }}
                                            <small class="form-text text-muted">Posici√≥n por defecto en la plantilla</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="{{ form.tiempo_limite_ia.id_for_label }}">‚è±Ô∏è Tiempo L√≠mite IA (seg)</label>
                                            {{ form.tiempo_limite_ia }}
                                            <small class="form-text text-muted">Tiempo m√°ximo para procesar con IA</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="{{ form.reintentos_ia.id_for_label }}">üîÑ Reintentos IA</label>
                                            {{ form.reintentos_ia }}
                                            <small class="form-text text-muted">N√∫mero de reintentos si falla IA</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <div class="custom-control">
                                                {{ form.activo }}
                                                <label class="custom-control-label" for="{{ form.activo.id_for_label }}">
                                                    ‚úÖ Activo
                                                </label>
                                            </div>
                                            <div class="custom-control custom-checkbox mt-2">
                                                {{ form.reutilizable }}
                                                <label class="custom-control-label" for="{{ form.reutilizable.id_for_label }}">
                                                    ‚ôªÔ∏è Reutilizable
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- INFORMACI√ìN B√ÅSICA -->
                        <div class="card card-primary">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-info-circle"></i> Informaci√≥n B√°sica</h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.nombre.id_for_label }}" class="h6">
                                                <i class="fas fa-tag"></i> Nombre del Segmento <span class="text-danger">*</span>
                                            </label>
                                            {{ form.nombre }}
                                            {% if form.nombre.errors %}
                                                <div class="text-danger mt-1">
                                                    {% for error in form.nombre.errors %}
                                                        <strong>{{ error }}</strong>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="{{ form.codigo.id_for_label }}" class="h6">
                                                <i class="fas fa-code"></i> C√≥digo <span class="text-danger">*</span>
                                            </label>
                                            {{ form.codigo }}
                                            <small class="form-text text-muted">C√≥digo √∫nico identificador (MAY√öSCULAS_CON_GUIONES)</small>
                                            {% if form.codigo.errors %}
                                                <div class="text-danger mt-1">
                                                    {% for error in form.codigo.errors %}
                                                        <strong>{{ error }}</strong>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="{{ form.tipo.id_for_label }}" class="h6">
                                                <i class="fas fa-cogs"></i> Tipo de Segmento <span class="text-danger">*</span>
                                            </label>
                                            {{ form.tipo }}
                                            {% if form.tipo.errors %}
                                                <div class="text-danger mt-1">
                                                    {% for error in form.tipo.errors %}
                                                        <strong>{{ error }}</strong>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="{{ form.categoria.id_for_label }}" class="h6">
                                                <i class="fas fa-folder"></i> Categor√≠a
                                            </label>
                                            {{ form.categoria }}
                                            {% if form.categoria.errors %}
                                                <div class="text-danger mt-1">
                                                    {% for error in form.categoria.errors %}
                                                        <strong>{{ error }}</strong>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.descripcion.id_for_label }}" class="h6">
                                        <i class="fas fa-align-left"></i> Descripci√≥n
                                    </label>
                                    {{ form.descripcion }}
                                    <small class="form-text text-muted">Explica el prop√≥sito de este segmento</small>
                                    {% if form.descripcion.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.descripcion.errors %}
                                                <strong>{{ error }}</strong>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- CONTENIDO EST√ÅTICO - SIEMPRE VISIBLE -->
                        <div class="card card-success">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-file-alt"></i> ‚úèÔ∏è Contenido Est√°tico
                                </h3>
                                <div class="card-tools">
                                    <span class="badge badge-success">Para segmentos de tipo "est√°tico"</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> <strong>Solo necesario para segmentos est√°ticos:</strong> Escribe aqu√≠ el texto que aparecer√° exactamente igual en todas las actas.
                                </div>
                                
                                <div class="form-group">
                                    <label for="{{ form.contenido_estatico.id_for_label }}" class="h5">
                                        <i class="fas fa-edit"></i> Texto del Segmento
                                    </label>
                                    {{ form.contenido_estatico }}
                                    {% if form.contenido_estatico.errors %}
                                        <div class="text-danger mt-2">
                                            {% for error in form.contenido_estatico.errors %}
                                                <strong>{{ error }}</strong>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    
                                    <div class="mt-3 p-3 bg-light border-left-success">
                                        <h6><i class="fas fa-lightbulb text-warning"></i> Variables que puedes usar:</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <code>{{fecha}}</code> - Fecha reuni√≥n<br>
                                                <code>{{numero_acta}}</code> - N√∫mero de acta<br>
                                                <code>{{alcalde}}</code> - Nombre alcalde
                                            </div>
                                            <div class="col-md-6">
                                                <code>{{secretario}}</code> - Secretario<br>
                                                <code>{{hora_inicio}}</code> - Hora inicio<br>
                                                <code>{{ubicacion}}</code> - Lugar reuni√≥n
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PROMPT PARA IA - SIEMPRE VISIBLE -->
                        <div class="card card-primary">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-robot"></i> ü§ñ Prompt para IA
                                </h3>
                                <div class="card-tools">
                                    <span class="badge badge-primary">Para segmentos de tipo "din√°mico"</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning">
                                    <i class="fas fa-robot"></i> <strong>Solo necesario para segmentos din√°micos:</strong> La IA analizar√° la transcripci√≥n y generar√° contenido seg√∫n tus instrucciones.
                                </div>

                                <div class="form-group">
                                    <label for="{{ form.proveedor_ia.id_for_label }}" class="h6">
                                        <i class="fas fa-brain"></i> Proveedor de IA
                                    </label>
                                    {{ form.proveedor_ia }}
                                    {% if form.proveedor_ia.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.proveedor_ia.errors %}
                                                <strong>{{ error }}</strong>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="form-group">
                                    <label for="{{ form.prompt_ia.id_for_label }}" class="h5">
                                        <i class="fas fa-terminal"></i> Instrucciones para la IA
                                    </label>
                                    {{ form.prompt_ia }}
                                    {% if form.prompt_ia.errors %}
                                        <div class="text-danger mt-2">
                                            {% for error in form.prompt_ia.errors %}
                                                <strong>{{ error }}</strong>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    
                                    <div class="mt-3 p-3 bg-light border-left-primary">
                                        <h6><i class="fas fa-lightbulb text-warning"></i> Ejemplo de Prompt Efectivo:</h6>
                                        <div class="bg-dark text-light p-3 rounded">
<small>Analiza la transcripci√≥n de la reuni√≥n municipal y extrae informaci√≥n sobre los participantes.

Necesito generar la secci√≥n "PARTICIPANTES" del acta que incluya:
- titulo: "PARTICIPANTES DE LA REUNI√ìN"
- cuerpo: Lista detallada de asistentes con sus cargos
- integrantes: Array con nombres completos
- autoridades: Separar autoridades de funcionarios

Responde √öNICAMENTE en formato JSON v√°lido, sin explicaciones adicionales.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- BOTONES DE ACCI√ìN -->
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="fas fa-save"></i>
                                            {% if form.instance.pk %}
                                                Guardar Cambios
                                            {% else %}
                                                Crear Segmento
                                            {% endif %}
                                        </button>
                                    </div>
                                    <div class="col-md-6 text-right">
                                        <a href="{% url 'generador_actas:lista_segmentos' %}" class="btn btn-secondary btn-lg">
                                            <i class="fas fa-arrow-left"></i> Volver a la Lista
                                        </a>
                                        
                                        {% if form.instance.pk %}
                                            <a href="{% url 'generador_actas:detalle_segmento' form.instance.pk %}" class="btn btn-info btn-lg ml-2">
                                                <i class="fas fa-eye"></i> Ver Detalle
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </form>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Iniciando sistema de auto-completado inteligente');
    
    // Referencias a campos
    const nombreField = document.getElementById('id_nombre');
    const codigoField = document.getElementById('id_codigo');
    const tipoSelect = document.getElementById('id_tipo');
    const categoriaSelect = document.getElementById('id_categoria');
    const descripcionField = document.getElementById('id_descripcion');
    const contenidoEstaticoField = document.getElementById('id_contenido_estatico');
    const promptIaField = document.getElementById('id_prompt_ia');
    
    // EJEMPLOS PREDEFINIDOS POR CATEGOR√çA
    const ejemplos = {
        'encabezado': {
            descripcion: 'Secci√≥n de introducci√≥n del acta con datos generales de la sesi√≥n',
            estatico: `<h2>ACTA DE SESI√ìN ORDINARIA</h2>
<p><strong>Fecha:</strong> {{fecha_sesion}}</p>
<p><strong>Hora:</strong> {{hora_inicio}} - {{hora_fin}}</p>
<p><strong>Lugar:</strong> {{ubicacion}}</p>
<p><strong>Presidida por:</strong> {{presidente_nombre}}</p>`,
            prompt: `Analiza la transcripci√≥n y extrae la informaci√≥n de encabezado de la sesi√≥n.

INFORMACI√ìN A EXTRAER:
- Tipo de sesi√≥n (ordinaria, extraordinaria, etc.)
- Fecha y hora de inicio y fin
- Lugar de la reuni√≥n
- Persona que preside la sesi√≥n

FORMATO DE RESPUESTA:
Responde √∫nicamente en formato JSON v√°lido:
{
  "tipo_sesion": "Ordinaria",
  "fecha_sesion": "2024-01-15",
  "hora_inicio": "09:00",
  "hora_fin": "11:30",
  "ubicacion": "Sala de Sesiones del GAD Municipal",
  "presidente_nombre": "Nombre del Presidente"
}`
        },
        'participantes': {
            descripcion: 'Lista de asistentes y participantes de la sesi√≥n con sus roles',
            estatico: `<h3>PARTICIPANTES</h3>
<h4>Autoridades Presentes:</h4>
<ul>
    <li>{{nombre_alcalde}} - Alcalde</li>
    <li>{{nombre_vicealcalde}} - Vicealcalde</li>
    <!-- Agregar m√°s autoridades seg√∫n necesidad -->
</ul>

<h4>Funcionarios:</h4>
<ul>
    <li>{{nombre_secretario}} - Secretario General</li>
    <li>{{nombre_director_obras}} - Director de Obras P√∫blicas</li>
    <!-- Agregar m√°s funcionarios seg√∫n necesidad -->
</ul>`,
            prompt: `Identifica todos los participantes mencionados en la transcripci√≥n.

PERSONAS A IDENTIFICAR:
- Autoridades municipales (alcalde, concejales, vicealcalde)
- Funcionarios municipales
- Invitados especiales

FORMATO DE RESPUESTA:
Responde √∫nicamente en formato JSON v√°lido:
{
  "autoridades": [
    {"nombre": "Nombre Completo", "cargo": "Alcalde"}
  ],
  "funcionarios": [
    {"nombre": "Nombre Completo", "cargo": "Director", "dependencia": "Obras P√∫blicas"}
  ]
}`
        },
        'agenda': {
            descripcion: 'Orden del d√≠a y puntos tratados en la sesi√≥n',
            estatico: `<h3>ORDEN DEL D√çA</h3>
<ol>
    <li>{{punto_1}}</li>
    <li>{{punto_2}}</li>
    <li>{{punto_3}}</li>
    <li>{{punto_4}}</li>
    <!-- Agregar m√°s puntos seg√∫n necesidad -->
</ol>`,
            prompt: `Extrae el orden del d√≠a y los puntos de agenda tratados.

INFORMACI√ìN A EXTRAER:
- Puntos del orden del d√≠a en secuencia
- T√≠tulos completos de cada punto
- Estado de cada punto (tratado, diferido, etc.)

FORMATO DE RESPUESTA:
Responde √∫nicamente en formato JSON v√°lido:
{
  "puntos_agenda": [
    {"numero": 1, "titulo": "Aprobaci√≥n del acta anterior", "estado": "aprobado"}
  ]
}`
        },
        'decisiones': {
            descripcion: 'Resoluciones, acuerdos y decisiones tomadas en la sesi√≥n',
            estatico: `<h3>RESOLUCIONES Y ACUERDOS</h3>
<div class="decision">
    <h4>{{tipo_decision_1}} No. {{numero_1}}</h4>
    <p><strong>RESUELVE:</strong> {{resolucion_1}}</p>
    <p><strong>Votaci√≥n:</strong> {{votacion_1}}</p>
</div>

<div class="decision">
    <h4>{{tipo_decision_2}} No. {{numero_2}}</h4>
    <p><strong>RESUELVE:</strong> {{resolucion_2}}</p>
    <p><strong>Votaci√≥n:</strong> {{votacion_2}}</p>
</div>`,
            prompt: `Identifica todas las resoluciones y decisiones tomadas en la sesi√≥n.

TIPOS DE DECISIONES:
- Resoluciones
- Acuerdos
- Ordenanzas
- Aprobaciones

FORMATO DE RESPUESTA:
Responde √∫nicamente en formato JSON v√°lido:
{
  "decisiones": [
    {
      "tipo": "Resoluci√≥n",
      "numero": "001-2024",
      "resolucion": "Aprobar la propuesta de...",
      "votacion": "Aprobado por unanimidad"
    }
  ]
}`
        },
        'cierre': {
            descripcion: 'Informaci√≥n de cierre de la sesi√≥n y pr√≥ximas convocatorias',
            estatico: `<h3>CIERRE DE SESI√ìN</h3>
<p><strong>Hora de finalizaci√≥n:</strong> {{hora_cierre}}</p>
<p><strong>Pr√≥xima sesi√≥n:</strong> {{fecha_proxima_sesion}}</p>

<div class="firmas">
    <div class="firma-presidente">
        <p>_________________________</p>
        <p>{{presidente_nombre}}<br>{{presidente_cargo}}</p>
    </div>
    <div class="firma-secretario">
        <p>_________________________</p>
        <p>{{secretario_nombre}}<br>Secretario General</p>
    </div>
</div>`,
            prompt: `Extrae la informaci√≥n de cierre de la sesi√≥n.

INFORMACI√ìN A EXTRAER:
- Hora exacta de finalizaci√≥n
- Fecha de pr√≥xima sesi√≥n (si se menciona)
- Personas que firman el acta

FORMATO DE RESPUESTA:
Responde √∫nicamente en formato JSON v√°lido:
{
  "hora_cierre": "11:30",
  "fecha_proxima_sesion": "2024-02-15",
  "firmantes": [
    {"nombre": "Nombre Completo", "cargo": "Alcalde"}
  ]
}`
        }
    };

    // 1. AUTO-GENERAR C√ìDIGO DESDE NOMBRE
    function autoGenerarCodigo() {
        if (!nombreField || !codigoField || codigoField.value.trim()) return;
        
        const nombre = nombreField.value.trim();
        if (!nombre) return;
        
        let codigo = nombre
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toUpperCase()
            .replace(/[^A-Z0-9\s]/g, '')
            .replace(/\s+/g, '_')
            .substring(0, 50);
            
        codigoField.value = codigo;
        console.log('‚úÖ C√≥digo auto-generado:', codigo);
    }

    // 2. AUTO-RELLENAR EJEMPLOS
    function autoRellenarEjemplos() {
        const tipo = tipoSelect ? tipoSelect.value : '';
        const categoria = categoriaSelect ? categoriaSelect.value : '';
        
        if (!tipo || !categoria || !ejemplos[categoria]) return;
        
        const ejemplo = ejemplos[categoria];
        
        // Descripci√≥n
        if (descripcionField && !descripcionField.value.trim()) {
            descripcionField.value = ejemplo.descripcion;
            console.log('‚úÖ Descripci√≥n auto-rellenada');
        }
        
        // Contenido seg√∫n tipo
        if (tipo === 'estatico' && contenidoEstaticoField && !contenidoEstaticoField.value.trim()) {
            contenidoEstaticoField.value = ejemplo.estatico;
            console.log('‚úÖ Contenido est√°tico auto-rellenado');
        }
        
        if (tipo === 'dinamico' && promptIaField && !promptIaField.value.trim()) {
            promptIaField.value = ejemplo.prompt;
            console.log('‚úÖ Prompt IA auto-rellenado');
        }
    }

    // EVENT LISTENERS
    if (nombreField) {
        nombreField.addEventListener('blur', autoGenerarCodigo);
    }
    
    if (tipoSelect) {
        tipoSelect.addEventListener('change', autoRellenarEjemplos);
    }
    
    if (categoriaSelect) {
        categoriaSelect.addEventListener('change', autoRellenarEjemplos);
    }

    // VALIDACI√ìN
    const form = document.querySelector('form[method="post"]');
    if (form) {
        form.addEventListener('submit', function(e) {
            const nombre = nombreField ? nombreField.value.trim() : '';
            const codigo = codigoField ? codigoField.value.trim() : '';
            
            if (!nombre) {
                alert('‚ùå El nombre del segmento es obligatorio');
                e.preventDefault();
                return false;
            }
            
            console.log('‚úÖ Formulario validado');
            return true;
        });
    }
    
    console.log('‚úÖ Sistema de auto-completado listo');
});
</script>
{% endblock extra_scripts %}
