{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock title %}

{% block stylesheets %}
    <link rel="stylesheet" href="{% static 'generador_actas/css/proveedores-ia.css' %}">
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>‚öôÔ∏è {{ page_title }}</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        {% for item in breadcrumbs %}
                            {% if item.url %}
                                <li class="breadcrumb-item">
                                    <a href="{{ item.url }}">{{ item.title }}</a>
                                </li>
                            {% else %}
                                <li class="breadcrumb-item active">{{ item.title }}</li>
                            {% endif %}
                        {% endfor %}
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-8">
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">üìù Configuraci√≥n del Proveedor</h3>
                        </div>
                        
                        <form method="post" id="proveedorForm">
                            {% csrf_token %}
                            <div class="card-body">
                                
                                <!-- Informaci√≥n B√°sica -->
                                <div class="card card-outline card-secondary mb-3">
                                    <div class="card-header">
                                        <h5 class="card-title">‚ÑπÔ∏è Informaci√≥n B√°sica</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="{{ form.nombre.id_for_label }}">
                                                        Nombre del Proveedor <span class="text-danger">*</span>
                                                    </label>
                                                    {{ form.nombre }}
                                                    {% if form.nombre.errors %}
                                                        <div class="text-danger small">{{ form.nombre.errors }}</div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">Nombre descriptivo para identificar este proveedor</small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="{{ form.tipo.id_for_label }}">
                                                        Tipo de Proveedor <span class="text-danger">*</span>
                                                    </label>
                                                    {{ form.tipo }}
                                                    {% if form.tipo.errors %}
                                                        <div class="text-danger small">{{ form.tipo.errors }}</div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">Selecciona el servicio de IA a utilizar</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Configuraci√≥n de API -->
                                <div class="card card-outline card-info mb-3">
                                    <div class="card-header">
                                        <h5 class="card-title">üîê Configuraci√≥n de API</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="{{ form.api_key.id_for_label }}">
                                                        Clave API <span class="text-danger">*</span>
                                                    </label>
                                                    <div class="input-group">
                                                        {{ form.api_key }}
                                                        <div class="input-group-append">
                                                            <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKey()">
                                                                <i class="fas fa-eye" id="eyeIcon"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    {% if form.api_key.errors %}
                                                        <div class="text-danger small">{{ form.api_key.errors }}</div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">
                                                        Dejar vac√≠o para usar la configuraci√≥n del .env
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="{{ form.api_url.id_for_label }}">
                                                        URL de API
                                                    </label>
                                                    {{ form.api_url }}
                                                    {% if form.api_url.errors %}
                                                        <div class="text-danger small">{{ form.api_url.errors }}</div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">Se autocompleta seg√∫n el tipo de proveedor</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <label for="{{ form.modelo.id_for_label }}">
                                                        Modelo <span class="text-danger">*</span>
                                                    </label>
                                                    {{ form.modelo }}
                                                    <datalist id="modelos_disponibles">
                                                        <!-- Se llena din√°micamente con JavaScript -->
                                                    </datalist>
                                                    {% if form.modelo.errors %}
                                                        <div class="text-danger small">{{ form.modelo.errors }}</div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">Ej: gpt-4o, claude-3-5-sonnet, deepseek-chat</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Par√°metros de Generaci√≥n -->
                                <div class="card card-outline card-warning mb-3">
                                    <div class="card-header">
                                        <h5 class="card-title">üéõÔ∏è Par√°metros de Generaci√≥n</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="{{ form.temperatura.id_for_label }}">
                                                        Temperatura
                                                    </label>
                                                    {{ form.temperatura }}
                                                    <div class="mt-2">
                                                        <small class="badge badge-info">Actual: <span id="tempValue">{{ form.temperatura.value|default:"0.7" }}</span></small>
                                                    </div>
                                                    {% if form.temperatura.errors %}
                                                        <div class="text-danger small">{{ form.temperatura.errors }}</div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">Creatividad (0.0-2.0). Recomendado: 0.3-0.7 para actas</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="{{ form.max_tokens.id_for_label }}">
                                                        M√°ximo de Tokens
                                                    </label>
                                                    {{ form.max_tokens }}
                                                    {% if form.max_tokens.errors %}
                                                        <div class="text-danger small">{{ form.max_tokens.errors }}</div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">Longitud m√°xima de respuesta (100-32000)</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="{{ form.timeout.id_for_label }}">
                                                        Timeout (seg)
                                                    </label>
                                                    {{ form.timeout }}
                                                    {% if form.timeout.errors %}
                                                        <div class="text-danger small">{{ form.timeout.errors }}</div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">Tiempo m√°ximo de espera (10-300)</small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Par√°metros adicionales espec√≠ficos -->
                                        <div class="row" id="parametrosAdicionales">
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="{{ form.top_p.id_for_label }}">
                                                        Top P
                                                    </label>
                                                    {{ form.top_p }}
                                                    {% if form.top_p.errors %}
                                                        <div class="text-danger small">{{ form.top_p.errors }}</div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">Control de diversidad (0.0-1.0)</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="{{ form.frequency_penalty.id_for_label }}">
                                                        Frequency Penalty
                                                    </label>
                                                    {{ form.frequency_penalty }}
                                                    {% if form.frequency_penalty.errors %}
                                                        <div class="text-danger small">{{ form.frequency_penalty.errors }}</div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">Penaliza repetici√≥n (-2.0 a 2.0)</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-group">
                                                    <label for="{{ form.presence_penalty.id_for_label }}">
                                                        Presence Penalty
                                                    </label>
                                                    {{ form.presence_penalty }}
                                                    {% if form.presence_penalty.errors %}
                                                        <div class="text-danger small">{{ form.presence_penalty.errors }}</div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">Penaliza temas repetidos (-2.0 a 2.0)</small>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="{{ form.stop_sequences.id_for_label }}">
                                                        Secuencias de Parada
                                                    </label>
                                                    {{ form.stop_sequences }}
                                                    {% if form.stop_sequences.errors %}
                                                        <div class="text-danger small">{{ form.stop_sequences.errors }}</div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">Separadas por comas. Ej: \\n, STOP, ###</small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="{{ form.costo_por_1k_tokens.id_for_label }}">
                                                        Costo por 1K Tokens (USD)
                                                    </label>
                                                    {{ form.costo_por_1k_tokens }}
                                                    {% if form.costo_por_1k_tokens.errors %}
                                                        <div class="text-danger small">{{ form.costo_por_1k_tokens.errors }}</div>
                                                    {% endif %}
                                                    <small class="form-text text-muted">Para c√°lculo de costos estimados</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Prompt Sistema Global -->
                                <div class="card card-outline card-success mb-3">
                                    <div class="card-header">
                                        <h5 class="card-title">üí¨ Configuraci√≥n de Prompt</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-group">
                                            <label for="{{ form.prompt_sistema_global.id_for_label }}">
                                                Prompt del Sistema Global
                                            </label>
                                            {{ form.prompt_sistema_global }}
                                            {% if form.prompt_sistema_global.errors %}
                                                <div class="text-danger small">{{ form.prompt_sistema_global.errors }}</div>
                                            {% endif %}
                                            <small class="form-text text-muted">
                                                Instrucciones adicionales que se enviar√°n con cada solicitud a este proveedor. 
                                                Puedes especificar el estilo, formato o comportamiento deseado.
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Estado -->
                                <div class="form-group">
                                    <div class="custom-control custom-switch">
                                        {{ form.activo }}
                                        <label class="custom-control-label" for="{{ form.activo.id_for_label }}">
                                            <strong>Proveedor Activo</strong>
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">Los proveedores inactivos no aparecer√°n en las opciones de selecci√≥n</small>
                                    {% if form.activo.errors %}
                                        <div class="text-danger small">{{ form.activo.errors }}</div>
                                    {% endif %}
                                </div>

                            </div>
                            
                            <div class="card-footer">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> 
                                    {% if proveedor %}Actualizar{% else %}Crear{% endif %} Proveedor
                                </button>
                                <a href="{% url 'generador_actas:proveedores_lista' %}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancelar
                                </a>
                                <button type="button" class="btn btn-info" onclick="cargarConfiguracionDefecto()">
                                    <i class="fas fa-magic"></i> Cargar Valores por Defecto
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <!-- Ayuda sobre tipos de proveedor -->
                    <div class="card card-info">
                        <div class="card-header">
                            <h3 class="card-title">üí° Informaci√≥n sobre Proveedores</h3>
                        </div>
                        <div class="card-body">
                            <div id="proveedorInfo">
                                <h6><strong>Tipos de Proveedor:</strong></h6>
                                <ul class="list-unstyled">
                                    <li><strong>OpenAI:</strong> GPT-4o, GPT-4, GPT-3.5-turbo</li>
                                    <li><strong>Anthropic:</strong> Claude-3.5 Sonnet, Claude-3 Haiku</li>
                                    <li><strong>DeepSeek:</strong> deepseek-chat, deepseek-coder</li>
                                    <li><strong>Google:</strong> Gemini-1.5 Pro, Gemini-1.5 Flash</li>
                                    <li><strong>Groq:</strong> Llama-3.1, Mixtral, Gemma2</li>
                                    <li><strong>Ollama:</strong> Modelos locales (Llama, Mistral)</li>
                                    <li><strong>LM Studio:</strong> Modelos locales via LM Studio</li>
                                </ul>
                            </div>
                            
                            <h6><strong>Par√°metros Recomendados para Actas:</strong></h6>
                            <ul class="list-unstyled">
                                <li><strong>Temperatura:</strong> 0.3-0.7</li>
                                <li><strong>Max Tokens:</strong> 2000-4000</li>
                                <li><strong>Top P:</strong> 0.9-1.0</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Prueba de conexi√≥n -->
                    <div class="card card-warning">
                        <div class="card-header">
                            <h3 class="card-title">üîß Prueba de Conexi√≥n</h3>
                        </div>
                        <div class="card-body">
                            <p>Despu√©s de guardar el proveedor, podr√°s probar la conexi√≥n.</p>
                            <div id="testSection" style="display: none;">
                                <button type="button" class="btn btn-warning btn-block" onclick="probarConexion()">
                                    <i class="fas fa-flask"></i> Probar API
                                </button>
                            </div>
                            <div id="testResult"></div>
                        </div>
                    </div>
                    
                    <!-- Modelos disponibles -->
                    <div class="card card-light">
                        <div class="card-header">
                            <h3 class="card-title">üìö Modelos Disponibles</h3>
                        </div>
                        <div class="card-body">
                            <div id="modelosDisponibles">
                                <p class="text-muted">Selecciona un tipo de proveedor para ver los modelos disponibles.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
// Datos de modelos por proveedor
const modelosPorProveedor = {{ modelos_por_proveedor|safe }};

document.addEventListener('DOMContentLoaded', function() {
    // Referencias a elementos
    const tipoSelect = document.getElementById('{{ form.tipo.id_for_label }}');
    const modeloInput = document.getElementById('{{ form.modelo.id_for_label }}');
    const temperaturaInput = document.getElementById('{{ form.temperatura.id_for_label }}');
    const apiUrlInput = document.getElementById('{{ form.api_url.id_for_label }}');
    
    // Actualizar valor de temperatura en tiempo real
    if (temperaturaInput) {
        temperaturaInput.addEventListener('input', function() {
            document.getElementById('tempValue').textContent = this.value;
        });
    }
    
    // Manejar cambio de tipo de proveedor
    if (tipoSelect) {
        tipoSelect.addEventListener('change', function() {
            const tipo = this.value;
            actualizarModelosDisponibles(tipo);
            cargarConfiguracionPorDefecto(tipo);
        });
        
        // Cargar modelos inicial
        if (tipoSelect.value) {
            actualizarModelosDisponibles(tipoSelect.value);
        }
    }
});

function actualizarModelosDisponibles(tipo) {
    const modelosDiv = document.getElementById('modelosDisponibles');
    const datalist = document.getElementById('modelos_disponibles');
    
    if (!tipo) {
        modelosDiv.innerHTML = '<p class="text-muted">Selecciona un tipo de proveedor.</p>';
        datalist.innerHTML = '';
        return;
    }
    
    // Obtener modelos desde la API
    fetch(`{% url 'generador_actas:api_modelos_proveedor' 'TIPO' %}`.replace('TIPO', tipo))
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modelos = data.modelos;
            
            // Actualizar datalist
            datalist.innerHTML = '';
            modelos.forEach(modelo => {
                const option = document.createElement('option');
                option.value = modelo;
                datalist.appendChild(option);
            });
            
            // Actualizar panel de ayuda
            let html = `<h6><strong>Modelos para ${tipo.toUpperCase()}:</strong></h6><ul class="list-unstyled">`;
            modelos.forEach(modelo => {
                html += `<li><code>${modelo}</code></li>`;
            });
            html += '</ul>';
            modelosDiv.innerHTML = html;
        }
    })
    .catch(error => {
        console.error('Error obteniendo modelos:', error);
    });
}

function cargarConfiguracionPorDefecto(tipo) {
    if (!tipo) return;
    
    fetch(`{% url 'generador_actas:api_configuracion_defecto' 'TIPO' %}`.replace('TIPO', tipo))
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const config = data.configuracion;
            
            // Aplicar configuraci√≥n por defecto solo si los campos est√°n vac√≠os
            if (config.api_url && !document.getElementById('{{ form.api_url.id_for_label }}').value) {
                document.getElementById('{{ form.api_url.id_for_label }}').value = config.api_url;
            }
            if (config.modelo && !document.getElementById('{{ form.modelo.id_for_label }}').value) {
                document.getElementById('{{ form.modelo.id_for_label }}').value = config.modelo;
            }
            if (config.temperatura && !document.getElementById('{{ form.temperatura.id_for_label }}').value) {
                document.getElementById('{{ form.temperatura.id_for_label }}').value = config.temperatura;
                document.getElementById('tempValue').textContent = config.temperatura;
            }
            if (config.max_tokens && !document.getElementById('{{ form.max_tokens.id_for_label }}').value) {
                document.getElementById('{{ form.max_tokens.id_for_label }}').value = config.max_tokens;
            }
        }
    })
    .catch(error => {
        console.error('Error obteniendo configuraci√≥n por defecto:', error);
    });
}

function cargarConfiguracionDefecto() {
    const tipoSelect = document.getElementById('{{ form.tipo.id_for_label }}');
    const tipo = tipoSelect.value;
    
    if (!tipo) {
        alert('Primero selecciona un tipo de proveedor');
        return;
    }
    
    if (confirm('¬øCargar los valores por defecto? Esto sobrescribir√° los valores actuales.')) {
        fetch(`{% url 'generador_actas:api_configuracion_defecto' 'TIPO' %}`.replace('TIPO', tipo))
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const config = data.configuracion;
                
                // Aplicar configuraci√≥n forzadamente
                Object.keys(config).forEach(key => {
                    const field = document.getElementById(`id_${key}`);
                    if (field && config[key] !== null && config[key] !== undefined) {
                        field.value = config[key];
                        if (key === 'temperatura') {
                            document.getElementById('tempValue').textContent = config[key];
                        }
                    }
                });
                
                alert('Configuraci√≥n por defecto cargada exitosamente');
            }
        })
        .catch(error => {
            alert('Error al cargar configuraci√≥n por defecto');
            console.error(error);
        });
    }
}

function toggleApiKey() {
    const input = document.getElementById('{{ form.api_key.id_for_label }}');
    const icon = document.getElementById('eyeIcon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function probarConexion() {
    // Esta funci√≥n se implementar√° despu√©s de crear el proveedor
    alert('Guarda el proveedor primero para poder probar la conexi√≥n');
}
</script>

{% endblock content %}

{% block javascripts %}
    <script src="{% static 'generador_actas/js/proveedores-ia.js' %}"></script>
    <script>
        // Configurar ProveedoresIA con datos del template
        document.addEventListener('DOMContentLoaded', function() {
            ProveedoresIA.init({
                urls: {
                    probar_conexion: '{% url "generador_actas:api_probar_conexion_proveedor" %}',
                    modelos_proveedor: '{% url "generador_actas:api_modelos_proveedor" "TIPO" %}'.replace('TIPO', ''),
                    configuracion_defecto: '{% url "generador_actas:api_configuracion_defecto" "TIPO" %}'.replace('TIPO', '')
                },
                csrfToken: '{{ csrf_token }}'
            });
        });
    </script>
{% endblock %}