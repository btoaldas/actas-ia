{% extends 'layouts/base.html' %}

{% block title %} {{ page_title }} - Sistema de Actas Municipales {% endblock title %}

{% block content %}
<!-- Content Wrapper -->
<div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">🎤 {{ page_title }}</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="#">Procesamiento IA</a></li>
                        <li class="breadcrumb-item active">Transcripción</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            
            <!-- Estadísticas -->
            <div class="row">
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-primary">
                        <div class="inner">
                            <h3>{{ archivos_demo|length }}</h3>
                            <p>Archivos Procesados</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-file-audio"></i>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-success">
                        <div class="inner">
                            <h3>96.5%</h3>
                            <p>Precisión Promedio</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-warning">
                        <div class="inner">
                            <h3>4h 17m</h3>
                            <p>Tiempo Total Audio</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-info">
                        <div class="inner">
                            <h3>Whisper v3</h3>
                            <p>Modelo IA Activo</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-robot"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Panel de Subida de Archivos -->
                <div class="col-md-4">
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-upload"></i> Subir Audio
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="upload-zone" style="border: 2px dashed #007bff; padding: 20px; text-align: center; margin-bottom: 20px;">
                                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                <p><strong>Arrastra archivos aquí</strong><br>o haz clic para seleccionar</p>
                                <input type="file" id="audio-upload" accept="audio/*" multiple style="display: none;">
                                <button class="btn btn-primary" onclick="document.getElementById('audio-upload').click()">
                                    Seleccionar Archivos
                                </button>
                            </div>
                            
                            <div class="form-group">
                                <label>Configuración de Transcripción</label>
                                <select class="form-control">
                                    <option>Español (Ecuador) - Alta Precisión</option>
                                    <option>Español (General) - Rápido</option>
                                    <option>Detección Automática</option>
                                </select>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="auto-analyze" checked>
                                <label class="form-check-label" for="auto-analyze">
                                    Análisis automático de contenido
                                </label>
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="speaker-detection" checked>
                                <label class="form-check-label" for="speaker-detection">
                                    Identificación de participantes
                                </label>
                            </div>
                            
                            <button class="btn btn-success btn-block mt-3">
                                <i class="fas fa-play"></i> Iniciar Transcripción
                            </button>
                        </div>
                    </div>

                    <!-- Grabación en Vivo -->
                    <div class="card card-success">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-microphone"></i> Grabación en Vivo
                            </h3>
                        </div>
                        <div class="card-body text-center">
                            <div id="recording-controls">
                                <button id="start-recording" class="btn btn-success btn-lg">
                                    <i class="fas fa-microphone"></i> Iniciar Grabación
                                </button>
                                <button id="stop-recording" class="btn btn-danger btn-lg" style="display: none;">
                                    <i class="fas fa-stop"></i> Detener
                                </button>
                            </div>
                            
                            <div id="recording-info" style="display: none; margin-top: 15px;">
                                <div class="bg-danger text-white p-2 rounded">
                                    <i class="fas fa-circle blink"></i> Grabando...
                                    <span id="recording-time">00:00</span>
                                </div>
                            </div>
                            
                            <small class="text-muted mt-2 d-block">
                                La transcripción se realizará automáticamente
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Lista de Archivos -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-list"></i> Archivos de Audio
                            </h3>
                            <div class="card-tools">
                                <button class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-filter"></i> Filtrar
                                </button>
                                <button class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-download"></i> Exportar
                                </button>
                            </div>
                        </div>
                        
                        <div class="card-body p-0">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Archivo</th>
                                        <th>Duración</th>
                                        <th>Estado</th>
                                        <th>Confianza</th>
                                        <th>Fecha</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for archivo in archivos_demo %}
                                    <tr>
                                        <td>
                                            <i class="fas fa-file-audio text-primary mr-2"></i>
                                            <strong>{{ archivo.nombre }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge badge-info">{{ archivo.duracion }}</span>
                                        </td>
                                        <td>
                                            {% if archivo.estado == 'Completado' %}
                                                <span class="badge badge-success">
                                                    <i class="fas fa-check"></i> {{ archivo.estado }}
                                                </span>
                                            {% elif archivo.estado == 'En Proceso' %}
                                                <span class="badge badge-warning">
                                                    <i class="fas fa-spinner fa-spin"></i> {{ archivo.estado }}
                                                </span>
                                            {% else %}
                                                <span class="badge badge-secondary">{{ archivo.estado }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if archivo.confianza > 0 %}
                                                <div class="progress" style="width: 60px; height: 20px;">
                                                    {% if archivo.confianza >= 90 %}
                                                        <div class="progress-bar bg-success" style="width: {{ archivo.confianza }}%"></div>
                                                    {% elif archivo.confianza >= 75 %}
                                                        <div class="progress-bar bg-warning" style="width: {{ archivo.confianza }}%"></div>
                                                    {% else %}
                                                        <div class="progress-bar bg-danger" style="width: {{ archivo.confianza }}%"></div>
                                                    {% endif %}
                                                </div>
                                                <small>{{ archivo.confianza }}%</small>
                                            {% else %}
                                                <span class="text-muted">Pendiente</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small>{{ archivo.fecha_subida }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary" title="Reproducir">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-success" title="Ver Transcripción">
                                                    <i class="fas fa-file-alt"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-info" title="Descargar">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" title="Reprocesar">
                                                    <i class="fas fa-sync"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Transcripción en Tiempo Real -->
                    <div class="card card-info">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-comments"></i> Vista Previa de Transcripción
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="transcription-preview" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 5px;">
                                <p class="text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    Seleccione un archivo para ver la transcripción o inicie una grabación en vivo.
                                </p>
                                
                                <!-- Ejemplo de transcripción -->
                                <div style="display: none;" id="sample-transcription">
                                    <div class="mb-3">
                                        <strong class="text-primary">[00:01:23] Alcaldesa María Rodríguez:</strong>
                                        <p>Buenos días, damos inicio a la sesión ordinaria del Concejo Municipal correspondiente al día de hoy. Verificamos el quórum reglamentario con la presencia de...</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <strong class="text-success">[00:02:45] Secretaria Ana García:</strong>
                                        <p>Señora Alcaldesa, informo que se encuentran presentes ocho de los nueve concejales, por lo que tenemos quórum para sesionar...</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <strong class="text-warning">[00:04:12] Concejal Luis Vargas:</strong>
                                        <p>Solicito la palabra para presentar una moción sobre el presupuesto municipal...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-outline-primary btn-sm" onclick="toggleSampleTranscription()">
                                    <i class="fas fa-eye"></i> Ver Ejemplo
                                </button>
                                <button class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-copy"></i> Copiar Texto
                                </button>
                                <button class="btn btn-outline-warning btn-sm">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-file-export"></i> Exportar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>
</div>

<style>
.blink {
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
}

.upload-zone {
    transition: background-color 0.3s ease;
}

.upload-zone:hover {
    background-color: #f8f9fa;
}
</style>

<script>
let isRecording = false;
let recordingStartTime;
let recordingInterval;

document.getElementById('start-recording').addEventListener('click', function() {
    startRecording();
});

document.getElementById('stop-recording').addEventListener('click', function() {
    stopRecording();
});

function startRecording() {
    isRecording = true;
    recordingStartTime = Date.now();
    
    document.getElementById('start-recording').style.display = 'none';
    document.getElementById('stop-recording').style.display = 'inline-block';
    document.getElementById('recording-info').style.display = 'block';
    
    recordingInterval = setInterval(updateRecordingTime, 1000);
    
    // Simular transcripción en tiempo real
    setTimeout(() => {
        startLiveTranscription();
    }, 3000);
}

function stopRecording() {
    isRecording = false;
    
    document.getElementById('start-recording').style.display = 'inline-block';
    document.getElementById('stop-recording').style.display = 'none';
    document.getElementById('recording-info').style.display = 'none';
    
    clearInterval(recordingInterval);
    
    // Simular finalización del proceso
    toastr.success('Grabación completada. Procesando transcripción...', 'Éxito');
}

function updateRecordingTime() {
    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    
    document.getElementById('recording-time').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function startLiveTranscription() {
    const preview = document.getElementById('transcription-preview');
    preview.innerHTML = '<p class="text-success"><i class="fas fa-microphone"></i> Transcribiendo en tiempo real...</p>';
    
    // Simular texto apareciendo gradualmente
    let sampleText = "Buenos días, damos inicio a la sesión...";
    let index = 0;
    
    const typeInterval = setInterval(() => {
        if (index < sampleText.length && isRecording) {
            preview.innerHTML = `<p class="text-primary">[Transcripción en vivo] ${sampleText.substring(0, index + 1)}<span class="blink">|</span></p>`;
            index++;
        } else {
            clearInterval(typeInterval);
        }
    }, 100);
}

function toggleSampleTranscription() {
    const sample = document.getElementById('sample-transcription');
    const preview = document.getElementById('transcription-preview');
    
    if (sample.style.display === 'none') {
        sample.style.display = 'block';
        preview.querySelector('p').style.display = 'none';
    } else {
        sample.style.display = 'none';
        preview.querySelector('p').style.display = 'block';
    }
}

// Drag and drop functionality
const uploadZone = document.querySelector('.upload-zone');

uploadZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadZone.style.backgroundColor = '#e3f2fd';
});

uploadZone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadZone.style.backgroundColor = '';
});

uploadZone.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadZone.style.backgroundColor = '';
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        toastr.info(`${files.length} archivo(s) seleccionado(s). Iniciando procesamiento...`, 'Archivos Recibidos');
    }
});
</script>
{% endblock content %}
