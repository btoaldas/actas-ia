{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock title %}

{% block extrastyle %}
  <style>
    .form-section {
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    .form-section h5 {
      color: #007bff;
      margin-bottom: 15px;
    }
    .help-text {
      font-size: 0.875rem;
      color: #6c757d;
    }
    .required-field::after {
      content: " *";
      color: #dc3545;
    }
    
    /* Estilos para Drag & Drop */
    .drag-drop-area {
      border: 2px dashed #007bff;
      border-radius: 8px;
      padding: 40px 20px;
      text-align: center;
      background-color: #f8f9fa;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      margin-bottom: 15px;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .drag-drop-area:hover {
      border-color: #0056b3;
      background-color: #e3f2fd;
    }
    
    .drag-drop-area.dragover {
      border-color: #28a745;
      background-color: #d4edda;
      transform: scale(1.02);
    }
    
    .drag-drop-area .upload-icon {
      font-size: 48px;
      color: #007bff;
      margin-bottom: 15px;
    }
    
    .drag-drop-area.dragover .upload-icon {
      color: #28a745;
    }
    
    .file-input-hidden {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-list {
      margin-top: 15px;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: #e9ecef;
      border-radius: 4px;
      margin-bottom: 5px;
    }
    
    .file-item .file-info {
      display: flex;
      align-items: center;
    }
    
    .file-item .file-icon {
      margin-right: 8px;
      width: 20px;
    }
    
    .file-item .remove-file {
      color: #dc3545;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 3px;
    }
    
    .file-item .remove-file:hover {
      background-color: #dc3545;
      color: white;
    }
  </style>
{% endblock extrastyle %}

{% block bodyclass %}hold-transition sidebar-mini{% endblock bodyclass %}

{% block content %}
  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>
              <i class="fas fa-calendar-plus"></i> {{ titulo }}
            </h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="{% url 'transparencia_index' %}">Inicio</a></li>
              <li class="breadcrumb-item"><a href="{% url 'eventos_calendario' %}">Eventos</a></li>
              <li class="breadcrumb-item active">{{ titulo }}</li>
            </ol>
          </div>
        </div>
      </div>
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        <div class="row justify-content-center">
          <div class="col-md-8">
            
            <!-- Formulario de evento -->
            <div class="card card-primary">
              <div class="card-header">
                <h3 class="card-title">
                  <i class="fas fa-edit"></i> Información del Evento
                </h3>
              </div>
              
              <form method="post" enctype="multipart/form-data" novalidate>
                {% csrf_token %}
                
                <div class="card-body">
                  
                  <!-- Información básica -->
                  <div class="form-section">
                    <h5><i class="fas fa-info-circle"></i> Información Básica</h5>
                    
                    <div class="row">
                      <div class="col-md-12">
                        <div class="form-group">
                          <label for="{{ form.titulo.id_for_label }}" class="required-field">
                            {{ form.titulo.label }}
                          </label>
                          {{ form.titulo }}
                          {% if form.titulo.errors %}
                            <div class="text-danger">
                              {% for error in form.titulo.errors %}
                                <small>{{ error }}</small>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.tipo.id_for_label }}" class="required-field">
                            {{ form.tipo.label }}
                          </label>
                          {{ form.tipo }}
                          {% if form.tipo.errors %}
                            <div class="text-danger">
                              {% for error in form.tipo.errors %}
                                <small>{{ error }}</small>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.estado.id_for_label }}" class="required-field">
                            {{ form.estado.label }}
                          </label>
                          {{ form.estado }}
                          {% if form.estado.errors %}
                            <div class="text-danger">
                              {% for error in form.estado.errors %}
                                <small>{{ error }}</small>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    
                    <div class="form-group">
                      <label for="{{ form.descripcion.id_for_label }}">
                        {{ form.descripcion.label }}
                      </label>
                      {{ form.descripcion }}
                      {% if form.descripcion.errors %}
                        <div class="text-danger">
                          {% for error in form.descripcion.errors %}
                            <small>{{ error }}</small>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  </div>

                  <!-- Fechas y horarios -->
                  <div class="form-section">
                    <h5><i class="fas fa-clock"></i> Fechas y Horarios</h5>
                    
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.fecha_inicio.id_for_label }}" class="required-field">
                            {{ form.fecha_inicio.label }}
                          </label>
                          {{ form.fecha_inicio }}
                          {% if form.fecha_inicio.errors %}
                            <div class="text-danger">
                              {% for error in form.fecha_inicio.errors %}
                                <small>{{ error }}</small>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.fecha_fin.id_for_label }}" class="required-field">
                            {{ form.fecha_fin.label }}
                          </label>
                          {{ form.fecha_fin }}
                          {% if form.fecha_fin.errors %}
                            <div class="text-danger">
                              {% for error in form.fecha_fin.errors %}
                                <small>{{ error }}</small>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Ubicación -->
                  <div class="form-section">
                    <h5><i class="fas fa-map-marker-alt"></i> Ubicación</h5>
                    
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.ubicacion.id_for_label }}" class="required-field">
                            {{ form.ubicacion.label }}
                          </label>
                          {{ form.ubicacion }}
                          {% if form.ubicacion.errors %}
                            <div class="text-danger">
                              {% for error in form.ubicacion.errors %}
                                <small>{{ error }}</small>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.direccion.id_for_label }}">
                            {{ form.direccion.label }}
                          </label>
                          {{ form.direccion }}
                          {% if form.direccion.help_text %}
                            <small class="help-text">{{ form.direccion.help_text }}</small>
                          {% endif %}
                          {% if form.direccion.errors %}
                            <div class="text-danger">
                              {% for error in form.direccion.errors %}
                                <small>{{ error }}</small>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.responsable.id_for_label }}" class="required-field">
                            {{ form.responsable.label }}
                          </label>
                          {{ form.responsable }}
                          {% if form.responsable.errors %}
                            <div class="text-danger">
                              {% for error in form.responsable.errors %}
                                <small>{{ error }}</small>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Configuración de visibilidad -->
                  <div class="form-section">
                    <h5><i class="fas fa-eye"></i> Configuración de Visibilidad</h5>
                    
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.visibilidad.id_for_label }}" class="required-field">
                            {{ form.visibilidad.label }}
                          </label>
                          {{ form.visibilidad }}
                          {% if form.visibilidad.errors %}
                            <div class="text-danger">
                              {% for error in form.visibilidad.errors %}
                                <small>{{ error }}</small>
                              {% endfor %}
                            </div>
                          {% endif %}
                          <small class="help-text">
                            <strong>Público:</strong> Visible para todos<br>
                            <strong>Privado:</strong> Solo usuarios invitados<br>
                            <strong>Restringido:</strong> Solo administradores
                          </small>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.capacidad_maxima.id_for_label }}">
                            {{ form.capacidad_maxima.label }}
                          </label>
                          {{ form.capacidad_maxima }}
                          {% if form.capacidad_maxima.help_text %}
                            <small class="help-text">{{ form.capacidad_maxima.help_text }}</small>
                          {% endif %}
                          {% if form.capacidad_maxima.errors %}
                            <div class="text-danger">
                              {% for error in form.capacidad_maxima.errors %}
                                <small>{{ error }}</small>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>

                    <div class="form-group">
                      <label for="{{ form.asistentes_invitados.id_for_label }}">
                        {{ form.asistentes_invitados.label }}
                      </label>
                      {{ form.asistentes_invitados }}
                      {% if form.asistentes_invitados.help_text %}
                        <small class="help-text">{{ form.asistentes_invitados.help_text }}</small>
                      {% endif %}
                      {% if form.asistentes_invitados.errors %}
                        <div class="text-danger">
                          {% for error in form.asistentes_invitados.errors %}
                            <small>{{ error }}</small>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  </div>

                  <!-- Imagen del evento -->
                  <div class="form-section">
                    <h5><i class="fas fa-image"></i> Imagen del Evento</h5>
                    
                    <div class="form-group">
                      <label for="{{ form.imagen_evento.id_for_label }}">
                        {{ form.imagen_evento.label }}
                      </label>
                      {{ form.imagen_evento }}
                      {% if form.imagen_evento.help_text %}
                        <small class="help-text">{{ form.imagen_evento.help_text }}</small>
                      {% endif %}
                      {% if form.imagen_evento.errors %}
                        <div class="text-danger">
                          {% for error in form.imagen_evento.errors %}
                            <small>{{ error }}</small>
                          {% endfor %}
                        </div>
                      {% endif %}
                      
                      {% if evento and evento.imagen_evento %}
                        <div class="mt-2">
                          <img src="{{ evento.imagen_evento.url }}" alt="Imagen actual" 
                               class="img-thumbnail" style="max-width: 200px;">
                          <p class="text-muted mt-1">Imagen actual</p>
                        </div>
                      {% endif %}
                    </div>
                  </div>

                  <!-- Invitaciones -->
                  <div class="form-section">
                    <h5><i class="fas fa-users"></i> Invitaciones</h5>
                    
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.asistentes_invitados.id_for_label }}">
                            {{ form.asistentes_invitados.label }}
                          </label>
                          <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ced4da; padding: 10px; border-radius: 4px;">
                            {{ form.asistentes_invitados }}
                          </div>
                          <small class="help-text">
                            Seleccione los usuarios del sistema que desea invitar.
                          </small>
                          {% if form.asistentes_invitados.errors %}
                            <div class="text-danger">
                              {% for error in form.asistentes_invitados.errors %}
                                <small>{{ error }}</small>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      
                      <div class="col-md-6">
                        <div class="form-group">
                          <label for="{{ form.invitados_externos.id_for_label }}">
                            {{ form.invitados_externos.label }}
                          </label>
                          {{ form.invitados_externos }}
                          <small class="help-text">
                            Las invitaciones se enviarán automáticamente por correo electrónico.
                          </small>
                          {% if form.invitados_externos.errors %}
                            <div class="text-danger">
                              {% for error in form.invitados_externos.errors %}
                                <small>{{ error }}</small>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Documentos del evento -->
                  <div class="form-section">
                    <h5><i class="fas fa-file-upload"></i> Documentos del Evento</h5>
                    
                    <div class="row">
                      <div class="col-md-8">
                        <div class="form-group">
                          <label for="{{ docs_form.archivos.id_for_label }}">
                            {{ docs_form.archivos.label }}
                          </label>
                          
                          <!-- Área de Drag & Drop -->
                          <div class="drag-drop-area" id="dragDropArea">
                            <div class="upload-icon">
                              <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h5>Arrastra y suelta archivos aquí</h5>
                            <p class="text-muted mb-3">o haz clic para seleccionar archivos</p>
                            <button type="button" class="btn btn-outline-primary" id="selectFilesBtn">
                              <i class="fas fa-folder-open"></i> Explorar Archivos
                            </button>
                          </div>
                          
                          <!-- Input de archivos (estará oculto) -->
                          <div style="display: none;">
                            {{ docs_form.archivos }}
                          </div>
                          
                          <!-- Lista de archivos seleccionados -->
                          <div class="file-list" id="fileList"></div>
                          
                          {% if docs_form.archivos.help_text %}
                            <small class="help-text">{{ docs_form.archivos.help_text }}</small>
                          {% endif %}
                          {% if docs_form.archivos.errors %}
                            <div class="text-danger">
                              {% for error in docs_form.archivos.errors %}
                                <small>{{ error }}</small>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ docs_form.tipo_documento.id_for_label }}">
                            {{ docs_form.tipo_documento.label }}
                          </label>
                          {{ docs_form.tipo_documento }}
                          {% if docs_form.tipo_documento.help_text %}
                            <small class="help-text">{{ docs_form.tipo_documento.help_text }}</small>
                          {% endif %}
                          {% if docs_form.tipo_documento.errors %}
                            <div class="text-danger">
                              {% for error in docs_form.tipo_documento.errors %}
                                <small>{{ error }}</small>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    
                    <div class="row">
                      <div class="col-md-12">
                        <div class="form-check">
                          {{ docs_form.es_publico }}
                          <label class="form-check-label" for="{{ docs_form.es_publico.id_for_label }}">
                            {{ docs_form.es_publico.label }}
                          </label>
                          {% if docs_form.es_publico.help_text %}
                            <br><small class="help-text">{{ docs_form.es_publico.help_text }}</small>
                          {% endif %}
                          {% if docs_form.es_publico.errors %}
                            <div class="text-danger">
                              {% for error in docs_form.es_publico.errors %}
                                <small>{{ error }}</small>
                              {% endfor %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                      <h6><i class="fas fa-info-circle"></i> Tipos de archivo soportados:</h6>
                      <ul class="mb-0">
                        <li><strong>Documentos:</strong> PDF, DOC, DOCX, TXT, RTF</li>
                        <li><strong>Hojas de cálculo:</strong> XLS, XLSX, CSV</li>
                        <li><strong>Imágenes:</strong> JPG, JPEG, PNG, GIF, BMP</li>
                        <li><strong>Planos:</strong> DWG, DXF</li>
                        <li><strong>Comprimidos:</strong> ZIP, RAR, 7Z</li>
                        <li><strong>Tamaño máximo:</strong> 10 MB por archivo</li>
                      </ul>
                    </div>
                  </div>

                  <!-- Errores generales del formulario -->
                  {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                      {% for error in form.non_field_errors %}
                        <p>{{ error }}</p>
                      {% endfor %}
                    </div>
                  {% endif %}
                  
                  {% if docs_form.non_field_errors %}
                    <div class="alert alert-danger">
                      {% for error in docs_form.non_field_errors %}
                        <p>{{ error }}</p>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <div class="card-footer">
                  <div class="row">
                    <div class="col-md-6">
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Evento
                      </button>
                      <a href="{% url 'eventos_calendario' %}" class="btn btn-secondary ml-2">
                        <i class="fas fa-times"></i> Cancelar
                      </a>
                    </div>
                    <div class="col-md-6 text-right">
                      {% if evento %}
                        <a href="{% url 'eventos_detalle' evento.pk %}" class="btn btn-info">
                          <i class="fas fa-eye"></i> Ver Evento
                        </a>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
{% endblock content %}

{% block extra_scripts %}
  <script>
    $(document).ready(function() {
      // Auto-llenar fecha si viene como parámetro URL
      const urlParams = new URLSearchParams(window.location.search);
      const fecha = urlParams.get('fecha');
      if (fecha && !$('#id_fecha_inicio').val()) {
        $('#id_fecha_inicio').val(fecha);
        
        // Calcular fecha fin (1 hora después)
        const fechaInicio = new Date(fecha);
        fechaInicio.setHours(fechaInicio.getHours() + 1);
        const fechaFin = fechaInicio.toISOString().slice(0, 16);
        $('#id_fecha_fin').val(fechaFin);
      }
      
      // Validación en tiempo real de fechas
      $('#id_fecha_inicio, #id_fecha_fin').change(function() {
        const fechaInicio = new Date($('#id_fecha_inicio').val());
        const fechaFin = new Date($('#id_fecha_fin').val());
        
        if (fechaInicio && fechaFin && fechaFin <= fechaInicio) {
          alert('La fecha de fin debe ser posterior a la fecha de inicio');
          $('#id_fecha_fin').focus();
        }
      });
      
      // Mostrar/ocultar campo de invitados según visibilidad
      $('#id_visibilidad').change(function() {
        const visibilidad = $(this).val();
        const invitadosGroup = $('#id_asistentes_invitados').closest('.form-group');
        
        if (visibilidad === 'privado') {
          invitadosGroup.show();
        } else {
          invitadosGroup.hide();
        }
      }).trigger('change');

      // ========================================
      // DRAG & DROP PARA ARCHIVOS MÚLTIPLES
      // ========================================
      
      const dragDropArea = document.getElementById('dragDropArea');
      const fileInput = document.getElementById('id_archivos');
      const fileList = document.getElementById('fileList');
      let selectedFiles = [];

      // Verificar que los elementos existen
      if (!dragDropArea || !fileInput || !fileList) {
        console.log('Elementos de drag & drop no encontrados:');
        console.log('dragDropArea:', dragDropArea);
        console.log('fileInput:', fileInput);
        console.log('fileList:', fileList);
        return;
      }

      console.log('Elementos encontrados correctamente, inicializando drag & drop...');

      // Función para obtener icono según extensión
      function getFileIcon(fileName) {
        const ext = fileName.split('.').pop().toLowerCase();
        const iconMap = {
          'pdf': 'fas fa-file-pdf text-danger',
          'doc': 'fas fa-file-word text-primary',
          'docx': 'fas fa-file-word text-primary',
          'xls': 'fas fa-file-excel text-success',
          'xlsx': 'fas fa-file-excel text-success',
          'jpg': 'fas fa-file-image text-info',
          'jpeg': 'fas fa-file-image text-info',
          'png': 'fas fa-file-image text-info',
          'gif': 'fas fa-file-image text-info',
          'dwg': 'fas fa-drafting-compass text-warning',
          'dxf': 'fas fa-drafting-compass text-warning',
          'zip': 'fas fa-file-archive text-secondary',
          'rar': 'fas fa-file-archive text-secondary',
          '7z': 'fas fa-file-archive text-secondary',
          'txt': 'fas fa-file-alt text-dark',
          'csv': 'fas fa-file-csv text-success'
        };
        return iconMap[ext] || 'fas fa-file text-muted';
      }

      // Función para formatear tamaño de archivo
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }

      // Función para actualizar la lista de archivos
      function updateFileList() {
        fileList.innerHTML = '';
        selectedFiles.forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.innerHTML = `
            <div class="file-info">
              <i class="${getFileIcon(file.name)} file-icon"></i>
              <span><strong>${file.name}</strong> (${formatFileSize(file.size)})</span>
            </div>
            <span class="remove-file" onclick="removeFile(${index})">
              <i class="fas fa-times"></i>
            </span>
          `;
          fileList.appendChild(fileItem);
        });

        // Actualizar el input file
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;
      }

      // Función para remover archivo
      window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        updateFileList();
      };

      // Función para agregar archivos
      function addFiles(files) {
        console.log('Agregando archivos:', files.length);
        Array.from(files).forEach(file => {
          console.log('Procesando archivo:', file.name, file.size);
          // Verificar si el archivo ya está seleccionado
          if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
            selectedFiles.push(file);
            console.log('Archivo agregado:', file.name);
          } else {
            console.log('Archivo ya existe:', file.name);
          }
        });
        updateFileList();
      }

      // Event listeners para drag & drop
      dragDropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragDropArea.classList.add('dragover');
      });

      dragDropArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragDropArea.classList.remove('dragover');
      });

      dragDropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragDropArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        console.log('Archivos soltados:', files.length);
        
        if (files.length > 0) {
          addFiles(files);
        }
      });

      // Click en el botón para abrir selector
      const selectFilesBtn = document.getElementById('selectFilesBtn');
      if (selectFilesBtn) {
        selectFilesBtn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          fileInput.click();
        });
      }

      // Click en el área para abrir selector (excepto en el botón)
      dragDropArea.addEventListener('click', (e) => {
        if (e.target.id !== 'selectFilesBtn' && !e.target.closest('#selectFilesBtn')) {
          fileInput.click();
        }
      });

      // Cuando se seleccionan archivos mediante el input
      fileInput.addEventListener('change', (e) => {
        console.log('Archivos seleccionados vía input:', e.target.files.length);
        addFiles(e.target.files);
      });

      console.log('Drag & Drop inicializado correctamente');
    });
  </script>
{% endblock extra_scripts %}
