{% extends "layouts/base.html" %}
{% load static %}

{% block title %} Portal Ciudadano - Actas Municipales {% endblock title %}

{% block bodyclass %} hold-transition sidebar-mini layout-fixed layout-navbar-fixed layout-footer-fixed {% endblock bodyclass %}

{% block content %}
  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1><i class="fas fa-globe mr-2 text-primary"></i>Portal Ciudadano</h1>
            <p class="mb-0 text-muted">Consulta transparente de actas municipales</p>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
              <li class="breadcrumb-item active">Portal Ciudadano</li>
            </ol>
          </div>
        </div>
      </div>
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
        
        <!-- Métricas (envolvemos en card colapsable) -->
        <div class="card card-outline card-secondary mb-4" id="metrics-card">
          <div class="card-header py-2">
            <h3 class="card-title"><i class="fas fa-chart-bar mr-2"></i>Métricas Generales</h3>
            <div class="card-tools">
              <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Colapsar / Expandir">
                <i class="fas fa-minus"></i>
              </button>
            </div>
          </div>
          <div class="card-body pt-3 pb-1">
            <div class="row mb-3">
              <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                  <div class="inner">
                    <h3>{{ total_actas }}</h3>
                    <p>Total de Actas</p>
                  </div>
                  <div class="icon">
                    <i class="fas fa-file-alt"></i>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                  <div class="inner">
                    <h3>{{ actas_publicas }}</h3>
                    <p>Acceso Público</p>
                  </div>
                  <div class="icon">
                    <i class="fas fa-globe"></i>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                  <div class="inner">
                    <h3>{{ actas_este_mes }}</h3>
                    <p>Este Mes</p>
                  </div>
                  <div class="icon">
                    <i class="fas fa-calendar"></i>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-6">
                <div class="small-box bg-primary">
                  <div class="inner">
                    <h3>{{ precision_promedio }}%</h3>
                    <p>Precisión IA</p>
                  </div>
                  <div class="icon">
                    <i class="fas fa-brain"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                  <div class="inner">
                    <h3>{{ visualizaciones_mes }}</h3>
                    <p>Vistas Este Mes</p>
                  </div>
                  <div class="icon">
                    <i class="fas fa-eye"></i>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-6">
                <div class="small-box bg-secondary">
                  <div class="inner">
                    <h3>{{ descargas_mes }}</h3>
                    <p>Descargas Este Mes</p>
                  </div>
                  <div class="icon">
                    <i class="fas fa-download"></i>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-6">
                <div class="small-box bg-light">
                  <div class="inner">
                    <h3>{{ porcentaje_ia }}%</h3>
                    <p>Actas con IA</p>
                  </div>
                  <div class="icon">
                    <i class="fas fa-robot"></i>
                  </div>
                </div>
              </div>
              <div class="col-lg-3 col-6">
                <div class="small-box bg-dark">
                  <div class="inner">
                    <h3>
                      {% if dias_ultima_actualizacion == 0 %}Hoy{% elif dias_ultima_actualizacion == 1 %}Ayer{% else %}{{ dias_ultima_actualizacion }} días{% endif %}
                    </h3>
                    <p>Última Actualización</p>
                  </div>
                  <div class="icon">
                    <i class="fas fa-sync-alt"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Panel de búsqueda y filtros (colapsado por defecto) -->
        <div class="card card-outline card-primary collapsed-card" id="filters-card">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-search mr-2"></i>Búsqueda y Filtros</h3>
            <div class="card-tools">
              <button type="button" class="btn btn-tool" data-card-widget="collapse">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <form method="GET" id="search-form">
              <div class="row">
                <!-- Búsqueda principal -->
                <div class="col-md-12 mb-3">
                  <div class="input-group input-group-lg">
                    <input type="search" 
                           class="form-control form-control-lg" 
                           placeholder="Buscar en actas municipales (título, número, contenido)..." 
                           name="search"
                           value="{{ search_query }}"
                           id="search-input">
                    <div class="input-group-append">
                      <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-search"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="row">
                <!-- Tipo de sesión -->
                <div class="col-md-3">
                  <div class="form-group">
                    <label for="tipo_sesion">Tipo de Sesión:</label>
                    <select class="form-control select2" name="tipo_sesion" id="tipo_sesion">
                      <option value="">Todos los tipos</option>
                      {% for tipo in tipos_sesion %}
                        <option value="{{ tipo.nombre }}" 
                                {% if filters.tipo_sesion == tipo.nombre %}selected{% endif %}>
                          {{ tipo.get_nombre_display }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                
                <!-- Estado -->
                <div class="col-md-3">
                  <div class="form-group">
                    <label for="estado">Estado:</label>
                    <select class="form-control select2" name="estado" id="estado">
                      <option value="">Todos los estados</option>
                      {% for estado in estados %}
                        <option value="{{ estado.nombre }}" 
                                {% if filters.estado == estado.nombre %}selected{% endif %}>
                          {{ estado.get_nombre_display }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                
                <!-- Acceso -->
                <div class="col-md-3">
                  <div class="form-group">
                    <label for="acceso">Nivel de Acceso:</label>
                    <select class="form-control select2" name="acceso" id="acceso">
                      <option value="">Todos los niveles</option>
                      {% for value, label in acceso_choices %}
                        <option value="{{ value }}" 
                                {% if filters.acceso == value %}selected{% endif %}>
                          {{ label }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                
                <!-- Ordenar por -->
                <div class="col-md-3">
                  <div class="form-group">
                    <label for="orden">Ordenar por:</label>
                    <select class="form-control select2" name="orden" id="orden">
                      {% for value, label in orden_choices %}
                        <option value="{{ value }}" 
                                {% if filters.orden == value %}selected{% endif %}>
                          {{ label }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              </div>
              
              <div class="row">
                <!-- Fecha desde -->
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="fecha_desde">Fecha desde:</label>
                    <input type="date" 
                           class="form-control" 
                           name="fecha_desde" 
                           value="{{ filters.fecha_desde }}"
                           id="fecha_desde">
                  </div>
                </div>
                
                <!-- Fecha hasta -->
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="fecha_hasta">Fecha hasta:</label>
                    <input type="date" 
                           class="form-control" 
                           name="fecha_hasta" 
                           value="{{ filters.fecha_hasta }}"
                           id="fecha_hasta">
                  </div>
                </div>
                
                <!-- Botones -->
                <div class="col-md-4">
                  <div class="form-group">
                    <label>&nbsp;</label>
                    <div class="d-block">
                      <button type="submit" class="btn btn-primary mr-2">
                        <i class="fas fa-search"></i> Buscar
                      </button>
                      <a href="{% url 'portal_ciudadano' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Limpiar
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>

        <!-- Resultados (vista en grid) -->
        <div class="card card-outline card-lightblue" id="resultados-card">
          <div class="card-header">
            <h3 class="card-title mb-0">
              <i class="fas fa-folder-open mr-2"></i>
              Actas Municipales
              {% if search_query %}<small class="text-muted">&nbsp;— "{{ search_query }}"</small>{% endif %}
            </h3>
            <div class="card-tools d-flex align-items-center">
              <!-- Toolbar de ordenación rápida -->
              <div class="btn-group btn-group-sm mr-2 d-none d-md-inline-flex" role="group" aria-label="Orden rápido">
                {% for value, label in orden_toolbar %}
                  <a href="?{% for key, val in request.GET.items %}{% if key != 'orden' and key != 'page' %}{{ key }}={{ val|urlencode }}&{% endif %}{% endfor %}orden={{ value }}" 
                     class="btn btn-outline-secondary {% if filters.orden == value %}active{% endif %}" 
                     title="Ordenar por {{ label }}">
                    {% if filters.orden == value %}<i class="fas fa-check mr-1"></i>{% endif %}{{ label }}
                  </a>
                {% endfor %}
              </div>
              <!-- Dropdown compacto en pantallas pequeñas -->
              <div class="dropdown mr-2 d-inline-block d-md-none">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="dropdownOrdenMobile" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="fas fa-sort mr-1"></i>{{ orden_actual_label|default:"Orden" }}
                </button>
                <div class="dropdown-menu dropdown-menu-right p-1" aria-labelledby="dropdownOrdenMobile" style="min-width: 240px;">
                  {% for value, label in orden_toolbar %}
                    <a class="dropdown-item small {% if filters.orden == value %}active{% endif %}"
                       href="?{% for key, val in request.GET.items %}{% if key != 'orden' and key != 'page' %}{{ key }}={{ val|urlencode }}&{% endif %}{% endfor %}orden={{ value }}">
                       {% if filters.orden == value %}<i class="fas fa-check text-success mr-1"></i>{% else %}<i class="fas fa-sort mr-1 text-muted"></i>{% endif %} {{ label }}
                    </a>
                  {% endfor %}
                </div>
              </div>
              <span class="badge badge-primary mr-2" title="Total de actas en la búsqueda">
                {{ actas.paginator.count }} acta{{ actas.paginator.count|pluralize }}
              </span>
              <button class="btn btn-tool" data-card-widget="collapse" title="Colapsar / Expandir">
                <i class="fas fa-minus"></i>
              </button>
            </div>
          </div>
          <div class="card-body pt-3">
            {% if actas %}
              <div class="row" id="actas-grid">
                {% for acta in actas %}
                  <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 mb-4 d-flex">
                    <div class="card card-outline card-primary shadow-sm flex-fill acta-card h-100" style="border-radius: .5rem;">
                      <div class="position-relative">
                        {% if acta.imagen_preview %}
                          <img src="{{ acta.imagen_preview.url }}" alt="Vista previa" class="card-img-top" style="max-height:160px; object-fit:cover;">
                        {% else %}
                          <div class="d-flex align-items-center justify-content-center bg-light" style="height:160px;">
                            <i class="fas fa-file-alt fa-3x text-muted"></i>
                          </div>
                        {% endif %}
                        {# Usamos clases condicionales en lugar de inline background para evitar warnings de parser #}
                        {% with color=acta.color_estado|default:'#6c757d' %}
                        <span class="badge badge-pill position-absolute estado-badge" data-color="{{ color }}" style="top:8px; left:8px;">{{ acta.estado.get_nombre_display }}</span>
                        {% endwith %}
                        <span class="position-absolute" style="top:8px; right:10px;">
                          <i class="{{ acta.icono_acceso }} text-white" title="{{ acta.get_acceso_display }}" style="text-shadow:0 0 3px rgba(0,0,0,.6);"></i>
                        </span>
                      </div>
                      <div class="card-body d-flex flex-column pb-2">
                        <h5 class="card-title mb-1 text-truncate" title="{{ acta.titulo }}">
                          <a href="{{ acta.get_absolute_url }}" class="text-dark">{{ acta.titulo }}</a>
                        </h5>
                        <p class="small text-muted mb-2">
                          <strong>{{ acta.numero_acta }}</strong><br>
                          {{ acta.fecha_sesion|date:"d/m/Y H:i" }}<br>
                          {{ acta.tipo_sesion.get_nombre_display }}
                        </p>
                        <p class="small mb-3 flex-grow-1" style="line-height:1.3;">
                          {{ acta.resumen|default:"Sin resumen disponible"|truncatewords:28 }}
                        </p>
                        <div class="mt-auto">
                          <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">
                              <i class="fas fa-user mr-1"></i>{{ acta.presidente|default:"—" }}
                              {% if acta.transcripcion_ia %}<br><span class="text-info"><i class="fas fa-robot mr-1"></i>IA {{ acta.precision_ia }}%</span>{% endif %}
                            </small>
                          </div>
                          <div class="btn-group btn-group-sm d-flex" role="group">
                            <a href="{{ acta.get_absolute_url }}" class="btn btn-outline-primary" title="Ver detalle del acta"><i class="fas fa-eye"></i></a>
                            {% if acta.archivo_pdf %}
                              <a href="{% url 'acta_pdf_view' acta.pk %}" class="btn btn-outline-info" target="_blank" rel="noopener" title="Abrir PDF en nueva pestaña"><i class="fas fa-file-pdf"></i></a>
                              <a href="{% url 'acta_pdf_download' acta.pk %}" class="btn btn-outline-success" download title="Descargar archivo PDF"><i class="fas fa-download"></i></a>
                            {% else %}
                              <button class="btn btn-outline-secondary" disabled title="PDF no disponible"><i class="fas fa-file-pdf"></i></button>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
              {% if actas.has_other_pages %}
                <div class="pt-2">
                  <div class="row">
                    <div class="col-sm-12 col-md-5">
                      <div class="dataTables_info small">
                        Mostrando {{ actas.start_index }} a {{ actas.end_index }} de {{ actas.paginator.count }} actas
                      </div>
                    </div>
                    <div class="col-sm-12 col-md-7">
                      <ul class="pagination pagination-sm m-0 float-right">
                        {% if actas.has_previous %}
                          <li class="page-item"><a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ actas.previous_page_number }}"><i class="fas fa-angle-left"></i></a></li>
                        {% endif %}
                        {% for num in actas.paginator.page_range %}
                          {% if num == actas.number %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                          {% elif num > actas.number|add:'-3' and num < actas.number|add:'3' %}
                            <li class="page-item"><a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a></li>
                          {% endif %}
                        {% endfor %}
                        {% if actas.has_next %}
                          <li class="page-item"><a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ actas.next_page_number }}"><i class="fas fa-angle-right"></i></a></li>
                        {% endif %}
                      </ul>
                    </div>
                  </div>
                </div>
              {% endif %}
            {% else %}
              <div class="p-5 text-center text-muted">
                <i class="fas fa-search fa-3x mb-3"></i>
                <h5 class="mb-2">No se encontraron actas</h5>
                <p class="mb-3">
                  {% if search_query %}
                    No hay actas que coincidan con "{{ search_query }}".
                  {% else %}
                    No hay actas disponibles con los filtros seleccionados.
                  {% endif %}
                </p>
                <a href="{% url 'portal_ciudadano' %}" class="btn btn-outline-primary"><i class="fas fa-undo mr-1"></i>Ver todas</a>
              </div>
            {% endif %}
          </div>
        </div>
        
      </div>
    </section>
  </div>
{% endblock content %}

{% block extra_scripts %}
  <!-- Select2 -->
  <script src="{% static 'plugins/select2/js/select2.full.min.js' %}"></script>
  
  <script>
    $(function () {
      // Inicializar Select2
      $('.select2').select2({
        theme: 'bootstrap4'
      });
      
      // Búsqueda dinámica (opcional)
      let searchTimeout;
      $('#search-input').on('input', function() {
        clearTimeout(searchTimeout);
        const query = $(this).val();
        
        // Si hay más de 2 caracteres, hacer búsqueda automática
        if (query.length > 2) {
          searchTimeout = setTimeout(function() {
            // Aquí podrías implementar búsqueda AJAX en tiempo real
            console.log('Buscando:', query);
          }, 500);
        }
      });
      
      // Auto-submit cuando cambian los filtros
      $('#tipo_sesion, #estado, #acceso, #orden').change(function() {
        $('#search-form').submit();
      });
      
      // Limpiar fechas fácilmente
      $('#fecha_desde, #fecha_hasta').change(function() {
        if ($(this).val()) {
          // Auto-submit cuando se selecciona una fecha
          setTimeout(function() {
            $('#search-form').submit();
          }, 100);
        }
      });
      
        // Persistencia de estado de cards (filtros y métricas)
        const storageKey = 'portal_ciudadano_states_v1';
        let states = {};
        try { states = JSON.parse(localStorage.getItem(storageKey)) || {}; } catch(e) { states = {}; }

        function saveStates(){ localStorage.setItem(storageKey, JSON.stringify(states)); }

        function applyInitialState(cardId){
          const $card = $('#'+cardId);
          if(!$card.length) return;
          const state = states[cardId];
          if(state === 'collapsed' && !$card.hasClass('collapsed-card')){
            // trigger collapse
            $card.find('[data-card-widget="collapse"]').trigger('click');
          } else if(state === 'expanded' && $card.hasClass('collapsed-card')){
            $card.find('[data-card-widget="collapse"]').trigger('click');
          }
        }

        // Aplicar estado guardado
        applyInitialState('filters-card');
        applyInitialState('metrics-card');
        applyInitialState('resultados-card');

        // Escuchar eventos de collapse (AdminLTE emite expanded.lte.card / collapsed.lte.card)
        $('#filters-card, #metrics-card, #resultados-card').on('expanded.lte.card collapsed.lte.card', function(e){
          const id = this.id;
          if(!id) return;
          const isCollapsed = $(this).hasClass('collapsed-card');
          states[id] = isCollapsed ? 'collapsed' : 'expanded';
          saveStates();
        });
    
        // Ajustar iconos dinámicamente
        $(document).on('expanded.lte.card collapsed.lte.card', function(){
          $('[data-card-widget="collapse"]').each(function(){
            const $btn = $(this);
            const $card = $btn.closest('.card');
            const $icon = $btn.find('i.fas');
            if($card.hasClass('collapsed-card')){
              $icon.removeClass('fa-minus').addClass('fa-plus');
            } else {
              $icon.removeClass('fa-plus').addClass('fa-minus');
            }
          });
        }).trigger('expanded.lte.card');
    });
  </script>
{% endblock extra_scripts %}
