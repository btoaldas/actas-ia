{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Indicadores de Transparencia {% endblock title %}

{% block bodyclass %} hold-transition sidebar-mini {% endblock bodyclass %}

{% block content %}
<div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">
                        <i class="fas fa-tachometer-alt mr-2"></i>
                        Indicadores de Transparencia
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'dashboardv3' %}">Inicio</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'transparencia_index' %}">Transparencia</a></li>
                        <li class="breadcrumb-item active">Indicadores</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            
            <!-- Filtros -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card card-outline card-primary">
                        <div class="card-header">
                            <h3 class="card-title">Filtros</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <select class="form-control" id="categoria-filter">
                                        <option value="todas">Todas las Categorías</option>
                                        <option value="participacion">Participación Ciudadana</option>
                                        <option value="tiempo_respuesta">Tiempo de Respuesta</option>
                                        <option value="publicacion">Publicación de Información</option>
                                        <option value="cumplimiento">Cumplimiento Legal</option>
                                        <option value="accesibilidad">Accesibilidad</option>
                                        <option value="calidad">Calidad de la Información</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-control" id="periodo-filter">
                                        <option value="3">Últimos 3 meses</option>
                                        <option value="6">Últimos 6 meses</option>
                                        <option value="12" selected>Último año</option>
                                        <option value="24">Últimos 2 años</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-primary" onclick="actualizarGraficos()">
                                        <i class="fas fa-sync-alt"></i> Actualizar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gráfico Principal -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-chart-line mr-2"></i>
                                Evolución de Indicadores
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="indicadores-chart" style="height: 400px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Indicadores por Categoría -->
            {% regroup indicadores by categoria as indicadores_agrupados %}
            {% for categoria in indicadores_agrupados %}
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-layer-group mr-2"></i>
                                {{ categoria.grouper|title|default:"Sin Categoría" }}
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for indicador in categoria.list %}
                                <div class="col-md-4">
                                    <div class="info-box">
                                        <span class="info-box-icon" style="background-color: {{ indicador.color }};">
                                            <i class="{{ indicador.icono }}"></i>
                                        </span>
                                        <div class="info-box-content">
                                            <span class="info-box-text">{{ indicador.nombre }}</span>
                                            <span class="info-box-number">
                                                {% if indicador.tipo == 'porcentaje' %}
                                                    92.5%
                                                {% elif indicador.tipo == 'tiempo' %}
                                                    3.2 días
                                                {% elif indicador.tipo == 'puntuacion' %}
                                                    8.7/10
                                                {% else %}
                                                    145
                                                {% endif %}
                                            </span>
                                            <div class="progress">
                                                <div class="progress-bar" style="width: 85%; background-color: {{ indicador.color }};"></div>
                                            </div>
                                            <span class="progress-description">
                                                {{ indicador.descripcion|truncatechars:60 }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                            <h4>No hay indicadores configurados</h4>
                            <p class="text-muted">Aún no se han definido indicadores de transparencia.</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

        </div>
    </section>
</div>
{% endblock content %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
let chartIndicadores;

document.addEventListener("DOMContentLoaded", function() {
    actualizarGraficos();
});

function actualizarGraficos() {
    const categoria = document.getElementById('categoria-filter').value;
    const periodo = document.getElementById('periodo-filter').value;
    
    const url = `{% url "api_transparencia_metricas" %}?categoria=${categoria}&periodo=${periodo}`;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.series.length > 0) {
                const options = {
                    chart: {
                        type: 'line',
                        height: 400,
                        zoom: {
                            enabled: true
                        }
                    },
                    series: data.series,
                    xaxis: {
                        type: 'datetime',
                        title: {
                            text: 'Fecha'
                        }
                    },
                    yaxis: {
                        title: {
                            text: 'Valor'
                        }
                    },
                    stroke: {
                        curve: 'smooth',
                        width: 3
                    },
                    markers: {
                        size: 5
                    },
                    title: {
                        text: 'Evolución de Indicadores de Transparencia',
                        align: 'center'
                    },
                    legend: {
                        position: 'bottom'
                    },
                    grid: {
                        borderColor: '#e7e7e7',
                        strokeDashArray: 5
                    }
                };
                
                if (chartIndicadores) {
                    chartIndicadores.destroy();
                }
                
                chartIndicadores = new ApexCharts(document.querySelector("#indicadores-chart"), options);
                chartIndicadores.render();
            } else {
                document.getElementById('indicadores-chart').innerHTML = 
                    '<div class="text-center p-4"><i class="fas fa-chart-line fa-3x text-muted mb-3"></i><h5>No hay datos disponibles</h5><p class="text-muted">No se encontraron métricas para los filtros seleccionados.</p></div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('indicadores-chart').innerHTML = 
                '<div class="text-center p-4"><i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i><h5>Error al cargar datos</h5><p class="text-muted">Ocurrió un error al cargar las métricas.</p></div>';
        });
}
</script>
{% endblock extra_scripts %}
